---
title: "Market Analysis"
subtitle: "An implementation in R Markdown"
author: "JJ Allaire, Yihui Xie, Dirk Eddelbuettel"
date: "`r Sys.Date()`"
output: tint::tintHtml
bibliography: skeleton.bib
link-citations: yes
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
library(tint)
# invalidate cache when the package version changes
knitr::opts_chunk$set(tidy = FALSE, cache.extra = packageVersion('tint'))
options(htmltools.dir.version = FALSE)

```

# Currency Market Update...


In a nutshell, our frameworks and analysis (both conventional and unconventional) suggest the multi-year bull market in the US Dollar is not dead.

Capital is likely to continue to concentrate in the USA at least for the foreseeable future with global banking system and also European issues likely to create further flights into the US Dollar from time to time (our analysis suggesting that presently we could be seeing the
beginnings again of another sub-cycle of escalating risks out of the Eurozone). This will likely also cause the continued outperformance of the US Equity Market vs. the rest of the world's equity markets.

A Simple model for currencies is articulated by George Soros...

Speculative capital moves in search of the highest total return. Total Return has 3 elements:
(1) The interest rate differential, (2) The FX rate, (3) The capital appreciation in local currency.
Expectations about future exchange rates constitute the main motivation in speculative capital flow

George Soros, The Alchemy of Finance.


We can proxy some of these things (in a single chart) by looking at (a) the relative 10yr
Sovereign Bond yield spread between two currency blocs, and (b) the relative total return
share market performances between the two currency blocs. These two simple things we
find help us to see at a glance the major underlying trends indicative of capital flows and
capital market pricing trends in a manner that is relevant to the currency pair in question.
[It should be noted that a currency pair will tend to move in tandem (positive correlation) with the 10yr Bond Yield Spread unless confidence in a nations government/currency is lost, in which case the excessive inflationary conditions due to the deterioration of confidence (unhealthy increases in velocity and quantity of liquidity in one country) will see the relationship between the bond yield spread and the currency move to an inverse correlation (i.e. with a deterioration in the nation's bond market matched with a weakening of the currency).]



```{r yield_spread, fig.width= 10 , fig.height=4, cache=TRUE, echo=FALSE}

# http://www.prerequisite.com.au/wp-content/uploads/2018/04/2018-04-25-Quarterly-Client-BRIEFING.pdf

# the relative 10yr Sovereign Bond yield spread between two currency blocs


my_start_date <- "2000-01-01" %>% as.Date()
my_end_date <- today() #"2018-06-30" %>% as.Date()

my_review_date <- "2018-01-01" %>% as.Date()

# select_colors_scale <- getPalette(2)




############################################################
# First data parameters
############################################################

# http://socviz.co/refineplots.html#case-studies

my_start_date <- "2000-01-01" %>% as.Date()
my_end_date <- today() # "2018-06-30" %>% as.Date()

key_tbl <- tribble(
  ~symbol ,              ~variables,
  'USGG10YR Index',       "US 10Y", 
  # 'GECU10YR Index',  "Euro Area 10Y" ,
  'GDBR10 Index',      "Euro Area 10Y" ,
  'GUKG10 Index',       "UK 10Y",
  'GJGB10 Index' ,   "Japan 10Y" ,
  "GCAN10YR Index",   "Canada 10Y" ,
  "GACGB10 Index",    "Aus 10Y" ,
  "GCNY10YR Index",   "China 10Y" ,
  'DXY Curncy',         "US Dollar Index",
  "USTWBROA Index",     "Broad US Dollar Index" ,
  "BBDXY Index",      "Bloomberg US Dollar Index",
  "RAY Index",          "US",
  "MXWDU Index" ,       "International"
  
)


# Turn the normal mean function into a rolling mean with a 5 row window
mean_roll <- rollify( function(x) mean(x ,na.rm = TRUE), window = 21)


############################################################
# Second Raw Data
############################################################

raw_df <- bloomberg_df %>% 
  filter( symbol %in% key_tbl$symbol ) %>% 
  left_join( key_tbl , by  = c("symbol")) %>%
  select( dates, variables, values ) %>% 
  filter( between( dates ,my_start_date, my_end_date) )  %>%
  group_by( variables ) %>% 
#  mutate( values = mean_roll(values)) %>% 
  ungroup() %>% 
  spread( variables, values ) %>% 
  tidyr::fill( names(.), .direction = "down") %>% 
  gather( variables, values, - dates ) %>% 
  mutate( values = if_else( str_detect( variables, "10Y"), values/100, values))

raw_df <- raw_df %>%
  spread(variables,values) %>%
  mutate(
          Average = rowMeans(select(.,one_of(   "Euro Area 10Y",  "UK 10Y",  "Japan 10Y"  ,
                                                "Canada 10Y" , "Aus 10Y" , "China 10Y" 
                                               )) , na.rm = TRUE)
  ) %>%
  mutate( `Yield Spread` =   .[["US 10Y"]]  - .[["Average"]] ) %>% 
  gather( variables , values , - dates  ) 

# check data 




#*****************************************************************
# Plot http://drawar.github.io/posts/add-borders-annotate-outside-ggplot/
#******************************************************************

# plot
my_title <- "Global 10 Year Bond Yield Spread"
my_subtitle <- "10yr Bond Yield Spread (USA vs. Average: Euro Area, UK, Japan)"
my_y_lab <- "Percent"

df <- raw_df %>% 
  filter( between( dates , my_review_date , today())) %>% 
  filter( variables %in% c("Yield Spread", "US 10Y", "Average")) %>% 
  mutate( variables = factor( variables, levels =c("Yield Spread", "US 10Y", "Average") ))

my_xlim <-  my_axis_fun( df , dates ) %>% as.Date()
my_xlim[2] <- my_xlim[2]  %m+% months(6)
# my_xlim
# Create a vector of the last (furthest right) y-axis values for each group
txt_tbl <- df %>% 
  group_by( variables ) %>% 
  top_n(1, dates) %>% 
  ungroup() %>% 
mutate( dates = dates %m+% months(3) ,
  variables = factor( variables, levels = variables)) %>%
  mutate( colors =  my_pal("main")(length(.$variables)))

txt_tbl <- txt_tbl %>% 
  mutate( labels = str_glue( "{variables} \n  {percent( values )}"),
          labels =  paste0(variables,"\n", percent(values)))


   y
p <- ggplot()+
  geom_line( data = df, aes(x=dates,y=values, color = variables), alpha=.8, size=2) +
scale_x_date( limits = c(my_xlim[1] , my_xlim[2]) ) +
  #  scale_x_date(date_breaks = "1 year" , limits = c(my_xlim[1] , my_xlim[2]), date_labels = "%Y" ) +
  annotate("text",   x = txt_tbl$dates  , y = txt_tbl$values , 
           hjust = .5,
           
           label = txt_tbl$labels, 
           
           color = txt_tbl$colors, fontface = 'bold' ) +
  scale_y_continuous( name = my_y_lab ,label=scales::percent ) +
  scale_color_manual(  values = txt_tbl$colors %>% set_names( txt_tbl$variables) ) +
  # facet_wrap( ~variables, scale = "free_y" , ncol = 1) +
  theme_minimal() + theme_ipsum() +
  theme( plot.caption=element_text(hjust=0),
         legend.position = "none" , 
         legend.title = element_blank() ,
          axis.text.y.left = element_text(colour= my_cols("red") ),
         axis.title.y = element_text(color= my_cols("red") )) +
  labs( title= my_title, subtitle = my_subtitle) +
  # theme_Publication()
  NULL


p <- p %>%  # add reccesion shade
  my_area_func( recession_df ,  my_start_date )

pic_list$gbl_spread_p <- p

p

ggsave('output_data/img/gbl_spread_p.png') #, width = 16, height = 9, dpi =

df %>%
  drop_na( values ) %>% 
  group_by( variables ) %>%
  tq_mutate(select     = values , 
            mutate_fun = RSI, 
            n      = 14 ,  
            maType     = SMA) %>% 
  ungroup() %>% 
  mutate(# variables = "RSI" ,
          values = rsi) %>% 
  select( - rsi ) %>%
  filter( between( dates , my_review_date , today()))  %>% 
  ggplot( data = .) +
  geom_line( aes(x=dates,y=values, color = variables), alpha=1,size=1) +
  facet_wrap( ~variables, ncol = 1) +
  scale_color_manual(  values =  txt_tbl$colors %>% set_names( txt_tbl$variables)  ) +
  scale_x_date(expand = c(0,0), limits = c( my_review_date , my_xlim[2]), date_breaks = "1 year" , date_labels = "%Y" ) +
  theme_minimal() + theme_ipsum() +
  theme( plot.caption=element_text(hjust=0),
         legend.position = "none",
         axis.text.y.left = element_text(colour= my_cols("red")),
         axis.title.y = element_text(color= my_cols("red"))) +
  labs( y = "RSI") +
  # theme_Publication()
  NULL






```





[tint](http://github.com/eddelbuettel/tint) is straightforward mix of the (html and pdf
parts of the) excellent [tufte](https://github.com/rstudio/tufte) package by JJ and Yihui,
mixed with the [Roboto Condensed](https://fonts.google.com/specimen/Roboto+Condensed) font
use and color scheme proposed by [envisioned css](http://nogginfuel.com/envisioned-css/)
plus minor style changes such as removal of _italics_---but otherwise true to the
wonderful [tufte](https://github.com/rstudio/tufte) package for R---all baked together
into a small package providing another template.


# Currency Market Review


- Trade-Weighted US Dollar, DXY, ADXY, and Liquidity Dynamics

```{r Review US Dollar and Liquidity Dynamics, fig.width = 10, fig.height = 2, fig.fullwidth = TRUE, fig.cap = "Review US Dollar and Liquidity Dynamics",echo=FALSE, warning=FALSE, cache=TRUE}


#*****************************************************************
# US Dollar, US 10 Year Rates, Libor-OIS
#******************************************************************
 
############################################################
# plot Global 10 Year Bond Yield Spread
############################################################

# plot
my_review_date <- "2018-01-01" %>% as.Date()

my_title <- "Global Capital Flow - Demand for US Dollar"
my_subtitle <- ""
my_caption <- "Source: Bloomberg\nNote: Asia Dollar Index is inverted to be aligned with Dollar Index.\nAll indices used a base value of 100 at the start of 2000."
my_y_lab <- "Cumulative Performance"

df <- raw_df %>% 
  filter( variables %in% c("Broad US Dollar Index",  "Bloomberg US Dollar Index", "US Dollar Index")) %>% 
  filter( between( dates, my_review_date , today())) %>% 
  group_by( variables ) %>% 
  tq_transmute( select = values ,
                mutate_fun = dailyReturn,
                type = "arithmetic",
                col_rename = "values") %>% 
  filter( !is.na(values)) %>% 
  mutate( values = cumprod( 1 + values) -1) %>% 
  ungroup()

my_xlim <-  my_axis_fun( df , dates ) %>% as.Date()
my_xlim[2] <- my_xlim[2]  %m+% months(6)
# my_xlim
# Create a vector of the last (furthest right) y-axis values for each group
txt_tbl <- df %>% 
  group_by( variables ) %>% 
  top_n(1, dates) %>% 
  ungroup() %>% 
  mutate( dates = dates %m+% months(3) ,
          variables = factor( variables, levels = variables)) %>%
  mutate( colors =  my_pal("main")(length(.$variables)))


txt_tbl <- txt_tbl %>% 
  mutate( labels = str_glue( "{variables} \n  {percent( values )}"))

p <- ggplot()+
  geom_line( data = df, aes(x=dates,y=values, color = variables), alpha=.8, size=2) +
  scale_x_date(date_breaks = "1 year" , limits = c(my_xlim[1] , my_xlim[2]), date_labels = "%Y" ) +
  annotate("text",   x = txt_tbl$dates , y = txt_tbl$values , hjust = .5, vjust = -.0,
           label = txt_tbl$labels,    color = txt_tbl$colors, fontface = 'bold' ) +
  scale_y_continuous( name = my_y_lab ,label=scales::percent ) +
  scale_color_manual(  values = txt_tbl$colors %>% set_names( txt_tbl$variables) ) +
  
  #  facet_wrap( ~variables, scale = "free_y" ) +
  theme_minimal() + theme_ipsum() +
  theme( plot.caption=element_text(hjust=0),
         legend.position = "none" , 
         legend.title = element_blank() ,
         axis.text.y.left = element_text(colour= my_cols("red") ),
         axis.title.y = element_text(color= my_cols("red") )) +
  labs( title= my_title, subtitle = my_subtitle) +
  # theme_Publication()
  NULL

p <- p %>%  # add reccesion shade
  my_area_func( recession_df ,  my_start_date )

pic_list$usd_flow_p <- p

p
ggsave('output_data/img/usd_flow_p.png') #, width = 16, height = 9, dpi =






```
 



## US vs. International


```{r US-International Rotation, echo=FALSE, warning=FALSE, cache=TRUE }


my_start_date <- "2000-01-01" %>% as.Date()
my_end_date <- today() # "2018-06-30" %>% as.Date()
my_review_date <- "2018-01-01" %>% as.Date()
# select_colors_scale <- getPalette(2)



############################################################
# First Data
############################################################


# Russell 3000 Index  #MSCI ACWI Excluding United States Index

my_vars  <- c("US" , "International", "US Dollar Index", "Broad US Dollar Index")

df <- raw_df %>%
  filter( variables %in% my_vars ) %>% 
  filter( between( dates ,my_start_date, my_end_date) )  %>%
  group_by(variables) %>%
  tq_transmute( select = values ,
                mutate_fun = dailyReturn,
                type = "arithmetic",
                col_rename = "values") %>% 
  filter( !is.na(values)) %>% 
  spread( variables ,values ) %>%
  mutate( `US vs. International` = .[["US"]]  - .[["International"]] ) %>%
  # mutate_if( is.double, funs(scale)) %>% 
  
  gather(variables, values, -dates) %>%
  group_by(variables) %>%
  arrange(dates) %>%
  na.omit() %>% 
  mutate( values = 1*cumprod(1+values)) %>%
  ungroup() %>% 
  # spread( variables ,values ) %>% tail()
  filter( !variables %in% c("US","International"))


my_xlim <-  my_axis_fun( df , dates ) %>% as.Date()
my_xlim[2] <- my_xlim[2] %m+% months(12)
my_xlim

#*****************************************************************
# Plot http://drawar.github.io/posts/add-borders-annotate-outside-ggplot/
#******************************************************************

my_title <- "Global Capital Flow"
my_caption <- "Source: Bloomberg\nNote: The relative cumulative performances of \"US vs. International\" are represented by Russell 3000 and\nMSCI ACWI-ex US Indicies using a base value of 100 at the start of 2000."
my_y_lab <- "Cumulative Performance"
my_2nd_y_lab <- ""

txt_tbl <- df %>% 
    filter(  between( dates, my_review_date, my_end_date)) %>% 
  group_by( variables ) %>% 
  top_n(1, dates) %>% 
  ungroup() %>% 
    mutate( dates = dates %m+% months(2) ,
          variables = factor( variables, levels = variables)) %>%
  mutate( colors =  my_pal("main")(length(.$variables)))

txt_tbl <- txt_tbl %>% 
  mutate( labels = str_glue( "{variables} \n  {percent( values )}"))

p <- ggplot()+
  geom_line( data =  filter(  df ,between( dates, my_review_date, my_end_date))  , aes(x=dates,y=values, color = variables), alpha=.8, size=2) +
  scale_x_date(date_breaks = "1 year" , limits = c(my_review_date , my_xlim[2]), date_labels = "%Y" ) +
  annotate("text",   x = txt_tbl$dates , y = txt_tbl$values , hjust = .5, vjust = -.0,
           label = txt_tbl$labels,    color = txt_tbl$colors, fontface = 'bold' ) +
  scale_y_continuous( name = my_y_lab ,label=scales::percent ) +
  scale_color_manual(  values = txt_tbl$colors %>% set_names( txt_tbl$variables) ) +
  
  #  facet_wrap( ~variables, scale = "free_y" ) +
  theme_minimal() + theme_ipsum() +
  theme( plot.caption=element_text(hjust=0),
         legend.position = "none" , 
         legend.title = element_blank() ,
         axis.text.y.left = element_text(colour= my_cols("red") ),
         axis.title.y = element_text(color= my_cols("red") )) +
  labs( title= my_title, subtitle = my_subtitle) +
  # theme_Publication()
  NULL



p <- p %>%  # add reccesion shade
  my_area_func( recession_df ,  my_start_date )


pic_list$cap_flow_p <- p

p
ggsave('output_data/img/cap_flow_p.png') #, width = 16, height = 9, dpi =

# pic_list$gbl_spread_p + pic_list$cap_flow_p +  plot_layout(ncol = 1)



```




```{r US-International YOY Rel, echo=FALSE, warning=FALSE, cache=TRUE}




df <- df %>%
  tibbletime::as_tbl_time( index = dates ) %>% 
  group_by( variables ) %>% 
  tibbletime::as_period( period = "monthly" , side = "end", include_endpoints = TRUE) %>%
  ungroup() %>% 
  mutate( monthf = month(dates)) %>% 
  group_by( variables, monthf ) %>% 
  arrange(dates) %>% 
  mutate( values = (values - dplyr::lag(values,1))/dplyr::lag(values,1)) %>% 
  ungroup() %>% 
  drop_na( values )

## Include periods for sub analysis
df <- df %>% 
  mutate( periods = 
            case_when (  dates >= as.Date("2008-01-01") &   dates <  as.Date("2009-01-01")   ~ "GFC" ,
                         dates >= as.Date("2018-01-01") &   dates <  as.Date("2018-04-01")  ~ "2018 Q1" ,
                         dates >= as.Date("2018-04-01") ~ "2018 Q2" ,
                         TRUE ~  "Rest Period"
            )
  ) # %>%
 # filter( !periods %in% "NA") %>% 
#  bind_rows(
 #   df %>% 
#      mutate( periods = "Entire Period"
#      )
#  )



my_dep_var <- "US vs. International"

my_title <- str_glue( "Correlation against {my_dep_var} data")

my_subtitle <- str_glue("Correlation data period: {min(df$dates)} - {max(df$dates,1)}" )

my_dep_var <- c("US vs. International")

df %>% 
  group_by( periods) %>% 
  nest() %>% 
  mutate( corr = map( data,
                      ~ {
                        .x %>%  select( dates , variables, values  ) %>%
                          spread( variables, values) %>%
                          select( - dates ) %>% 
                          corrr::correlate() %>%    
                          corrr::focus( quo_name(my_dep_var) ) %>% 
                          select( rowname , quo_name(my_dep_var) ) %>% 
                          set_names( c("variables", "values")) %>% 
                          drop_na( values ) 
                      }
                      
  )) %>% 
  unnest(  corr ) %>% 
  # --ggplot here--
  ggplot(aes(x= variables, y= values)) +
  geom_bar( aes( x = reorder( variables, values), y = values, fill = variables ) ,stat= "identity", width=.8)+
  scale_y_percent( limits = c(0, 1)) +
  geom_text(aes(label=  scales::percent(values),
                hjust = ifelse(values > 0, -.15, 1.1)),
            color= "black" ) +
  
  coord_flip() +
  facet_wrap( ~ periods) +
  scale_fill_mycol( palette = "main" , discrete = TRUE ) +
  labs(x="",y="",
       subtitle = my_subtitle,
       title= my_title ,
       caption= my_caption)+
  theme_minimal() + theme_ipsum() +
  theme(legend.position = "none"    )

 


txt_tbl <- df %>% 
  group_by( variables ) %>% 
  top_n(1, dates) %>%
  ungroup() %>% 
  distinct(dates, variables, values ) %>% 
  mutate( dates = dates %m+% months(2) ,
          variables = forcats::as_factor( variables, levels = variables ) ) %>%
  mutate( colors =  my_pal("main")(length(.$variables)))

txt_tbl <- txt_tbl %>% 
  mutate( labels = str_glue( "{variables} \n  {percent( values )}"))

my_title <- str_glue( "Year over Year Returns")
my_subtitle <- str_glue("Data period: {min(df$dates)} - {max(df$dates,1)}" )


p <- df %>% 
  ggplot() +
  geom_line( aes( x = dates, y = values, color = variables), size = 1.2) +
  scale_color_manual(  values = txt_tbl$colors %>% set_names( txt_tbl$variables) ) +
  annotate("text",   x = txt_tbl$dates , y = txt_tbl$values , hjust = .5, vjust = -.0,
           label = txt_tbl$labels,    color = txt_tbl$colors, fontface = 'bold' ) +
  scale_x_date( date_breaks = "2 year" ,date_labels = "%Y" ) +
  scale_y_continuous( name = my_y_lab ,label=scales::percent ) +
  theme_ipsum() +
  theme(legend.position= "none" ) +
  labs( title= my_title ,
        subtitle = my_subtitle,
        caption= my_caption ) +
  
  NULL 

p %>%  # add reccesion shade
  my_area_func( recession_df ,  my_start_date )


my_indep_var <- c("Broad US Dollar Index", "US Dollar Index")

p <- df %>% 
  select( dates , variables, values ,periods ) %>%
  filter( variables %in% c(my_indep_var, my_dep_var )) %>% 
  spread( variables, values) %>%
  gather( variables, values , - dates, - (my_dep_var),  -periods) %>% 
  ggplot( mapping = aes( y = !!sym(my_dep_var)  , x =  values, color = periods ) ) 

p + geom_point( alpha = 0.9 ) + #  aes( color = periods  ) ,
  geom_smooth(method = "lm" , se = FALSE, color = "gray80") +
  facet_wrap( ~variables ) +
   scale_color_manual(  values =  c("grey", "#A3BE8C", "#306489", "#AF1900" ) %>% 
                          set_names( c( "Rest Period", "2018 Q1", "2018 Q2" ,"GFC"  ) )  ) +
  # scale_color_mycol(palette = "main") +
  scale_y_percent( ) +
  scale_x_percent( ) +
  theme_minimal() + theme_ipsum() +
  theme( legend.position = "top") +
  labs( title = my_title ,
        subtitle =  my_subtitle ,
        color = "Period: ",
        caption= my_caption  ) +
  NULL


```


# Defining Liquidity

Liquidity consists of all cash and credit available to financial markets, once the immediate transactions needs of the real economy have been fulfilled

It is a sources and not a uses of funds definition. Money supply, a rival concept, is a uses of funds measure because it comprises bank deposits. Banks are no longer the dominant conduit for liquidity, and credit is a more powerful guide to purchasing power than deposit money.

Moreover, liquidity cannot be measured by interest rates, as the 2007/08 financial crisis has shown. For example, low base interest rates and tight liquidity mean wide spreads and a high effective cost of funds.

Liquidity transmits its influence to the real economy and financial markets through duration. Duration is a hybrid between liquidity preference and time preference, i.e. it measures the effect of liquidity over time. Investors and businesses target a desired duration and change their asset mix to attain these targets. Liquidity hastens and smooths this adjustment; illiquidity forces it to become abrupt and often disruptive. Changes in duration affect the composition of the capital structure and the mix of investments. Modern business cycles have become more cycles of duration than growth^[See Liquidity definition [defining liquidity](http://www.liquidity.com/definingliquidity.aspx)].

# Introduction
 
Recently, [Bloomberg article](http://www.bloomberg.com/news/articles/2016-08-08/there-s-a-big-dollar-crunch-brewing-in-markets) discussed shortage of US Dollar in the global financial markets. [**Zero Hedge**](http://www.zerohedge.com/news/2015-10-03/global-dollar-funding-shortage-intesifies-worst-level-2012) has discussed on tihs topic for a while. This topic was also one of the main concerns that BIS focused on lately^[See BIS report [Prociclity]()].

Pressure in the US Dollar funding market has received much attention lately, as the spread between
USD Libor and Treasury rate has gone up to 5 year high.

Bloomberg discussed shortage of US Dollar in the global financial markets and contributed its reason 
to money market regulation that will be in effect coming November^[See Bloomberg report 
[there-s-a-big-dollar-crunch-brewing-in-markets](http://www.bloomberg.com/news/articles/2016-08-08/there-s-
a-big-dollar-crunch-brewing-in-markets)]. 
Please read the [Oppenheimer's research](https://www.oppenheimerfunds.com/investors/article/the-libor-story-wont-go-away-anytime-soon)
for more detail.
                                                                                                                                                
According to [**Zero Hedge**](http://www.zerohedge.com/news/2015-10-03/global-dollar-funding-shortage-intesifies-worst-level-2012) has discussed on tihs topic for a while.
http://www.zerohedge.com/news/2016-08-11/libor-blows-out-fresh-6-year-highs-28-trillion-debt-question-emerges
                                                                                                                                                 
The following analysis was done in the framework of BIS research^[Global liquidity and procyclicality](http://www.bis.org/speeches/sp160608.pdf)] and relies on NY Federal Reserve research.



```{r TED-spread, fig.margin = TRUE, fig.width=3.5, fig.height=3.5, cache=TRUE,echo=FALSE}




#*****************************************************************
# set paramters
#******************************************************************

my_start_date <- "2000-01-01" %>% as.Date() # today() - years(3)
my_end_date <- today() #"2018-06-30" %>% as.Date()

my_review_date <- "2018-01-01" %>% as.Date()


select_symbols <-  c( "EUBS1 CMPN Curncy",# USD EUR 1 Year Cross Currency
                      "BASPTDSP Index" ) # TED spread


select_symbols_names <- c( "USD EUR 1 Year Cross Currency",
                           "TED spread")



key_tbl <- tibble( symbol = select_symbols, variables = select_symbols_names )

df <- bloomberg_df %>% 
  filter( symbol %in% key_tbl$symbol ) %>% 
  left_join( key_tbl , by  = c("symbol")) %>%
  select( dates, variables, values ) %>% 
  filter( between( dates ,my_review_date, my_end_date) ) %>% 
  mutate( values = values/100 ,
          values = if_else( variables %in%  "USD EUR 1 Year Cross Currency" , -values, values))


df %>% group_by( variables) %>% skimr::skim()


#*****************************************************************
# Plot http://drawar.github.io/posts/add-borders-annotate-outside-ggplot/
#******************************************************************

 
my_xlim <-  my_axis_fun( df , dates ) %>% as.Date()
my_xlim[2] <- my_xlim[2]  %m+% months(6)

# Create a vector of the last (furthest right) y-axis values for each group
txt_tbl <- df %>% 
  group_by( variables ) %>% 
  top_n(1, dates) %>% 
  ungroup() %>% 
  mutate( dates = dates %m+% months(3) ,
          variables = factor( variables, levels = variables)) %>%
  mutate( colors =  my_pal("main")(length(.$variables)))

txt_tbl <- txt_tbl %>% 
  mutate( labels = str_glue( "{variables} \n  {percent( values )}"))

#*****************************************************************
# Plot http://drawar.github.io/posts/add-borders-annotate-outside-ggplot/
#******************************************************************

my_title <- "Liquidity Condition In the Global Financial Markets"
my_subtitle <- ""
my_caption <- "Source: BIS\nNote: Cross Currency Swap is inverted to be aligned with TED Spread."
my_y_lab <- "Percent"

p <-  ggplot()+
  geom_line( data = df, aes(x=dates,y=values, color = variables), alpha=.8, size=2) +
 # scale_x_date(date_breaks = "1 month" , limits = c(my_xlim[1] , my_xlim[2]) ) + # , date_labels = "%Y"
  facet_wrap( ~variables, scale = "free_y" , ncol = 1) +
  # annotate("text",   x = txt_tbl$dates , y = txt_tbl$values , hjust = .5, vjust = -.0,
  #         label = txt_tbl$labels,    color = txt_tbl$colors, fontface = 'bold' ) +
  scale_y_continuous( name = my_y_lab ,label=scales::percent ) +
  scale_color_manual(  values = txt_tbl$colors %>% set_names( txt_tbl$variables) ) +
  theme_minimal() + theme_ipsum() +
  theme( plot.caption=element_text(hjust=0),
         legend.position = "none" , 
         legend.title = element_blank() ,
         axis.text.y.left = element_text(colour= my_cols("red") ),
         axis.title.y = element_text(color= my_cols("red") )) +
  labs( title= my_title, subtitle = my_subtitle) +
  # theme_Publication()
  NULL



p <- p %>%  # add reccesion shade
  my_area_func( recession_df ,  my_review_date )

p


pic_list$liquidity_p <- p

ggsave('output_data/img/liquidity_p.png') #, width = 16, height = 9, dpi =

    
                                                                                                                                                     
```

# US Treasuries:

Essentially a sustained reflationary dynamic is unlikely without the participation of the
banks, especially in light of still problematic liquidity conditions in the world. Our previous
Quarterly Letter touches upon some of these issues should you be interested (more
comprehensive analyses of these issues are within our PCS Reports, complementary to our
Portfolio Clients (minimum account balances apply) or available via subscription).


Key Takeaway:

The majority of liquidity creation occurs
within the Commercial & Shadow Banking Systems of the
world, even despite the efforts of Central banks over the
last 10 years, global banks and the financial system
continues to flounder. The recent rise in bond yields is
likely to prove transitory yet again in the same way that
similar occurrences have over the last 15 years, nothing
has really been resolved in the broader financial system, if
anything the strains appear to be slowly escalating again.



## US Inflation Outlook

Headline CPI inflation accelerated to 2.1% year-over-year in December from 1.7% in November, close to the 2.2% year-over-year core inflation rate due to the rise in shelter cost and recovery in crude oil prices.
Tightening labor market condition has supported service inflation at a 3% annualized rate.  With energy moving higher and rents and medical costs continuing to firm up, price pressures are gaining traction, strengthening the case for the Fed to keep raising interest rates this year.
However, the Fed's preferred gauge of inflation, the core PCE index, which excludes the volatile food and energy components, came in at 1.7 per cent and hasn't met the goal of Fed's 2 percent goal yet, a case for Fed's more dovish stance. See the US Inflation Outlook chart.





```{r Inflation Outlook chart,  warning=FALSE, cache=TRUE, echo=FALSE}



############################################################

# Extract CPI Data

############################################################



my_start_date <- "2000-01-01" %>% as.Date()
my_end_date <- today() # "2018-06-30" %>% as.Date()

# Monetary_Symbols_Names

# select interested variables

# select_symbols <- c("CPIAUCSL" ,"CPILFESL" ,"PCEPILFE") #

select_symbols <- c( 'CPI YOY Index','CPI XYOY Index',"PCE CYOY Index")
select_names <- c("Headline CPI","Core CPI", "Core PCE") #



key_tbl <- tibble(
  symbol =  select_symbols, #c("CPIAUCSL" ,"CPILFESL" ,"PCEPILFE") ,
  variables =  factor( select_names  ,levels = select_names)
) %>% 
     mutate( colors =  my_pal("main")(length(.$variables)))






df <- bloomberg_df %>%
  filter( symbol %in% key_tbl$symbol ) %>%
  left_join( key_tbl, by ="symbol") %>%
  filter( between( dates ,my_start_date, my_end_date) )  %>%
  select( dates , variables , values) %>% 
  #  mutate(variables = as.factor(variables),
  #         year = as.factor(year(dates)),
  #         month =as.factor(month(dates))) %>%  #
  #  group_by(variables,month) %>%
  #  arrange(dates) %>%
  # compute annual growth rate
  #mutate(ann_g = (values-lag(values,1))/lag(values,1)) %>%
  mutate(values=  values /100) %>%
  #  ungroup() %>%
  filter(dates >= "2010-01-01")


df %>% distinct( variables)


# set x-axis limits
my_xlim <-  my_axis_fun( df , dates ) %>% as.Date()
my_xlim[2] <- my_xlim[2] + months(12)

my_xlim


txt_tbl <- df %>% 
  group_by( variables ) %>% 
  top_n(1, dates) %>% 
  ungroup() %>% 
  mutate( dates = dates %m+% months(4) ,
          variables = factor( variables, levels = variables)) %>%
  mutate( colors =  my_pal("main")(length(.$variables)))

txt_tbl <- txt_tbl %>% 
  mutate( labels = str_glue( "{variables} \n  {percent( values )}"),
          labels =  paste0(variables,"\n", percent(values)))



# https://www.ft.com/content/7d97f1b2-e492-11e6-8405-9e5580d6e5fb
my_title <- "US Inflation Outlook"
my_subtitle <- str_glue("Whie inflation has strengthened until {format( today(),'%B %d, %Y') }, it seems inflation expectation has over stretched.'/n'what if it retraces?")
my_caption <- "Source: U.S. Bureau of Economic Analysis"
my_y_lab <- "Percent"

p <- df %>%
  
  ggplot(aes(x=dates,y= values, color= variables )) +
  
  geom_line(alpha=1,size=1.1) +
  geom_hline(yintercept = .02,linetype = "dashed") +
  annotate("text",   x = txt_tbl$dates  , y = txt_tbl$values , hjust = .5, vjust = -.0,
           label = txt_tbl$labels ,    color = txt_tbl$colors, fontface = 'bold' ) +
  scale_y_continuous( name = my_y_lab ,label=scales::percent ) +
  scale_color_manual(  values = txt_tbl$colors %>% set_names( txt_tbl$variables) ) +
  scale_x_date(limits = my_xlim, date_breaks = "1 year" , date_labels = "%Y" ) +
 labs( title= my_title, 
      subtitle = my_subtitle ,
      x="",y= my_y_lab,
      caption= my_caption  ) +
  
  # theme_Publication() +
  theme_minimal() + theme_ipsum() +
  theme(plot.caption=element_text(hjust=0) ,
         legend.position = "none" )  +
 theme(
  
  panel.grid.major = element_line(colour = "grey92"),
  
  panel.grid.minor = element_line(colour = "grey92",
                                  
                                  size = 0.25),
  
  axis.line = element_line(colour="black")
  
)
p


pic_list$cpi_p <- p



ggsave('output_data/img/cpi_p.png') #, width = 16, height = 9, dpi =





```




```{r Oil and Inflation chart,  warning=FALSE, cache=TRUE, echo=FALSE}



############################################################

# Extract CPI Data

############################################################


############################################################
# First data parameters
############################################################


# http://socviz.co/refineplots.html#case-studies

my_start_date <- "2000-01-01" %>% as.Date()
my_end_date <- today() # "2018-06-30" %>% as.Date()
my_review_date <- "2015-01-01" %>% as.Date()


select_symbols <- c( 'CPI YOY Index','CPI XYOY Index',"PCE CYOY Index", "CL1 Comdty")
select_names <- c("Headline CPI","Core CPI", "Core PCE", "Oil") #

my_dep_var <- c("Oil")
my_indep_var <- c("Headline CPI","Core CPI", "Core PCE" )


key_tbl <- tibble(
  symbol =  select_symbols, #c("CPIAUCSL" ,"CPILFESL" ,"PCEPILFE") ,
  variables =  factor( select_names  ,levels = select_names)
) %>% 
  left_join(
    
    c( my_pal("main")(length( my_indep_var )), "#000000" ) %>% 
      set_names( select_names) %>% 
      as.data.frame() %>%
      rownames_to_column() %>% 
      set_names( c("variables" , "colors")) ,
    by = "variables"
    
  ) %>% mutate( colors =  as.character(colors ))

# process oil data
# creat year over year data
df <- bloomberg_df %>% 
  filter( symbol %in% c(key_tbl %>% filter( variables %in% !!my_indep_var ) %>% pull(symbol) )
  ) %>%
  left_join( key_tbl , by  = c("symbol")) %>%
  select( dates, variables, values ) %>% 
  mutate( values = values/100 ) %>% 
  filter( between( dates ,my_start_date, my_end_date) ) %>% 
  bind_rows(
    
    bloomberg_df %>%
      semi_join( key_tbl %>% filter( variables %in% !!my_dep_var ) ,
                 by = "symbol") %>%
      left_join( key_tbl %>% filter( variables %in% !!my_dep_var ) ,
                 by = "symbol") %>% 
      tibbletime::as_tbl_time( index = dates ) %>% 
      tibbletime::as_period( period = "monthly" , side = "end", include_endpoints = TRUE ) %>%
      mutate( monthf = month(dates)) %>% 
      group_by( variables, monthf ) %>% 
      drop_na( values ) %>% 
      arrange(dates) %>% 
      mutate( values =  (values - dplyr::lag(values,1))/dplyr::lag(values,1) ) %>% 
      ungroup() %>% 
      filter( between( dates ,my_start_date , my_end_date) )  %>%
      select( dates , variables , values) 
    
    
    
  ) %>% print()


  
df <- df %>%
  spread( variables, values ) %>% 
  tidyr::fill( names(.), .direction = "down") %>% 
  na.omit() %>% 
  gather( variables, values, - dates ) 

# df %>%  distinct(  variables )

df %>% group_by( variables ) %>% skimr::skim()

## Include periods for sub analysis
df <- df %>% 
  mutate( periods = 
            case_when (  dates >= as.Date("2014-01-01") &   dates <  as.Date("2016-03-01")   ~ "Oil Shock" ,
                         dates >= as.Date("2016-03-01") &   dates <  as.Date( "2018-01-01" )  ~ "Reflationary Period" ,
                         dates >= as.Date("2018-01-01") ~ "2018 Q2" ,
                         TRUE ~  "Other Period"
            )
  )  %>%
  mutate( periods = forcats::as_factor( periods, levels = c("Other Period", "Oil Shock", "Reflationary Period" , "2018 Q2")))
# filter( !periods %in% "NA") %>% 
#  bind_rows(

df <- df %>% 
  group_by( variables ) %>% 
  mutate( values = scale( values)/100 ) %>% 
  ungroup()

txt_tbl <- df %>% 
  group_by( variables ) %>% 
  top_n(1, dates) %>%
  ungroup() %>% 
  distinct(dates, variables, values ) %>% 
  mutate( dates = dates %m+% months(6) ,
          variables = forcats::as_factor( variables, levels = variables ) ) %>%
  left_join( key_tbl %>% select( variables, colors),
            by = "variables")

txt_tbl <- txt_tbl %>% 
  mutate( labels = str_glue( "{variables} \n  {percent( values )}"))

my_title <- str_glue( "Standardized Year over Year Returns")
my_subtitle <- str_glue("Data period: {min(df$dates)} - {max(df$dates,1)}" )
my_y_lab  <- "Percent"

df %>% 
  ggplot() +
  geom_line( aes( x = dates, y = values, color = variables), size = 1.2) +
  scale_color_manual(  values = txt_tbl$colors %>% set_names( txt_tbl$variables) ) +
  annotate("text",   x = txt_tbl$dates , y = txt_tbl$values , hjust = .5, vjust = -.0,
           label = txt_tbl$labels,    color = txt_tbl$colors, fontface = 'bold' ) +
  scale_x_date( date_breaks = "2 year" ,date_labels = "%Y" ) +
  scale_y_continuous( name = my_y_lab , labels = scales::percent ) +
  theme_ipsum() +
  theme(legend.position= "none" ) +
  labs( title= my_title ,
        subtitle = my_subtitle,
        caption= my_caption ) +
  
  NULL

```


```{r Oil and Inflation Corr chart,  warning=FALSE, cache=TRUE, echo=FALSE}




my_title <- str_glue( "Correlation against {my_dep_var} data")
my_subtitle <- str_glue("Correlation data period: {min(df$dates)} - {max(df$dates,1)}" )
my_caption <- ""



df %>% 
  group_by( periods) %>% 
  nest() %>% 
  mutate( corr = map( data,
                      ~ {
                        .x %>%  
                          select( dates , variables, values  ) %>%
                          drop_na( values ) %>% 
                          spread( variables, values) %>%
                          select( - dates ) %>% 
                          corrr::correlate() %>%    
                          corrr::focus( quo_name(my_dep_var) ) %>% 
                          select( rowname , quo_name(my_dep_var) ) %>% 
                          set_names( c("variables", "values")) %>% 
                          drop_na( values ) 
                      }
                      
  )) %>%
  
  unnest(  corr ) %>% 
  # --ggplot here--
  ggplot(aes(x= variables, y= values)) +
  geom_bar( aes( x = forcats::fct_relevel( variables,  rev(my_indep_var)), y = values, fill = variables ) ,stat= "identity", width=.8)+
  scale_y_percent( limits = c(-0.2, 1)) +
  geom_text(aes(label=  scales::percent(values),
                hjust = ifelse(values > 0, -.15, 1.1)),
            color= "black" ) +
  
  coord_flip() +
  facet_wrap( ~ periods) +
  scale_fill_mycol( palette = "main" , discrete = TRUE ) +
  labs(x="",y="",
       subtitle = my_subtitle,
       title= my_title ,
       caption= my_caption)+
  theme_minimal() + theme_ipsum() +
  theme(legend.position = "none"    )







```



```{r Oil and Inflation Year over Year chart,  warning=FALSE, cache=TRUE, echo=FALSE}


############################################################
# First data parameters
############################################################

my_review_date <- "2014-01-01" %>% as.Date()

df <- df %>% 
  group_by( variables ) %>% 
  mutate( values = scale( values)/100) %>% 
  ungroup()


txt_tbl <- df %>% 
  group_by( variables ) %>% 
  top_n(1, dates) %>%
  ungroup() %>% 
  distinct(dates, variables, values ) %>% 
  mutate( dates = dates %m+% months(6) ,
          variables = forcats::as_factor( variables, levels = variables ) ) %>%
  mutate( colors =  my_pal("main")(length(.$variables))) %>% 
  mutate( colors = if_else( variables == "Oil", "black", colors))

txt_tbl <- txt_tbl %>% 
  mutate( labels = str_glue( "{variables} \n  {percent( values )}"))

my_title <- str_glue( "Year over Year Returns")
my_subtitle <- str_glue("Data period: {min(df$dates)} - {max(df$dates,1)}" )
my_y_lab  <- "Percent"

df %>% 
  filter( dates >= my_review_date) %>% 
  ggplot() +
  geom_line( aes( x = dates, y = values, color = variables), size = 1.2) +
  scale_color_manual(  values = txt_tbl$colors %>% set_names( txt_tbl$variables) ) +
  annotate("text",   x = txt_tbl$dates , y = txt_tbl$values , hjust = .5, vjust = -.0,
           label = txt_tbl$labels,    color = txt_tbl$colors, fontface = 'bold' ) +
  scale_x_date( date_breaks = "2 year" ,date_labels = "%Y" ) +
  scale_y_continuous( name = my_y_lab ,label=scales::percent ) +
  theme_ipsum() +
  theme(legend.position= "none" ) +
  labs( title= my_title ,
        subtitle = my_subtitle,
        caption= my_caption ) +
  
  NULL



```


```{r  Oil and Inflation Scatter chart,  warning=FALSE, cache=TRUE, echo=FALSE}





p <- df %>% 
  select( dates , variables, values ,periods ) %>%
  filter( variables %in% c(my_indep_var, my_dep_var )) %>% 
  spread( variables, values) %>%
  gather( variables, values , - dates, - (my_dep_var),  -periods) %>% 
  ggplot( mapping = aes( y = !!sym(my_dep_var)  , x =  values, color = periods ) ) 

p + geom_point( alpha = 0.9 ) + #  aes( color = periods  ) ,
  geom_smooth(method = "lm" , se = FALSE, color = "gray80") +
  facet_wrap( ~variables ) +
  scale_color_manual(  values =  c("grey", "#A3BE8C", "#306489", "#AF1900" ) %>% 
                         set_names( df %>% distinct( periods ) %>% pull() )  ) +
  # scale_color_mycol(palette = "main") +
  scale_y_percent( ) +
  scale_x_percent( ) +
  theme_minimal() + theme_ipsum() +
  theme( legend.position = "top") +
  labs( title = my_title ,
        subtitle =  my_subtitle ,
        color = "Period: ",
        caption= my_caption  ) +
  NULL





```




```{r Oil and Inflation Expectation chart,  warning=FALSE, cache=TRUE, echo=FALSE}




# http://socviz.co/refineplots.html#case-studies

my_start_date <- "2000-01-01" %>% as.Date()
my_end_date <- today() # "2018-06-30" %>% as.Date()
my_review_date <- "2015-01-01" %>% as.Date()


############################################################

# Extract CPI Data

############################################################
 


select_symbols <- c( "CL1 Comdty" , 'USGGBE10 Index' ,'USGG5Y5Y Index')

select_names <-  c( "Oil",
                    "10 Year Breakeven Inflation Rate",
                    "5/5 Year Forward Breakeven Inflation Rate") 


my_dep_var <- c("Oil")
my_indep_var <- c(  "10 Year Breakeven Inflation Rate",
                    "5/5 Year Forward Breakeven Inflation Rate" )


key_tbl <- tibble(
  symbol =  select_symbols, #c("CPIAUCSL" ,"CPILFESL" ,"PCEPILFE") ,
  variables =  factor( select_names  ,levels = select_names)
) %>% 
  left_join(
    
    c( my_pal("main")(length( my_indep_var )), "#000000" ) %>% 
      set_names( select_names) %>% 
      as.data.frame() %>%
      rownames_to_column() %>% 
      set_names( c("variables" , "colors")) ,
    by = "variables"
    
  )    %>% mutate( colors =  as.character(colors ))


key_tbl
# process oil data
# creat year over year data
df <- bloomberg_df %>% 
  filter( symbol %in% c(key_tbl %>% filter( variables %in% !!my_indep_var ) %>% pull(symbol) )
  ) %>%
  left_join( key_tbl , by  = c("symbol")) %>%
  select( dates, variables, values ) %>% 
  mutate( values = values/100 ) %>% 
  group_by( variables ) %>% 
  tibbletime::as_tbl_time( index = dates ) %>% 
  tibbletime::as_period( period = "monthly" , side = "end", include_endpoints = TRUE ) %>%
  filter( between( dates ,my_start_date, my_end_date) ) %>% 
  as.tibble() %>% 
  ungroup() %>%
  bind_rows(
    
    bloomberg_df %>%
      semi_join( key_tbl %>% filter( variables %in% !!my_dep_var ) ,
                 by = "symbol") %>%
      left_join( key_tbl %>% filter( variables %in% !!my_dep_var ) ,
                 by = "symbol") %>% 
      tibbletime::as_tbl_time( index = dates ) %>% 
      tibbletime::as_period( period = "monthly" , side = "end", include_endpoints = TRUE ) %>%
      mutate( monthf = month(dates)) %>% 
      group_by( variables, monthf ) %>% 
      drop_na( values ) %>% 
      arrange(dates) %>% 
      mutate( values =  (values - dplyr::lag(values,1))/dplyr::lag(values,1) ) %>% 
      ungroup() %>% 
      filter( between( dates ,my_start_date , my_end_date) )  %>%
      select( dates , variables , values) 
    
    
    
  ) %>% print()


  
df <- df %>%
  spread( variables, values ) %>% 
  tidyr::fill( names(.), .direction = "down") %>% 
  na.omit() %>% 
  gather( variables, values, - dates ) 

# df %>%  distinct(  variables )

df %>% group_by( variables ) %>% skimr::skim()

## Include periods for sub analysis
df <- df %>% 
  mutate( periods = 
            case_when (  dates >= as.Date("2014-01-01") &   dates <  as.Date("2016-03-01")   ~ "Oil Shock" ,
                         dates >= as.Date("2016-03-01") &   dates <  as.Date( "2018-01-01" )  ~ "Reflationary Period" ,
                         dates >= as.Date("2018-01-01") ~ "2018 Q2" ,
                         TRUE ~  "Other Period"
            )
  )  %>%
  mutate( periods = forcats::as_factor( periods, levels = c("Other Period", "Oil Shock", "Reflationary Period" , "2018 Q2")))
# filter( !periods %in% "NA") %>% 
#  bind_rows(

df <- df %>% 
  group_by( variables ) %>% 
  mutate( values = scale( values)/100 ) %>% 
  ungroup()

txt_tbl <- df %>% 
  group_by( variables ) %>% 
  top_n(1, dates) %>%
  ungroup() %>% 
  distinct(dates, variables, values ) %>% 
  mutate( dates = dates %m+% months(6) ,
          variables = forcats::as_factor( variables, levels = variables ) ) %>%
  left_join( key_tbl %>% select( variables, colors),
            by = "variables")

txt_tbl <- txt_tbl %>% 
  mutate( labels = str_glue( "{variables} \n  {percent( values )}"))

my_title <- str_glue( "Standardized Year over Year Returns")
my_subtitle <- str_glue("Data period: {min(df$dates)} - {max(df$dates,1)}" )
my_y_lab  <- "Percent"

df %>% 
  ggplot() +
  geom_line( aes( x = dates, y = values, color = variables), size = 1.2) +
  scale_color_manual(  values = txt_tbl$colors %>% set_names( txt_tbl$variables) ) +
  annotate("text",   x = txt_tbl$dates , y = txt_tbl$values , hjust = .5, vjust = -.0,
           label = txt_tbl$labels,    color = txt_tbl$colors, fontface = 'bold' ) +
  scale_x_date( date_breaks = "2 year" ,date_labels = "%Y" ) +
  scale_y_continuous( name = my_y_lab , labels = scales::percent ) +
  theme_ipsum() +
  theme(legend.position= "none" ) +
  labs( title= my_title ,
        subtitle = my_subtitle,
        caption= my_caption ) +
  
  NULL



```



```{r Oil and Inflation Expectation Corr chart,  warning=FALSE, cache=TRUE, echo=FALSE}




my_title <- str_glue( "Correlation against {my_dep_var} data")
my_subtitle <- str_glue("Correlation data period: {min(df$dates)} - {max(df$dates,1)}" )
my_caption <- ""



df %>% 
  group_by( periods) %>% 
  nest() %>% 
  mutate( corr = map( data,
                      ~ {
                        .x %>%  
                          select( dates , variables, values  ) %>%
                          drop_na( values ) %>% 
                          spread( variables, values) %>%
                          select( - dates ) %>% 
                          corrr::correlate() %>%    
                          corrr::focus( quo_name(my_dep_var) ) %>% 
                          select( rowname , quo_name(my_dep_var) ) %>% 
                          set_names( c("variables", "values")) %>% 
                          drop_na( values ) 
                      }
                      
  )) %>%
  
  unnest(  corr ) %>% 
  # --ggplot here--
  ggplot(aes(x= variables, y= values)) +
  geom_bar( aes( x = forcats::fct_relevel( variables,  rev(my_indep_var)), y = values, fill = variables ) ,stat= "identity", width=.8)+
  scale_y_percent( limits = c(-0.2, 1)) +
  geom_text(aes(label=  scales::percent(values),
                hjust = ifelse(values > 0, -.15, 1.1)),
            color= "black" ) +
  
  coord_flip() +
  facet_wrap( ~ periods) +
  scale_fill_mycol( palette = "main" , discrete = TRUE ) +
  labs(x="",y="",
       subtitle = my_subtitle,
       title= my_title ,
       caption= my_caption)+
  theme_minimal() + theme_ipsum() +
  theme(legend.position = "none"    )







```




## Yield Curve Snapshot

The U.S. Bureau of Economic Analysis (BEA) released the advance first estimate of GDP growth for the final quarter of 2016.  With the advance estimate, the annual growth rate for the full-year is estimated at 1.6 percent. It was the slowest growth in five years.  See the US Real GDP chart.

## Yield Curve Snapshot

```{r Yield Curve Snapshot Chart, fig.height=5,fig.width=9,echo=FALSE, warning=FALSE, cache=TRUE}



my_end_date <-  today() #"2018-06-30" %>% as.Date()


qtr_dates <-   seq(3, 9, by = 3) %>%
  map( ~{ my_end_date %m-% months(.) } ) %>%
  flatten_dbl() %>%
  as.Date() %>%
  c(my_end_date) %>%
  sort()

my_start_date <- qtr_dates[1]


rate_symbols <- c("DGS1MO","DTB3","DTB6", 'DGS1','DGS2','DGS3','DGS5','DGS7','DGS10','DGS20','DGS30')

rate_symbols_names <-c("1-Month Tbill","3-Month Tbill",
                       "6-Month Tbill",
                       'US CMT 1-Year',
                       'US CMT 2-Year',
                       'US CMT 3-Year',
                       'US CMT 5-Year',
                       'US CMT 7-Year',
                       'US CMT 10-Year',
                       'US CMT 20-Year',
                       'US CMT 30-Year')

term_names <- c("1M","3M","6M","1 Year", "2 Year","3 Year",  "5 Year", "7 Year", "10 Year",   "20 Year",  "30 Year")

maturity <- c(1/12,3/12, 6/12,1,2,3,5,7,10,20,30)


#  Key table to join human readable names to data frame
key_tbl <- cbind(symbol = rate_symbols ,
                 names = rate_symbols_names,
                 term = term_names ,
                 maturity = maturity  ) %>%
  tbl_df()


# join with key table for readable names
df <- econ_df %>%
  semi_join(
    key_tbl , by = c("symbol" )
  ) %>%
  left_join(key_tbl, by = c("symbol" )) %>%
  mutate(maturity = as.numeric(maturity)) %>%
  na.omit()

# rename column names to my preference
# rates_data <- rates_data %>% rename_(.dots = set_names(names(.),nm= c("variables","dates","values","names","term","maturity")))
# rates_data <- rates_data %>% select(-cmt,-apy)

# df %>% glimpse()

# https://www.quandl.com/raw_data/FED/SVENY-US-Treasury-Zero-Coupon-Yield-Curve

df <- df %>%
  mutate(cmt = values/100, apy = (1+cmt/2)^2-1,
         term = factor(term, levels = term_names ),datesf = factor(dates))

df %>% 
  tail() %>% 
  knitr::kable()
# https://gist.github.com/timelyportfolio/4da9d6b6c89cce26effabccca30124dd


# https://gist.github.com/timelyportfolio/4da9d6b6c89cce26effabccca30124dd


# select_colors_scale <- getPalette(10)[c(1,3,5,10)]


select_colors_scale <- c(
  
  nord_palettes$lumina[1] ,
  nord_palettes$lumina[2] ,
  nord_palettes$frost[3] ,
  nord_palettes$frost[4]
  
)


select_colors_scale <- c(
  nord_palettes$lumina[c(-1)]
)


df <- df %>%
  group_by(quarter=quarter(dates, T)) %>%
  filter(dates == max(dates)) %>%
  ungroup %>%
  select(-quarter)



# find available begin date in the dates vector
# begin_date <-rates_data$dates[which.min(abs(difftime(rates_data$dates,begin_date)))]

last_4_qtr_dates <- df  %>%
  filter(dates <= my_end_date) %>%
  distinct(dates) %>%
  arrange(dates) %>%
  slice((n()-3):n())

df <- df %>%
  filter(dates %in% last_4_qtr_dates$dates ) %>%
  arrange(dates) %>%
  mutate( pos = values)

txt_tbl <- df %>%
  filter(term %in% "30 Year") %>%
  distinct(.keep_all = TRUE) %>%
  mutate( label = ceiling_date(dates, "month") - days(1)) %>%
  mutate( maturity =  maturity+1.9 ) %>% 
  mutate( colors =  my_pal("main")(length(.$variables)))

txt_tbl <- txt_tbl %>%
 mutate(  vjust = if_else( label == "2018-06-30", -1, .5) )#   hjust = .6 )

p <- df %>%
  ggplot(aes(x= maturity,y= cmt, color = datesf,group =datesf))+
  geom_line(alpha=1,size=1.2) +
  scale_x_continuous( expand = c(0.,0.), breaks=  maturity[c(4,6:11)], labels= term_names[c(4,6:11)]) +
  #scale_x_discrete( expand = c(0.08333333,0.08333333))+
  scale_y_percent()+
    scale_color_manual(  values = txt_tbl$colors %>% set_names( txt_tbl$datesf) ) +
  coord_cartesian(xlim = c(0., 35),ylim = c(0.01, .035)) +
  annotate("text",  x = txt_tbl$maturity , y = txt_tbl$cmt ,
           label = txt_tbl$label, color = txt_tbl$colors ,
           size = 6,
           fontface = "bold" , vjust = txt_tbl$vjust) + # , cex = 4.5,  hjust = text_df$hjust, vjust = text_df$vjust

  labs(x="Time To Maturity",y="Yield to Maturity (%)",
       subtitle = "Treasury Yield Curve Quarter Over Quarter Comparison For The Second Quarter 2018",
       title="US Treasury Yield Curve",
       caption="Source: Daily Treasury Yield Curve Rates, US Department of the Treasury",
       color = "Yield Date") +
    # theme_Publication() +
  theme_minimal() + theme_ipsum() +
  theme(axis.text  = element_text(size=12))+
  theme(legend.position = "none") +
  theme(
    panel.grid.major = element_line(colour = "grey92"),
    panel.grid.minor = element_line(colour = "grey92",
                                    size = 0.25),
    axis.line = element_line(colour="black")
  )



pic_list$yld_curv_p <- p

ggsave('output_data/img/yld_curv_p.png', width = 16, height = 9, dpi = 100) #, width

p


```


```{r Yield Curve Delta Snapshot Chart, fig.height=5,fig.width=9,echo=FALSE, warning=FALSE, cache=TRUE}




# for yield curve ----
key_tbl <- data.frame(symbol=c("DGS3MO",
                          "DGS1",
                          "DGS2",
                          "DGS3",
                          "DGS5",
                          "DGS7",
                          "DGS10",
                          'DGS20',
                          'DGS30'),
                 months=c(3,12,24,36,60,84,120, 240, 360),
                 ttm=c("3 M","1 Y", "2 Y","3 Y","5 Y",
                       "7 Y","10 Y" ,  "20 Y",  "30 Y"))

df <- econ_df %>%
  semi_join(
    key_tbl , by = c("symbol" )
  )  %>% 
  left_join(key_tbl, by = c("symbol" )) %>%
  drop_na( values )

df <-  df %>%
  mutate( id = row_number()) 
knitr::kable(head(df,10))



dates_list_yc <- unique(df$dates)
num_dates <- length(dates_list_yc)
# dlist.yc[year(dlist.yc)==2018] find starting dates row number = 4504
i_start <- 4504

i_start <- df %>%
  filter( year( dates) == 2018 ) %>% 
  slice( 1 ) %>% 
  pull( id )

myplotf <- function( i= i_start, pre_step = 30 ){
  
  
  in_df <- df %>% 
    filter( dates %in% dates_list_yc[c(i-pre_step,i)] ) %>%
    group_by(ttm) %>%
    mutate(pmax= max(values), pmin = min(values)) %>%
    mutate(p_up = ifelse(dates ==max(dates), values , pmin),
           p_down = ifelse(dates ==max(dates), values, pmax))
    
    g.line <- 
      ggplot(data= in_df, 
             aes(x= months,y= values , group= dates, 
                 linetype= factor(dates),color= factor(dates))) +
      theme_minimal(base_size=14) +
      scale_x_continuous(breaks= key_tbl$months, labels= key_tbl$ttm) +
      geom_ribbon(aes(ymin= pmin, ymax=p_up, fill="up"),alpha=0.25,color=NA)+
      geom_ribbon(aes(ymin= pmax, ymax=p_down, fill="down"), alpha=0.25) +
      geom_point(size=4)+
      geom_path() +
      scale_color_mycol("mixed",reverse=T, name="Date")+
      scale_fill_mycol("mixed",reverse=T, name="Date")+
      guides(fill=F,linetype=F)+
      theme(legend.position="top")+
      labs(x="Time to Maturity",y="Yield (%)",
           title="U.S. Treasury Yield Curve",
           subtitle= str_glue( "Blue: current day, Red: {pre_step} trading days prior" ))+
      scale_y_continuous(limits=c(0,3.5),breaks=seq(0,3.5,0.5))
  
  g.bar <- 
    ggplot(data= in_df, aes(x= months,
                           y=p_down- values ))+
    geom_col(aes(fill="yield up"),alpha=0.5)+
    geom_col(aes(y=p_up- values ,fill="yield down"),alpha=0.5)+
    theme_minimal(base_size=14)+ # base_size=14
    theme_ipsum() + 
    scale_x_continuous(breaks=key_tbl$months, labels= key_tbl$ttm)+
    scale_y_continuous(limits=c(-0.6,0.6))+
    scale_color_mycol("mixed",reverse=T, name="Change")+
    scale_fill_mycol("mixed",reverse=T, name="Change")+
    theme(legend.position="top",
          plot.caption=element_text(hjust=0))+
    labs(x="time to maturity",y="change in yield (%)",title="",
         caption="@Hyungjin Lim Source: Board of Governors of the Federal Reserve System (US), H.15 Selected Interest Rates\nretrieved from FRED, Federal Reserve Bank of St. Louis; July 6, 2018 ")
  
  # g<- cowplot::plot_grid(g.line,g.bar,ncol=1,rel_heights = c(1,1), align="hv")  # use cowplot for multiple plots
g<-  g.line  + g.bar + plot_layout(ncol = 1, heights = c(2, 1) )

  }


myplotf( num_dates, 30 ) %>% print




```



```{r  US Treasury Yield Curve Chart, warning=FALSE, cache=TRUE}



############################################################
# Extract Break Even Inflation , Rates Data
############################################################

# Monetary_Symbols_Names
# select interested variables
select_symbols_names <- c("2-Year CMT"  ,"10-Year CMT"  ) #

my_start_date <- "2017-01-01" %>% as.Date()
my_end_date <- today() # "2018-06-30" %>% as.Date()

# select_colors_scale <- getPalette(2)

select_colors_scale <-   c(

  nord_palettes$frost[4],
    nord_palettes$aurora[1] 
  
)




df <- econ_df %>%
  filter(variables %in% select_symbols_names ) %>%
  filter( between( dates ,my_start_date, my_end_date), !is.na(values)  ) %>%
  select(dates,values,variables) %>%
  spread(variables  , values) %>%
  mutate(`US Curve` = .[["10-Year CMT"]] - .[["2-Year CMT"]] ) %>% # caculate yield curve
  gather(variables, values, -dates) %>%
  mutate( values = values/100, pos =values) %>%
  group_by(variables) %>%
  mutate(pos = min(values,na.rm=TRUE)) %>%
  ungroup()

df <-  df %>%
  filter( variables %in% "US Curve" ) %>%
  filter(!is.na(values))

#*****************************************************************
# subset event dates
#******************************************************************

cbs_dates <-   c("2008-11-25",
                 "2010-11-02",
                 "2012-09-13" ,
                 "2016-11-08")

cbs_labels <- c(  "QE1 Begins",
                  "QE2 Begins",
                  "QE3 Begins",
                  "Trump Win-Reflation Hope")

cbs_df <- data.frame(date=as.Date(cbs_dates), event= cbs_labels)




# match cbs dates
cbs_df_sub <- match_cbs_df(cbs_df,df )
cbs_df_sub <- cbs_df_sub %>%  filter( variables %in% "US Curve" )


#*****************************************************************
# Plot http://drawar.github.io/posts/add-borders-annotate-outside-ggplot/
#******************************************************************


p <-  ggplot()+

  geom_line(data = df, aes(x=dates,y=values,color=variables),
            alpha=1 ,size=1) +
  scale_color_manual(values = select_colors_scale[1]) +
  geom_vline(  xintercept = as.numeric(filter(cbs_df_sub ,date >= my_start_date, date <= my_end_date)$dates),
               size = 1, color= select_colors_scale[2],linetype="dashed")  +
  geom_text_repel(data = filter(cbs_df_sub ,date >= my_start_date, date <= my_end_date) ,aes(x=  as.Date(dates),
                                                                                              y=  values, label=event),
                  size =3,
                  family = 'Arial',
                  fontface = 'bold', color = select_colors_scale[2],
                  # Add extra padding around each text label.
                  box.padding = unit(0.5, 'lines'),
                  # Add extra padding around each data point.
                  point.padding = unit(1.6, 'lines'),
                  # Color of the line segments.
                  segment.color = select_colors_scale[2],
                  # Width of the line segments.
                  segment.size = 0.5,
                  # Draw an arrow from the label to the data point.
                  arrow = arrow(length = unit(0.01, 'npc')),
                  # Strength of the repulsion force.
                  force = 1,
                  # Maximum iterations of the naive repulsion algorithm O(n^2).
                  max.iter = 3e3,
                  nudge_x = 200,
                  nudge_y = 5
  ) +
  # scale_x_date(date_breaks = "5 year", date_labels = "%Y") +
  
  scale_y_continuous(label=scales::percent)+
  theme_minimal()+theme(plot.caption=element_text(hjust=0))+
  labs(x="",y= "Yield Curve" ,
       title="Historical Movement of US Treasury Yield Curve",
       caption="Source : Federal Reserve\nNote: The lines show the difference between benchmark 10- and two-year government bond \nyields in percentage points. Gray bars indicate recessions as determined by the National       \nBureau of Economic Research.") +
 # theme_Publication()
theme_minimal() + theme_ipsum() +
  theme( legend.position = "none") +
  NULL


p <- p %>%  # add reccesion shade
  my_area_func( recession_df ,  my_start_date )


pic_list$yldcur_p1 <- p

p

ggsave('output_data/img/yldcur_p1.png') #, width = 16, height = 9, dpi =






```




```{r  US Treasury Yield Curve Chart, warning=FALSE, cache=TRUE}



############################################################
# Extract Break Even Inflation , Rates Data
############################################################

# Monetary_Symbols_Names
# select interested variables
select_symbols_names <- c("Effective Federal Funds Rate") #

my_start_date <- "1990-01-01" %>% as.Date()
my_end_date <- today() # "2018-06-30" %>% as.Date()

# select_colors_scale <- getPalette(2)

select_colors_scale <-   c(

  nord_palettes$frost[4],
    nord_palettes$aurora[1] 
  
)




df <- econ_df %>%
  filter(variables %in% select_symbols_names ) %>%
  filter( between( dates ,my_start_date, my_end_date), !is.na(values)  ) %>%
  select(dates,values,variables) %>%
  spread(variables  , values) %>%
  gather(variables, values, -dates) %>%
  mutate( values = values/100, pos =values) %>%
  group_by(variables) %>%
  mutate(pos = min(values,na.rm=TRUE)) %>%
  ungroup()

df <-  df %>%
  filter(!is.na(values))

#*****************************************************************
# subset event dates
#******************************************************************

cbs_dates <-   c("2008-11-25",
                 "2010-11-02",
                 "2012-09-13" ,
                 "2016-11-08")

cbs_labels <- c(  "QE1 Begins",
                  "QE2 Begins",
                  "QE3 Begins",
                  "Trump Win-Reflation Hope")

cbs_df <- data.frame(date=as.Date(cbs_dates), event= cbs_labels)




# match cbs dates
cbs_df_sub <- match_cbs_df(cbs_df,df )
cbs_df_sub <- cbs_df_sub %>%  distinct(event, .keep_all = TRUE)


#*****************************************************************
# Plot http://drawar.github.io/posts/add-borders-annotate-outside-ggplot/
#******************************************************************
my_title <- "Historical Movement of Effective Federal Funds Rate" 
my_caption <- "Source : Federal Reserve\nNote: The lines show the difference between benchmark 10- and two-year government bond \nyields in percentage points. Gray bars indicate recessions as determined by the National       \nBureau of Economic Research."

p <-  ggplot()+

  geom_line(data = df, aes(x=dates,y=values,color=variables),
            alpha=1 ,size=1) +
  scale_color_manual(values = select_colors_scale[1]) +
  scale_x_date(date_breaks = "5 year", date_labels = "%Y") +
  
  scale_y_continuous(label=scales::percent)+
  theme_minimal()+theme(plot.caption=element_text(hjust=0))+
  labs(x="",y= "Yield Curve" ,
       title=  my_title,
       caption= my_caption ) +
 # theme_Publication()
theme_minimal() + theme_ipsum() +
  theme( legend.position = "none") +
  NULL


p <- p %>%  # add reccesion shade
  my_area_func( recession_df ,  my_start_date )


pic_list$fed_p1 <- p

p

ggsave('output_data/img/fed_p1.png') #, width = 16, height = 9, dpi =






```





```{r  US Treasury Yield Direction Chart, warning=FALSE, cache=TRUE}



my_start_date <- "2000-01-01" %>% as.Date()
my_end_date <- today() #"2018-06-30" %>% as.Date()

# select_colors_scale <- getPalette(2)

select_colors_scale <-   c(

  nord_palettes$frost[4] ,
  nord_palettes$aurora[1]
)

############################################################
# First Data
############################################################

# Monetary_Symbols_Names
# select interested variables
select_symbols_names <- c("2-Year CMT"  ,"10-Year CMT"  ) #


df <- econ_df %>%
  filter(variables %in% select_symbols_names ) %>%
  filter( between( dates ,my_start_date, my_end_date), !is.na(values)  ) %>%
  select(dates,values,variables) %>%
  spread(variables  , values) %>%
  mutate(`US Curve` = .[["10-Year CMT"]] - .[["2-Year CMT"]] ) %>% # caculate yield curve
  gather(variables, values, -dates) %>%
  mutate( values = values/100, pos =values) %>%
  group_by(variables) %>%
  mutate(pos = min(values,na.rm=TRUE)) %>%
  ungroup()

df <-  df %>%
  filter( variables %in% "10-Year CMT" ) %>% # "US Curve"
  filter(!is.na(values))


#*****************************************************************
# Second Data
#******************************************************************


select_symbols_names <- c(  "MXWD0BK Index" , # MSCI ACWI Banks Index "S5BANKX Index", # 
                         'NDUEACWF Index') # MSCI ACWI Net TR USD Index  'SPX Index') #


select_names <- c( "World Bank",
                   "World")


df2 <- bloomberg_df %>%
  rename(variables = symbol) %>%
  filter(variables %in% select_symbols_names) %>%
  left_join(
    tibble(select_symbols_names ,select_names ) , by  = c("variables" = "select_symbols_names")
  ) %>%
  filter( between( dates ,my_start_date, my_end_date) )  %>%
  group_by(variables) %>%
  arrange(dates) %>%
  mutate(rets = (values - lag(values,1))/lag(values,1)) %>%
  ungroup() %>%
  na.omit() %>%
  select(dates,rets,select_names) %>%
  spread(select_names,rets) %>%
  mutate(delta = .[["World Bank"]]  - .[["World"]] ) %>%
  gather(variables, values, -dates) %>%
  group_by(variables) %>%
  arrange(dates) %>%
  na.omit() %>%
  mutate(values = 100*cumprod(1+values)) %>%
  ungroup() %>%
  filter(variables %in% "delta")


# Normalizer to bring 2nd data into 1st data range. This makes
# highest bar equal to highest point. You can use a different
# normalization if you want (e.g., this could be the constant 15
# like you had in your example, though that's fragile if the data
# changes).
normalizer <- max(df$values) / max(df2$values)



text_df <-  tibble( dates = as.Date("2005-01-30"), values = 0.025 ,variables = "US Treasury 10-Year Yield") %>%
  bind_rows(
    tibble( dates = as.Date("2014-01-30") , values = 110*normalizer ,variables =  "MSCI World Bank vs. World Stock")

  )


#*****************************************************************
# Plot http://drawar.github.io/posts/add-borders-annotate-outside-ggplot/
#******************************************************************

my_title <- "Direction of US Treasury Yield"
my_caption <- "Source: Federal Reserve\nNote: The relative cumulative performances of \"MSCI World Bank vs. World\" are represented by MSCI ACWI Bank and MSCI ACWI Indicies\nusing a base value of 100 at the start of 2000."
my_y_lab <- "Percent"
my_2nd_y_lab <- "Cumulative Performance"

p <-  ggplot()+
 # geom_rect(data=  filter(recession_df, start >=  min(df$dates, na.rm =TRUE )) ,
  #          aes(xmin= start, xmax= end, ymin=-Inf, ymax=+Inf),
  #          fill="gray", alpha=0.35) +
  geom_line(data = df, aes(x=dates,y=values,color=variables),
            alpha=1,color =  select_colors_scale[1] ,size=1) +
  geom_line(data = df2, aes(x=dates,y= values*normalizer,color=variables),
            alpha=1,color =  select_colors_scale[2] ,size=1) +

  scale_x_date(date_breaks = "2 year", date_labels = "%Y") +
  scale_y_continuous(label=scales::percent , name = my_y_lab ,
                     sec.axis = sec_axis(trans= ~./normalizer,
                       name = my_2nd_y_lab )) +

  annotate(geom = "text",
           x = text_df$dates , y = text_df$values ,
           label = text_df$variables , size = 5,
           fontface = 'bold', color = select_colors_scale ,  vjust = .0) +
  theme_minimal() + theme_ipsum() +
  theme(plot.caption=element_text(hjust=0),
        axis.text.y.left = element_text(colour= select_colors_scale[1]),
        axis.text.y.right = element_text(color =  select_colors_scale[2]),
        axis.title.y = element_text(color= select_colors_scale[1]),
        axis.title.y.right = element_text(color= select_colors_scale[2]) ) +
  labs( title= my_title ,
       caption= my_caption ) +
# theme_Publication()
NULL

p <- p %>%  # add reccesion shade
  my_area_func( recession_df ,  my_start_date )


pic_list$bank_p <- p

pic_list$gbl_spread_p
p

ggsave('output_data/img/bank_p.png') #, width = 16, height = 9, dpi =





```



```{r eval=FALSE}
file.edit(
  tint:::template_resources(
    'tint', '..', 'skeleton', 'skeleton.Rmd'
  )
)
```

```{r bib, include=FALSE}
# create a bib file for the R packages used in this document
knitr::write_bib(c('base', 'rmarkdown'), file = 'skeleton.bib')
```

