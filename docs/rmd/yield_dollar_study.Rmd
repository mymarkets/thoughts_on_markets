---
title: "Global Yield Spread Impact on Currency Movements"
subtitle: "An investigation into Rate Differential on US Dollar"
author: "Hyungjin Lim"
date: "`r Sys.Date()`"
output: tint::tintHtml
bibliography: skeleton.bib
link-citations: yes
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
library(tint)
# invalidate cache when the package version changes
knitr::opts_chunk$set(tidy = FALSE, cache.extra = packageVersion('tint'))
options(htmltools.dir.version = FALSE)

```

# Currency Market Update...


In a nutshell, our frameworks and analysis (both conventional and unconventional) suggest the multi-year bull market in the US Dollar is not dead.

Capital is likely to continue to concentrate in the USA at least for the foreseeable future with global banking system and also European issues likely to create further flights into the US Dollar from time to time (our analysis suggesting that presently we could be seeing the
beginnings again of another sub-cycle of escalating risks out of the Eurozone). 

This will likely also cause the continued outperformance of the US Equity Market vs. the rest of the world's equity markets.

A Simple model for currencies is articulated by George Soros...

> "Speculative capital moves in search of the highest total return. Total Return has 3 elements:
(1) The interest rate differential, (2) The FX rate, (3) The capital appreciation in local currency.
Expectations about future exchange rates constitute the main motivation in speculative capital flow."
>
> `r tufte::quote_footer('--- George Soros, The Alchemy of Finance.')`


We can proxy some of these things (in a single chart) by looking at 

1.  the relative 10yr Sovereign Bond yield spread between two currency blocs
2.  the relative total return share market performances between the two currency blocs. 

These two simple things we find help us to see at a glance the major underlying trends indicative of capital flows and
capital market pricing trends in a manner that is relevant to the currency pair in question. ^[It should be noted that a currency pair will tend to move in tandem (positive correlation) with the 10yr Bond Yield Spread unless confidence in a nations government/currency is lost, in which case the excessive inflationary conditions due to the deterioration of confidence (unhealthy increases in velocity and quantity of liquidity in one country) will see the relationship between the bond yield spread and the currency move to an inverse correlation (i.e. with a deterioration in the nation's bond market matched with a weakening of the currency).]


## The relative 10yr Sovereign Bond yield spread

Global bond yield spread continues widening since the beginning of 2018, as US economy outperformed the rest of the world. 
Given the strength of on-going US economic growth, US interest rate is expected to widen relative to the rest of major economies. 

With RSI making lower high, the Spread will make new high. 


```{r data_prep, tidy = TRUE, fig.fullwidth = TRUE , warning=FALSE, message=FALSE, cache=TRUE, echo=FALSE}

# http://www.prerequisite.com.au/wp-content/uploads/2018/04/2018-04-25-Quarterly-Client-BRIEFING.pdf

# the relative 10yr Sovereign Bond yield spread between two currency blocs



############################################################
# First data parameters
############################################################

# http://socviz.co/refineplots.html#case-studies

my_start_date <- "2000-01-01" %>% as.Date()
my_end_date <- today() # "2018-06-30" %>% as.Date()

key_tbl <- tribble(
  ~symbol ,              ~variables,
  'USGG10YR Index',       "US 10Y", 
  # 'GECU10YR Index',  "Euro Area 10Y" ,
  'GDBR10 Index',      "Euro Area 10Y" ,
  'GUKG10 Index',       "UK 10Y",
  'GJGB10 Index' ,   "Japan 10Y" ,
  "GCAN10YR Index",   "Canada 10Y" ,
  "GACGB10 Index",    "Aus 10Y" ,
  "GCNY10YR Index",   "China 10Y" ,
  'DXY Curncy',         "US Dollar Index",
  "USTWBROA Index",     "Broad US Dollar Index" ,
  "RAY Index",          "US",
  "MXWDU Index" ,       "International"
  
)


# Turn the normal mean function into a rolling mean with a 5 row window
mean_roll <- rollify( function(x) mean(x ,na.rm = TRUE), window = 21)


############################################################
# Second Raw Data
############################################################

raw_df <- bloomberg_df %>% 
  filter( symbol %in% key_tbl$symbol ) %>% 
  left_join( key_tbl , by  = c("symbol")) %>%
  select( dates, variables, values ) %>% 
  filter( between( dates ,my_start_date, my_end_date) )  %>%
  group_by( variables ) %>% 
#  mutate( values = mean_roll(values)) %>% 
  ungroup() %>% 
  spread( variables, values ) %>% 
  tidyr::fill( names(.), .direction = "down") %>% 
  gather( variables, values, - dates ) %>% 
  mutate( values = if_else( str_detect( variables, "10Y"), values/100, values))

raw_df <- raw_df %>%
  spread(variables,values) %>%
  mutate(
          Average = rowMeans(select(.,one_of(   "Euro Area 10Y",  "UK 10Y",  "Japan 10Y"  ,
                                                "Canada 10Y" , "Aus 10Y" , "China 10Y" 
                                               )) , na.rm = TRUE)
  ) %>%
  mutate( `Yield Spread` =   .[["US 10Y"]]  - .[["Average"]] ) %>% 
  gather( variables , values , - dates  ) 

# check data 


my_review_date <- "2015-01-01" %>% as.Date()


# data check
ggplot()+
  geom_line(data = raw_df %>% filter( between( dates , my_review_date , today()))
            , aes(x=dates,y=values, color = variables), alpha=1,size=1) +
  scale_x_date(expand = c(0,0), date_breaks = "1 year" , date_labels = "%Y" ) +
  scale_y_continuous( ) +
  facet_wrap( ~variables, scale = "free_y" ) +
  theme_minimal() + theme_ipsum() +
  theme( plot.caption=element_text(hjust=0),
         legend.position = "none",
         axis.text.y.left = element_text(colour= my_cols("red") ),
         axis.title.y = element_text(color= my_cols("red"))) +
  labs( title= "Data Check" ) +
  # theme_Publication()
  NULL




```



```{r glb_yield_spread, tidy = TRUE, fig.fullwidth = TRUE , warning=FALSE, message=FALSE, cache=TRUE, echo=FALSE}

############################################################
# plot Global 10 Year Bond Yield Spread
############################################################

# plot
my_review_date <- "2018-01-01" %>% as.Date()

my_title <- "Global Capital Flow - Demand for US Dollar"
my_subtitle <- ""
my_caption <- "Source: Bloomberg\nNote: Asia Dollar Index is inverted to be aligned with Dollar Index.\nAll indices used a base value of 100 at the start of 2000."
my_y_lab <- "Cumulative Performance"

df <- raw_df %>% 
  filter( variables %in% c("Broad US Dollar Index", "US Dollar Index")) %>% 
  filter( between( dates, my_review_date , today())) %>% 
  group_by( variables ) %>% 
  tq_transmute( select = values ,
                mutate_fun = dailyReturn,
                type = "arithmetic",
                col_rename = "values") %>% 
  filter( !is.na(values)) %>% 
  mutate( values = cumprod( 1 + values) -1) %>% 
  ungroup()

my_xlim <-  my_axis_fun( df , dates ) %>% as.Date()
my_xlim[2] <- my_xlim[2]  %m+% months(6)
# my_xlim
# Create a vector of the last (furthest right) y-axis values for each group
txt_tbl <- df %>% 
  group_by( variables ) %>% 
  top_n(1, dates) %>% 
  ungroup() %>% 
  mutate( variables = factor( variables, levels = variables)) %>% 
  mutate( colors =  my_pal("main")(length(.$variables)))

txt_tbl <- txt_tbl %>% 
  mutate( labels = str_glue( "{variables} \n  {percent( values )}"))

p <- ggplot()+
  geom_line( data = df, aes(x=dates,y=values, color = variables), alpha=.8, size=2) +
  scale_x_date(date_breaks = "1 year" , limits = c(my_xlim[1] , my_xlim[2]), date_labels = "%Y" ) +
  annotate("text",   x = txt_tbl$dates , y = txt_tbl$values , hjust = -.1, vjust = -.0,
           label = txt_tbl$labels,    color = txt_tbl$colors, fontface = 'bold' ) +
  scale_y_continuous( name = my_y_lab ,label=scales::percent ) +
  scale_color_manual(  values = txt_tbl$colors %>% set_names( txt_tbl$variables) ) +
  
  #  facet_wrap( ~variables, scale = "free_y" ) +
  theme_minimal() + theme_ipsum() +
  theme( plot.caption=element_text(hjust=0),
         legend.position = "none" , 
         legend.title = element_blank() ,
         axis.text.y.left = element_text(colour= my_cols("red") ),
         axis.title.y = element_text(color= my_cols("red") )) +
  labs( title= my_title, subtitle = my_subtitle) +
  # theme_Publication()
  NULL

p <- p %>%  # add reccesion shade
  my_area_func( recession_df ,  my_start_date )

p

```




```{r Review US Dollar and Liquidity Dynamics, fig.width = 10, fig.height = 2, fig.fullwidth = TRUE, fig.cap = "Review US Dollar and Liquidity Dynamics",echo=FALSE, warning=FALSE, cache=TRUE}


############################################################
# plot Global 10 Year Bond Yield Spread
############################################################

# plot
my_title <- "Global 10 Year Bond Yield Spread"
my_subtitle <- "10yr Bond Yield Spread (USA vs. Average: Euro Area, UK, Japan)"
my_y_lab <- "Percent"

df <- raw_df %>% 
  filter( between( dates , my_review_date , today())) %>% 
  filter( variables %in% c("Yield Spread", "US 10Y", "Average")) %>% 
  mutate( variables = factor( variables, levels =c("Yield Spread", "US 10Y", "Average") ))

my_xlim <-  my_axis_fun( df , dates ) %>% as.Date()
my_xlim[2] <- my_xlim[2]  %m+% months(2)
# my_xlim
# Create a vector of the last (furthest right) y-axis values for each group
txt_tbl <- df %>% 
  group_by( variables ) %>% 
  top_n(1, dates) %>% 
  ungroup() %>% 
mutate( variables = factor( variables, levels = variables)) %>%
  mutate( colors =  my_pal("main")(length(.$variables)))

txt_tbl <- txt_tbl %>% 
  mutate( labels = str_glue( "{variables} \n  {percent( values )}"))

p <- ggplot()+
  geom_line( data = df, aes(x=dates,y=values, color = variables), alpha=.8, size=2) +
  scale_x_date(date_breaks = "1 year" , limits = c(my_xlim[1] , my_xlim[2]), date_labels = "%Y" ) +
  annotate("text",   x = txt_tbl$dates , y = txt_tbl$values , hjust = -.01,
           label = txt_tbl$labels,    color = txt_tbl$colors, fontface = 'bold' ) +
  scale_y_continuous( name = my_y_lab ,label=scales::percent ) +
  scale_color_manual(  values = txt_tbl$colors %>% set_names( txt_tbl$variables) ) +
  # facet_wrap( ~variables, scale = "free_y" , ncol = 1) +
  theme_minimal() + theme_ipsum() +
  theme( plot.caption=element_text(hjust=0),
         legend.position = "none" , 
         legend.title = element_blank() ,
          axis.text.y.left = element_text(colour= my_cols("red") ),
         axis.title.y = element_text(color= my_cols("red") )) +
  labs( title= my_title, subtitle = my_subtitle) +
  # theme_Publication()
  NULL

p

df_rsi <- df %>%
  drop_na( values ) %>% 
  group_by( variables ) %>%
  tq_mutate(select     = values , 
            mutate_fun = RSI, 
            n      = 14 ,  
            maType     = SMA) %>% 
  ungroup() %>% 
  mutate(# variables = "RSI" ,
          values = rsi) %>% 
  select( - rsi ) 


p_rsi <-  ggplot( data = df_rsi %>% filter( between( dates , my_review_date , today())) )+
  geom_line( aes(x=dates,y=values, color = variables), alpha=1,size=1) +
  facet_wrap( ~variables, ncol = 1) +
  scale_color_manual(  values =  txt_tbl$colors %>% set_names( txt_tbl$variables)  ) +
  scale_x_date(expand = c(0,0), limits = c( my_review_date , my_xlim[2]), date_breaks = "1 year" , date_labels = "%Y" ) +
  theme_minimal() + theme_ipsum() +
  theme( plot.caption=element_text(hjust=0),
         legend.position = "none",
         axis.text.y.left = element_text(colour= my_cols("red")),
         axis.title.y = element_text(color= my_cols("red"))) +
  labs( y = "RSI") +
  # theme_Publication()
  NULL

p_rsi



```
 
 


```{r user_funs,  eval = TRUE  ,echo=FALSE, warning=FALSE, cache = TRUE}

############################################################
# Third convenience functions to use
############################################################

my_lags <- function(data, select_var, my_fun , num_step = 21, max_lag = 12 ){
  
  var_exp <- enquo( select_var )
  
  n_steps <- (1:max_lag)*num_step
  
  my_colnames <- str_c( rlang::quo_text(var_exp) ," ",n_steps)
  
 # print( str_glue( "Lags:  { n_steps } ") )
  
  data <-   data %>% 
    select( dates, variables, values ) %>% 
    filter( variables %in% rlang::quo_text(var_exp)) %>% 
    group_by( variables ) %>% 
    tq_transmute(
      select     = values 
      ,mutate_fun = my_fun 
      ,k          = n_steps
      , col_rename =  my_colnames
    ) %>% 
    ungroup() %>% 
    set_names( str_replace_all(names(.),  "values" , .$variables %>% unique() )) %>% 
    set_names( str_replace_all(names(.),  "[.]" ,  " ")) %>% 
    select( - variables )
  
  return( data )
  
}


fit_model <- function(data , xvar , yvar ) {
  
  expr_x <- enquo( xvar )
  expr_y <- enquo( yvar )
  
  # change column name
  data <- mutate(  data , !!quo_name(  expr_x  ) :=  values )
  # create formula
  my_formula <- str_glue(  sym( quo_name( expr_y )) , " ~ " , sym( quo_name( expr_x)  ) )%>% as.formula()
  # run regression
  lm(  my_formula , data = data)
  
}


my_diff <- function( data , num_lag = 251 ){
  
  data %>% 
    tq_transmute(
      select     = values 
      ,mutate_fun = momentum
      ,n = num_lag # ,type = "arithmetic"
      ,col_rename =  "values"
    )
  
}


my_rets <- function( data , num_lag = 251 ){
  
#  num_lag <- enquo( num_lag )
  
  data %>% 
    tq_transmute(
      select     = values 
      ,mutate_fun =  ROC
      ,n = num_lag
      ,type = "discrete"
      ,col_rename =  "values"
    )
  
}

# function table
my_fn_tbl <- tribble(
  ~type,       ~fn,       ~num_lag,
  "yield",     my_diff,      252 ,
  "return",     my_diff,     252 
)



```


```{r yoy_returns_relationshiop, fig.fullwidth = TRUE ,fig.width = 12, fig.height= 6, echo=FALSE, warning=FALSE, cache=TRUE}
# a boxplot of weight vs transmission; this figure
# will be placed in the margin



```




```{r data_process,  fig.fullwidth = TRUE ,eval = TRUE  ,echo=FALSE, warning=FALSE, cache = TRUE}



#*****************************************************************
# Process Raw Data
#******************************************************************


my_dep_var <- sym( "US Dollar Index" )
my_indep_var <- sym( "Yield Spread")
num_step <- 21
max_lag <- 12


# create lagged independent variables
df <-  
  my_lags( raw_df , `Yield Spread`, lag.xts , num_step = num_step , max_lag = max_lag ) %>%  
  gather( variables , values , - dates ) %>% 
  bind_rows(
    # create dependent variables
    raw_df  %>% 
      filter( variables %in% c( quo_name( my_indep_var ),  quo_name( my_dep_var ) )) %>%
      select( dates, variables, values )
  )

# check data 
df %>% 
  filter( str_detect( variables , "Yield") ) %>% 
  # filter( str_detect( variables, "Yield")) %>% na.omit() %>% 
  ggplot( aes( x = dates, y = values, color = variables)) + 
  geom_line() +
  facet_wrap( ~variables, scale = "free_y") +
  theme_ipsum()+
  theme( legend.position = "none") +
  labs( title = "Data Sanity Check")


# join with function table to convert to invariates
df  <- df %>% 
  group_by( variables ) %>% 
  nest() %>% 
  mutate( type = if_else( str_detect( variables ,"Yield" ) , "yield" ,"return") ) %>% 
  left_join(
    my_fn_tbl , by = "type"
  )



# run diff/returns process 
df <- df %>% 
  # Create a "param" column to pass to `fn`.
  mutate(params = purrr::transpose(list(
    "data" =  data ,
    "num_lag" = num_lag)
  )
  ) %>% 
  mutate( data = invoke_map(  fn , params )) 



# check
df$data[[1]] %>% 
  filter( dates >= "2015-02-02") %>% 
#  my_fn_tbl$fn[[2]]() %>%
  ggplot( aes( x = dates, y = values)) + 
  geom_line() 

# check
df$data[[14]] %>% 
  filter( dates >= "2015-02-02") %>% 
  ggplot( aes( x = dates, y = values)) + 
  geom_line() 


# unnest
df <- df %>% 
  select( variables, data ) %>% 
  unnest( data )


# standardize
df <- df %>% 
  group_by( variables ) %>% 
  mutate( values = scale( values )) %>% 
  ungroup()

# check
df %>% 
  group_by( variables ) %>% 
  skimr::skim()



#*****************************************************************
# Plot http://drawar.github.io/posts/add-borders-annotate-outside-ggplot/
#******************************************************************

my_title <- "US Dolloar vs. Global Yield Spread"
my_subtitle <- "Year-over-year returns relationship"
my_caption <- "Source: Bloomberg\nNote: The relative cumulative performances of \"US vs. International\" are represented by Russell 3000 and\nMSCI ACWI-ex US Indicies using a base value of 100 at the start of 2000."

my_dep_var <- sym( "US Dollar Index" )
my_indep_var <- sym( "Yield Spread")

df %>% 
  filter( between( dates,  as.Date( "2015-01-01"), today())) %>% 
  filter( variables %in% c( quo_name(my_indep_var), quo_name(my_dep_var) )) %>% 
  ggplot( mapping = aes( x = dates  , y =  values , color = variables) ) +
  geom_line( size = 1.5) +
  scale_color_mycol(palette = "main") +
  #  scale_y_percent( ) +
  # scale_x_percent( ) +
  theme_minimal() + theme_ipsum() +
  theme( legend.position = "top" ,
         legend.title = element_blank())


df %>% 
  spread( variables, values) %>%
  select( - dates ) %>% 
  corrr::correlate() %>%   
  corrr::focus( quo_name(my_dep_var) ) %>% 
  set_names( c("variables", "values")) %>% 
  ggplot() +
  geom_bar( aes( x = reorder( variables, values), y = values) ,stat= "identity")+
  scale_y_percent() +
  coord_flip() +
  theme_minimal() + theme_ipsum() +
  theme( legend.position = "top") +
  labs( title = str_glue("{quo_name(my_dep_var)} Correlation"),
        x = "Variables", y = "Correlation")


```





```{r reg_analysis_1,  fig.margin = TRUE ,eval = TRUE  ,echo=FALSE, warning=FALSE, cache = TRUE}


#*****************************************************************
# Run Regression Analysis
#******************************************************************




df <- df %>% #  , - `Yield Spread`  ,  - `US vs International` 
  filter( dates >= as.Date("2004-01-01")) %>% 
  mutate( periods = 
            case_when (  dates >= as.Date("2018-01-01") & 
                         dates < as.Date("2018-04-01")  ~ "2018 Q1" ,
                         dates >= as.Date("2018-04-01") ~ "2018 Q2" ,
                         TRUE ~ "Before 2018"
                      )
        )

my_dep_var <- sym( "US Dollar Index" )


out_tidy <- df %>% 
  spread( variables, values ) %>% 
  gather( variables, values, -dates, -periods , -!!my_dep_var ) %>% 
  mutate( dependent = quo_name( my_dep_var )) %>% 
  # select( - !!my_dep_var) %>% 
  group_by( dependent ,variables, periods ) %>% 
  nest() %>%
  # Create a "param" column to pass to `fn`.
  mutate(params = purrr::transpose(list(
    "data" =  data ,
    "yvar" = dependent,
    "xvar" = variables ))
  ) %>% 
  mutate( fn =   replicate( list( fit_model ) , n= n()) ) %>% 
  mutate( model  = purrr::invoke_map(fn, params) ,
          tidied = map(model, tidy, conf.int = TRUE)) 


out_tidy <- out_tidy  %>%
  mutate( augumented = map( model, augment), 
          glanced = map( model, glance)
  )

out_tidy <- out_tidy  %>%
  mutate( 
    adj.r.squared = map_dbl(model, ~ signif(summary(.x)$adj.r.squared, 5)),
    intercept = map_dbl(model, ~ signif(.x$coef[[1]],5)),
    slope = map_dbl(model, ~ signif(.x$coef[[2]], 5)),
    pvalue = map_dbl(model, ~ signif(summary(.x)$coef[2,4], 5))
  ) 


p <- df %>% 
  filter( variables %in% c( quo_name(my_indep_var), quo_name(my_dep_var) )) %>% 
  spread( variables, values) %>% 
  na.omit() %>% 
  ggplot( mapping = aes( y = !!my_dep_var  , x =  !!my_indep_var ) ) 

p + geom_point( alpha = 0.3 ) + #  aes( color = periods  ) ,
  geom_smooth(method = "lm" , se = FALSE, color = "gray80") +
  # facet_wrap( ~variables ) +
  scale_color_mycol(palette = "main") +
#  scale_y_percent( ) +
 # scale_x_percent( ) +
  theme_minimal() + theme_ipsum() +
  theme( legend.position = "top") +
  labs( title = my_title ,
        subtitle =  my_subtitle ,
        color = "Period: ",
        caption= my_caption  ) +
  NULL


out_tidy %>%
  mutate( label = paste("Adj R2 = ", adj.r.squared, "\n",
                        "Intercept =",intercept, "\n",
                        "Slope =", slope, "\n",
                        "P =", pvalue)
  ) %>% 
  mutate(
   
    pics =  map2( data, label, ~{
      .x %>% 
        ggplot( aes( values , `US Dollar Index` ) ) +
        geom_point() +
        geom_smooth(se = FALSE, method = "lm") +
        geom_text(aes(x=-Inf,y=+Inf,hjust="inward", label = .y)) 
    
    }
    )
  ) # %>% pull( pics)


# r square review
out_tidy %>% 
  mutate( row_label = map2( variables,  periods , ~{ cbind(.x,.y)} )) %>%
  mutate( glanced = map2( row_label, glanced, ~{ cbind(.x,.y)} )) %>%
  pull(glanced) %>% 
  bind_rows %>% 
  arrange( desc( adj.r.squared) ) %>% 
#  mutate( adj.r.squared = 100* adj.r.squared) %>% 
  knitr::kable()




```




```{r reg_table_1,  fig.fullwidth = TRUE, results = "asis", echo=FALSE, warning = FALSE, cache = FALSE}




#*****************************************************************
# coefficient plots
#******************************************************************


my_title <- "Estimates of the association between relative share market performance and US Dollar strength, pooled by different indices" 



p <- out_tidy %>%
  unnest(tidied, .drop = TRUE) %>%
  filter( !term %in% "(Intercept)") %>% 
  ggplot(data = .,
         mapping = aes(x = variables , y = estimate,
                       ymin = conf.low , # estimate - 2*std.error,
                       ymax = conf.high, #estimate + 2*std.error,
                       group = variables , color = variables ))

p + geom_pointrange(position = position_dodge(width = 2)) +
  # scale_x_discrete(breaks = unique(df$periods)) + 
  # scale_color_manual( values = select_colors_scale ) +
  theme_minimal() + theme_ipsum() +
  labs(title = my_title %>% str_wrap() , 
       x = "Study Period", y = "Estimate", color = "Index") + 
  theme(legend.position = "none") +
  NULL

out_tidy %>% 
  # filter(  variables  %in% "Broad US Dollar Index" ) %>% 
  pull( model ) %>% 
  stargazer::stargazer( title= "Regression Results" ,
                        #column.labels =   out_tidy$periods   , 
                        #    covariate.labels = out_tidy$variables %>% unique(),
                        align = TRUE, type = "html"  )  #  "html"



```



## US Dollar Trend

Trade-Weighted US Dollar, DXY, ADXY all went up year-to-date in 2018.

1.  Based on yield spread, US Dollar needs to retrace somewhat.
2.  Retrace on the spread RSI movement shows that USD will rally further eventually.



```{r US_Dollar,  fig.fullwidth = TRUE ,  fig.width = 12,  echo=FALSE, warning=FALSE, cache=TRUE}

# fig.width = 12,
#*****************************************************************
# US Dollar, US 10 Year Rates, Libor-OIS
#******************************************************************

my_start_date <- "2000-01-01" %>% as.Date()
my_end_date <- today() # "2018-06-30" %>% as.Date()

# select_colors_scale <- getPalette(2)


my_review_date <- "2014-01-01" %>% as.Date()

############################################################
# First Data
############################################################

select_symbols_names <- c(  'DXY Curncy',
                            "USTWBROA Index",# US Trade Weighted Broad Dollar
                            'ADXY Index') 

select_names <- c( "US Dollar Index",
                   "Broad US Dollar Index",
                   "Asia Dollar Index")

df <- bloomberg_df %>%
  rename(variables = symbol) %>%
  filter(variables %in% select_symbols_names) %>%
  left_join(
    tibble(select_symbols_names ,select_names ) , by  = c("variables" = "select_symbols_names")
  ) %>%
  filter( between( dates ,my_start_date, my_end_date) )  %>%
  na.omit() %>%
  select(dates,values,select_names) %>%
  group_by( select_names ) %>%
  arrange(dates) %>%
  mutate( values = (values-lag(values,1))/lag(values,1)) %>%
  mutate( values = if_else( select_names %in%  "Asia Dollar Index", - values, values )) %>% 
  na.omit() %>%
  mutate( values = 100*cumprod(1+values) ) %>%
  ungroup() %>%
  spread(select_names,values) %>%
  na.locf() %>%
  gather(variables, values, -dates) %>%
  mutate( values = as.numeric(values), dates = as.Date(dates))

df <- df %>% filter( dates >= my_review_date )

my_xlim <-  my_axis_fun( df , dates ) %>% as.Date()
my_xlim[2] <- my_xlim[2] # %m+% months(16)
# my_xlim

select_colors_scale <-   c(
  nord_palettes$aurora[1] ,
  nord_palettes$aurora[4] ,
  nord_palettes$frost[3]
  
)

select_colors_scale  <- tibble(
  colors = select_colors_scale ,
  variables = c( df$variables %>% unique())
)


text_df <-  tibble( variables = select_colors_scale$variables,
                    colors = select_colors_scale$colors,
                    dates = rep(my_end_date ,3),
                    # dates = c("2008-06-26","2015-06-26", "2015-06-26") %>% as.Date(),
                    values = df %>% 
                      filter(dates == dplyr::last(dates), variables %in%  select_colors_scale$variables ) %>% 
                      pull(values))     #c(105, 115,80))


df <- df %>% mutate( variables = factor( variables, levels = text_df$variables))

#*****************************************************************
# Plot http://drawar.github.io/posts/add-borders-annotate-outside-ggplot/
#******************************************************************

my_title <- "Global Capital Flow - Demand for US Dollar"
my_caption <- "Source: Bloomberg\nNote: Asia Dollar Index is inverted to be aligned with Dollar Index.\nAll indices used a base value of 100 at the start of 2000."
my_y_lab <- "Cumulative Performance"

p <-  ggplot()+
  geom_line(data =  df , aes(x=dates,y=values, color = variables),
            alpha=1,size=1) +
  scale_color_manual(  values =select_colors_scale$colors ) +
  scale_x_date(expand = c(0,0), limits = my_xlim, date_breaks = "2 year" , date_labels = "%Y" ) +
  theme_minimal() + 
  theme_ipsum() +
  theme( plot.caption=element_text(hjust=0),
         legend.position = "top", 
         legend.title = element_blank(),
         axis.text.y.left = element_text(colour= select_colors_scale$colors[1]),
         axis.text.y.right = element_text(color =  select_colors_scale$colors[2]),
         axis.title.y = element_text(color= select_colors_scale$colors[1]),
         axis.title.y.right = element_text(color= select_colors_scale$colors[2]) ) +
  labs( title= my_title , y = my_y_lab ,
        caption= my_caption ) +
  # theme_Publication()
  NULL

p <- p %>%  # add reccesion shade
  my_area_func( recession_df ,  my_start_date )

# pic_list$usd_flow_p <- p

p
# ggsave('output_data/img/usd_flow_p.png') #, width = 16, height = 9, dpi =






```


```{r eval=FALSE, echo=FALSE}
file.edit(
  tint:::template_resources(
    'tint', '..', 'skeleton', 'skeleton.Rmd'
  )
)
```

```{r bib, include=FALSE}
# create a bib file for the R packages used in this document
knitr::write_bib(c('base', 'rmarkdown'), file = 'skeleton.bib')
```
