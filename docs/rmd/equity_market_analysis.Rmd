---
title: "Market Analysis"
subtitle: "An implementation in R Markdown"
author: "JJ Allaire, Yihui Xie, Dirk Eddelbuettel"
date: "`r Sys.Date()`"
output: tint::tintHtml
bibliography: skeleton.bib
link-citations: yes
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
library(tint)
# invalidate cache when the package version changes
knitr::opts_chunk$set(tidy = FALSE, cache.extra = packageVersion('tint'))
options(htmltools.dir.version = FALSE)

```

# Equity Market Analysis...


## Equities


### Market

The dominating theme of global markets in the final quarter of 2016 was reflation trade.  Donald Trump's presidential election win, coupled with the Republican Party sweeping both chambers, brought about the hope of a long-awaited fiscal stimulus program, a reflationary policy that will reinvigorate US economy and the financial markets.

The reflation hope helped global equity markets stage a strong rally during the final quarter of 2016.  The four most widely followed US stocks indices, the S&P 500, the Dow Jones Industrial Average, the Nasdaq Composite and the Russell 2000, hit all-time highs simultaneously. The last time all four indices hit the record high simultaneously was on New Year's Eve 1999.  After two-years of range-bound movements since the end of QE3 program, US stock markets appear to have gone through a regime change, as stocks sharply outperformed bonds.


```{r}

my_spread_plot <- function( data, key_tbl, my_start_date, my_end_date, picture_flag = TRUE ){
  
  
############################################################
# Raw Data
############################################################

df <- data %>% 
  filter( symbol %in% key_tbl$symbol ) %>% 
  left_join( key_tbl , by  = c("symbol")) %>%
  select( dates, variables, values ) %>% 
  distinct( dates,  values , .keep_all = TRUE ) %>% 
  filter( between( dates ,my_start_date, my_end_date) )  %>%
  mutate( values = log(values)) %>% 
  group_by( variables ) %>% 
  tq_transmute(
    select = values,
    mutate_fun = periodReturn,
    period = "daily",
    type = "arithmetic",
    col_rename = "values"
      ) %>% 
  ungroup() %>% 
  spread( variables, values ) %>%
  drop_na() %>% 
  mutate(  spread  =   .[[ key_tbl$variables[1] ]]  - .[[ key_tbl$variables[2] ]] ) %>% 
  gather( variables, values, - dates) %>% 
  group_by( variables ) %>% 
  arrange( dates ) %>% 
  mutate( values = cumprod( 1 + values )-1) %>% 
  ungroup() %>% 
  mutate( category = if_else( variables %in% "spread", "Spread", "Price"))





#*****************************************************************
# Plot http://drawar.github.io/posts/add-borders-annotate-outside-ggplot/
#******************************************************************

if( picture_flag ){
  
  # plot
my_title <- ""
my_subtitle <- str_glue("Relative Returns between {key_tbl$variables[1]} & {key_tbl$variables[2]}")
my_caption <- "Source: Bloomberg"
my_y_lab <- "Percent"


my_xlim <-  my_axis_fun( df , dates ) %>% as.Date()
# my_xlim[2] <- my_xlim[2]  %m+% months(6)
# my_xlim


my_colors <- distinct(df, variables) %>% 
  nrow() %>% 
  my_pal("main")(.) 

my_colors <- my_colors %>%  
  set_names( distinct(df, variables) %>% pull )

p_1 <- filter(df , category %in% "Spread") %>% 
  ggplot( )+
  geom_line(  aes(x=dates,y=values, color = variables), alpha=.8, size=1.2) +
  geom_hline( yintercept = filter(df , category %in% "Spread") %>% tail(1) %>% pull(values) , linetype = 2, color = nord_palettes$polarnight[3], size = 1.1) +
  scale_x_date( limits = c(my_xlim[1] , my_xlim[2]) , expand =  c(0,0)) +
  #  scale_x_date(date_breaks = "1 year" , limits = c(my_xlim[1] , my_xlim[2]), date_labels = "%Y" ) +
  scale_y_continuous( label=scales::percent ) +
  scale_color_manual(  values = my_colors["spread"] ) +
  theme_minimal() + theme_ipsum() + 
  labs(  subtitle = my_subtitle, x="",y="" ) +
  theme(   legend.title = element_blank(),
           legend.position = "none",
           plot.margin=unit(c(20,0,0,0),"mm")) +
  NULL

p_1  <- p_1  %>%  # add reccesion shade
  my_area_func( recession_df ,  my_start_date )



p_2 <-     df %>% 
  filter( !category %in% "Spread") %>% 
  ggplot( )+
  geom_line(  aes(x=dates,y=values, color = variables), alpha=.8, size=1.2) +
  scale_x_date( limits = c(my_xlim[1] , my_xlim[2]) , expand =  c(0,0)) +
  #  scale_x_date(date_breaks = "1 year" , limits = c(my_xlim[1] , my_xlim[2]), date_labels = "%Y" ) +
  scale_y_continuous( label=scales::percent ) +
  scale_color_manual(  values = my_colors[ !names(my_colors) %in% "spread"] ) +
  labs( title= waiver(), subtitle = waiver(), caption = my_caption, x="",y="" ) +
  theme_minimal() + theme_ipsum() + 
  theme(  legend.position=c(0,1), 
          legend.justification=c(0, 0),
          legend.direction="horizontal",
          legend.title = element_blank(),
          plot.margin= unit(c(10,0,0,0),"mm")) +
  NULL


p_2  <- p_2  %>%  # add reccesion shade
  my_area_func( recession_df ,  my_start_date )



p <- p_1 + p_2 + patchwork::plot_layout( ncol = 1, heights = c(3,2))

print(p)

  
  
  
}

return( if( picture_flag ){ list("data" = df, "picture" = p)} else{ list("data" = df)} )



  
}


```


```{r spread, echo=FALSE,  warning=FALSE, cache=TRUE }

############################################################
# First data parameters
############################################################

my_start_date <- "2015-01-01" %>% as.Date()
my_end_date <- today() #"2018-06-30" %>% as.Date()


############################################################
# Rate expectation
############################################################

key_tbl <- tribble(
  ~symbol ,              ~variables,
  "KRE",     "Reginal Bank",
  "IYR"      ,"REIT" 
)

df <- etf_df %>% 
  rename(values = adjusted, dates = date ) %>% 
  my_spread_plot(  key_tbl, my_start_date, my_end_date, picture_flag = FALSE ) %>% 
  pluck("data") %>% 
  filter( category %in% "Spread") %>% 
  mutate( variables = "Financial Market Outlook")

############################################################
# Rate expectation
############################################################

key_tbl <- tribble(
  ~symbol ,              ~variables,
  "XLF",     "Financial",
  "XLU"      ,"Utilities" 
)

df <- etf_df %>% 
  rename(values = adjusted, dates = date ) %>% 
  my_spread_plot(  key_tbl, my_start_date, my_end_date , picture_flag = FALSE ) %>% 
  pluck("data") %>% 
  filter( category %in% "Spread") %>% 
  mutate( variables = "Rate Expectation") %>% 
  bind_rows( df )
  
############################################################
# Economy expectation
############################################################

key_tbl <- tribble(
  ~symbol ,              ~variables,
  "XLY",     "Consumer Discretionary",
  "XLP"      ,  "Consumer Staples"
)

df <- etf_df %>% 
  rename(values = adjusted, dates = date ) %>% 
  my_spread_plot(  key_tbl, my_start_date, my_end_date , picture_flag = FALSE ) %>% 
  pluck("data") %>% 
  filter( category %in% "Spread") %>% 
  mutate( variables = "Economic Outlook") %>% 
  bind_rows( df )


############################################################
# Growth expectation
############################################################


key_tbl <- tribble(
  ~symbol ,              ~variables,
  "XLK",     "Technology",
  "XLP"      ,  "Consumer Staples"
)

df <- etf_df %>% 
  rename(values = adjusted, dates = date ) %>% 
  my_spread_plot(  key_tbl, my_start_date, my_end_date , picture_flag = FALSE ) %>% 
  pluck("data") %>% 
  filter( category %in% "Spread") %>% 
  mutate( variables = "Growth Outlook") %>% 
  bind_rows( df )

############################################################
# US vs. EM
############################################################

key_tbl <- tribble(
  ~symbol ,              ~variables,
  "EEM"      ,  "EM" ,
   "IWV",     "US"
)

df <- etf_df %>% 
  rename(values = adjusted, dates = date ) %>% 
  my_spread_plot(  key_tbl, my_start_date, my_end_date , picture_flag = FALSE ) %>% 
  pluck("data") %>% 
  filter( category %in% "Spread") %>% 
  mutate( variables = "EM Outlook") %>% 
  bind_rows( df )


ggplot( data = df) + 
  geom_line( aes( x = dates, y = values, color = variables ), size = 1.2) +
  # scale_x_date( date_breaks = "1 month", date_labels = "%B") +
  scale_y_percent() +
  scale_color_manual( values = my_pal("main")( length(unique(df$variables)))) +
  theme_ipsum() +
  labs( x = "" , y = "" , title = str_glue( "US Economic Outlook from Equity Markets"),
        subtitle = str_glue("Data as of {max( df$dates , na.rm = TRUE )}")) +
  theme( legend.position = "top" , legend.direction = "horizontal", legend.title = element_blank()) 


```




```{r Equity vs. Credit}

############################################################
# First data parameters
############################################################

my_start_date <- "2015-01-01" %>% as.Date()
my_end_date <- today() #"2018-06-30" %>% as.Date()

key_tbl  <- tribble(   ~symbol ,                     ~variables ,
                       "SPX Index" ,                   "S&P 500 Index" ,
                       'CDX IG CDSI GEN 5Y Corp', "Credit Spread")
# ,
#                     'CDX HY CDSI GEN 5Y SPRD Corp', "High Yield Spread"
df <- bloomberg_df %>% 
  filter( symbol %in% key_tbl$symbol ) %>% 
  left_join( key_tbl , by  = c("symbol")) %>%
  select( dates, variables, values ) %>% 
  filter( between( dates ,my_start_date, my_end_date) )  %>%
  mutate( values = log(values)) %>% 
  mutate( category = if_else( variables %in%  "S&P 500 Index", "Price", "Spread"))


#*****************************************************************
# Plot http://drawar.github.io/posts/add-borders-annotate-outside-ggplot/
#******************************************************************


# plot
my_title <- "Equity vs. Credit"
my_subtitle <- ""
my_caption <- "Source: Bloomberg"
my_y_lab <- "Log"


my_xlim <-  my_axis_fun( df , dates ) %>% as.Date()
# my_xlim[2] <- my_xlim[2]  %m+% months(6)
# my_xlim


my_colors <- distinct(df, variables) %>% 
  nrow() %>% 
  my_pal("main")(.) 

my_colors <- my_colors %>%  
  set_names( distinct(df, variables) %>% pull )



p <-  ggplot( data = df )+
  geom_line(  aes(x=dates,y=values, color = variables), alpha=.8, size=1.2) +
  geom_hline( data = df %>% group_by(variables)  %>%  top_n(1, dates) %>% ungroup(),  aes( yintercept = values, color = variables) , linetype = 2, color = nord_palettes$polarnight[3], size = 1.1) +
  scale_x_date( limits = c(my_xlim[1] , my_xlim[2]) , expand =  c(0,0)) +
  #  scale_x_date(date_breaks = "1 year" , limits = c(my_xlim[1] , my_xlim[2]), date_labels = "%Y" ) +
  scale_y_continuous( name = my_y_lab ) +
  facet_wrap( ~ variables , ncol = 1, scale = "free_y") +
  scale_color_manual(  values = my_colors ) +
  theme_minimal() + theme_ipsum() + 
  theme( plot.caption=element_text(hjust=0),
         legend.position = "none" , 
         legend.title = element_blank(),
        plot.margin=unit(c(10,10,10,10),"mm")) +
  labs( title= my_title, subtitle = str_glue("Data as of {max( df$dates , na.rm = TRUE )}"), caption = my_caption ) +
  NULL


p  <- p  %>%  # add reccesion shade
  my_area_func( recession_df ,  my_start_date )
p 


ggsave('output_data/img/eq_mkt.png', width = 16, height = 9, dpi = 100) #, width = 16, height = 9, dpi =


```

## Fixed Income Risk Factor Analysis


```{r  Risk Factor Analysis, warning=FALSE, cache=TRUE, echo=FALSE}


my_start_date <- "2010-01-01" %>% as.Date()
my_end_date <- today() #"2018-06-30" %>% as.Date()
my_review_date <- "2015-01-01" %>% as.Date()

select_symbols_names <- c( "DEF"   ,  "US_MKT"   ) #   "CREDIT" ,

#   "CASH"  ,   "AINF"  ,   "EINF"   ,  "US_MBS" ,   "CARRY",  "GBL_Rate"   
# select_symbols_names <- c(  "AINF"  ,   "EINF" )

select_colors_scale <- c( nord_palettes$aurora , nord_palettes$frost )[1:length(select_symbols_names)]


#   "CASH"  ,   "AINF"  ,   "EINF"   ,  "US_MBS" ,   "CARRY",  "GBL_Rate" , "LQD"  
  
my_title <- "Risk Factor"
my_subtitle <-  str_glue("Data as of {max( df$dates , na.rm = TRUE )}")
my_caption <- "Source: Bloomberg"
  
df <- riskfactors_df %>% 
  rename( variables = symbol ) %>% 
  filter(  variables  %in% select_symbols_names ) %>% 
  filter( between( dates, my_start_date, my_end_date)) %>% 
  mutate( monthf = month(dates) %>% as.factor,
          yearf = year(dates) %>% as.factor ) %>% 
  group_by(  variables , monthf, yearf) %>% 
  arrange( desc(dates) ) %>% 
  slice(  row_number() == n() ) %>% 
  ungroup() %>% 
  group_by(  variables ) %>% 
  arrange( dates  ) %>% 
  mutate( values = (values - lag(values,1))/lag(values,1)) %>% 
  drop_na( values ) %>% 
  mutate( values = scale(values )) %>% 
  ungroup()
  

# set x-axis limits
my_xlim <-  my_axis_fun( df , dates ) %>% as.Date()

my_xlim[2] <- my_xlim[2] #+ months(3)
my_xlim

text_df <- filter( df , dates == last(dates ))

p1 <- df %>% 
  filter( between(dates, my_review_date , my_end_date)) %>% 
  ggplot(aes(x= dates,y= values,color=  variables ))+
  geom_line(alpha=1, size=1.0) +
  # annotate(geom = "text", x =text_df$dates,
  #          y = text_df$values ,
  #           label = text_df$variables, 
  #          size = 5,
  #           fontface = "bold", cex = 4.5,  hjust = -.4, vjust = -.5) +
  #  scale_x_date(limits = my_xlim ) +
  scale_color_manual(values = my_pal("main")( length(unique(df$variables)))) + # ,labels =  rev(select_names)
  # facet_wrap( ~symbol, ncol = 1 , scales = "free_y") +
  theme_ipsum() +
  theme(legend.title = element_blank(),
        legend.position=c(0,.9), 
        legend.justification=c(0, 0),
        legend.direction="horizontal",
        plot.caption=element_text(hjust=0,size= rel(1.2))) +
  labs(x="",
       y= "Normalized YoY % Change",
       title= my_title, 
       subtitle = my_subtitle)

p1

p2 <- riskfactors_df %>% 
  rename( variables = symbol ) %>% 
  filter(  variables  %in% select_symbols_names ) %>% 
  filter( between( dates, my_start_date, my_end_date)) %>% 
  select(dates, spread,  variables) %>% 
  spread( variables, spread) %>%
  na.omit() %>% 
  tq_mutate_xy( x = DEF, y= US_MKT,
                mutate_fun = runCor,
                col_rename = "values",
                n = 21) %>% 
  na.omit() %>% 
  filter( between(dates, my_review_date , my_end_date)) %>% 
  ggplot() +
  geom_line( aes( x= dates, y = values), color = nord_palettes$polarnight[4]) +
  theme_ipsum() +
   theme( legend.position= "none") +
  labs(x="",
       y= "",
       title= "21-Day Rolling Correlation", 
       subtitle = NULL, 
       caption= my_caption)

p2  

p1 + p2 + plot_layout( nrow = 2)

```

### Value vs. Growth

The dominating theme of global markets in the final quarter of 2016 was reflation trade.  Donald Trump's presidential election win, coupled with the Republican Party sweeping both chambers, brought about the hope of a long-awaited fiscal stimulus program, a reflationary policy that will reinvigorate US economy and the financial markets.

The reflation hope helped global equity markets stage a strong rally during the final quarter of 2016.  The four most widely followed US stocks indices, the S&P 500, the Dow Jones Industrial Average, the Nasdaq Composite and the Russell 2000, hit all-time highs simultaneously. The last time all four indices hit the record high simultaneously was on New Year's Eve 1999.  After two-years of range-bound movements since the end of QE3 program, US stock markets appear to have gone through a regime change, as stocks sharply outperformed bonds.


```{r Equity Style Performance, echo=FALSE,  warning=FALSE, cache=TRUE }


############################################################
# First Data
############################################################

riskfactors_df %>% distinct( variables ) %>% pull


my_start_date <- "2018-01-01" %>% as.Date()
my_end_date <- today() #"2004-06-30" %>% as.Date() # 

key_tbl <- tribble(
  ~symbol ,              ~variables,
  "GBL_HML",     "Value vs. Growth",
  "GBL_SMB"      ,  "Small vs. Big"
)


df <- riskfactors_df %>% 
  filter( symbol %in% key_tbl$symbol ) %>% 
  left_join( key_tbl , by  = c("symbol")) %>%
  select( dates, variables, values ) %>% 
  filter( between( dates ,my_start_date, my_end_date) )  %>%
  mutate( values = log(values))


#*****************************************************************
# Plot http://drawar.github.io/posts/add-borders-annotate-outside-ggplot/
#******************************************************************


# plot
my_title <- "Equity Style Performance"
my_subtitle <- ""
my_caption <- "Source: Bloomberg"
my_y_lab <- "Log"


my_xlim <-  my_axis_fun( df , dates ) %>% as.Date()
# my_xlim[2] <- my_xlim[2]  %m+% months(6)
# my_xlim


my_colors <- distinct(df, variables) %>% 
  nrow() %>% 
  my_pal("main")(.) 

my_colors <- my_colors %>%  
  set_names( distinct(df, variables) %>% pull )



p <-  ggplot(  )+
  geom_line( data = df,  aes(x=dates,y=values, color = variables), alpha=.8, size=1.2) +
  geom_hline( data = df %>% group_by(variables)  %>%  top_n(1, dates) %>% ungroup(),  aes( yintercept = values, color = variables) , linetype = 2, color = nord_palettes$polarnight[3], size = 1.1) +
  scale_x_date( limits = c(my_xlim[1] , my_xlim[2]) , expand =  c(0,0)) +
  #  scale_x_date(date_breaks = "1 year" , limits = c(my_xlim[1] , my_xlim[2]), date_labels = "%Y" ) +
  scale_y_continuous( name = my_y_lab ) +
  facet_wrap( ~ variables , ncol = 1, scale = "free_y") +
  scale_color_manual(  values = my_colors ) +
  theme_minimal() + theme_ipsum() + 
  theme( plot.caption=element_text(hjust=0),
         legend.position = "none" , 
         legend.title = element_blank() #,  plot.margin=unit(c(10,0,0,0),"mm")
         ) +
  labs( title= my_title, subtitle = my_subtitle, caption = my_caption ) +
  NULL


p  <- p  %>%  # add reccesion shade
  my_area_func( recession_df ,  my_start_date )

pic_list$eq_sty <- p
p

ggsave('output_data/img/eq_sty.png', width = 16, height = 9, dpi = 100) #, width = 16, height = 9, dpi =

```

## Equity Regional Analysis



```{r Equity Regional Analysis, warning=FALSE, cache=TRUE, echo=FALSE}



my_end_date <- today()

my_start_date <- my_end_date - weeks(52*1)
my_start_date <- "2018-10-01" %>% as.Date()

select_names <- c("EEM","EWJ", "IEV", "SPY")


etf_df %>%
  filter( symbol %in% select_names ) %>% 
  filter( between( date, my_start_date  , my_end_date ) ) %>%
  group_by(names) %>%
  tq_transmute(select     = adjusted, 
               mutate_fun = periodReturn, 
               period     = "daily", 
               col_rename = "daily_returns") %>% 
  na.omit() %>% 
  mutate( performance = cumprod( 1+ daily_returns)) %>% 
  ungroup() %>% 
  ggplot(aes(x = date, y = performance , color = names)) +
  geom_line( size = 1.2 ) +
  scale_color_manual( values =  c( nord_palettes$aurora )) +
  labs(title = "Asset Class Momentum Review", 
       subtitle = "Relative Performance Comparison", 
       y = "Cumulative Performance", x = "") + 
  coord_x_date(xlim = c(my_start_date, my_end_date)) +
  theme_ipsum()  +
  theme( legend.position=c(.4,.85) ,
         legend.title = element_blank(),
         legend.direction = "vertical")




```




```{r, Equity Regional Historical Line Chart,echo=FALSE,  warning=FALSE, cache=TRUE,eval=TRUE}


#### Prepare sector information ##################################################

#*****************************************************************
#  process data parameters
#******************************************************************

my_start_date <- "2018-10-01" %>% as.Date()
my_end_date <- today() #"2018-03-31" %>% as.Date()


my_benchmark_symbol <- "IWV"
my_category <- "Equity Region"

my_benchmark_name <- etf_df %>% 
  filter( symbol %in% my_benchmark_symbol ) %>% distinct( names ) %>% pull

# extract data 
df <- etf_df %>% 
  filter( category %in% my_category | symbol %in% my_benchmark_symbol   ) %>% 
  distinct(symbol, date, .keep_all =  TRUE) %>% 
  group_by(symbol) %>%
  tq_transmute(select = adjusted,  mutate_fun = periodReturn, period = "daily") %>% 
  rename_(.dots=setNames(names(.), c('symbol','dates','values'))) %>% 
  ungroup() %>% 
  #  Key table to join human readable names to data frame
  left_join(
    etf_df %>% 
      filter( category %in% my_category | symbol %in% my_benchmark_symbol ) %>% 
      distinct( symbol,names, category) ,
    by = c( "symbol")
  ) %>% 
  mutate(symbol = as.factor(symbol)) 

#######################################################################################################


#### Prepare titles ################################################################


my_title <- str_glue("US {my_category} Performance Relative to {my_benchmark_name} Since: {min(df$dates,na.rm=TRUE)}" )
my_caption <- str_glue("Solid line is sector performance, dotted line is {my_benchmark_name} performance\nRed (blue) indicates the cumulative sector performance is higher (lower) than the benchmark")
my_subtitle <- ""

#### Make Plot ###################################################################################
#  process data 
# filter out equity sector 
eq_reg_p <- myf(df,my_benchmark_symbol,  my_start_date, my_end_date) %>% 
  my_ribbon_plotf( benchmark_name = my_benchmark_name)

eq_reg_p


ggsave('output_data/img/eq_reg_p.png', width = 16, height = 9) #, width = 16, height = 9, dpi =




```



```{r Equity Sector Historical Line Chart,echo=FALSE,  warning=FALSE, cache=TRUE,eval=TRUE}



#######################################################################################################

#######################################################################################################


my_benchmark_symbol <- "SPY"
my_benchmark_name <- etf_df %>% 
  filter( symbol %in% my_benchmark_symbol ) %>% distinct( names ) %>% pull
my_category <- "Equity Sector"

# extract data 
df <- etf_df %>% 
  filter( category %in% my_category | symbol %in% my_benchmark_symbol   ) %>% 
  distinct(symbol, date, .keep_all =  TRUE) %>% 
  group_by(symbol) %>%
  tq_transmute(select = adjusted,  mutate_fun = periodReturn, period = "daily") %>% 
  rename_(.dots=setNames(names(.), c('symbol','dates','values'))) %>% 
  ungroup() %>% 
  #  Key table to join human readable names to data frame
  left_join(
    etf_df %>% 
      filter( category %in% my_category | symbol %in% my_benchmark_symbol ) %>% 
      distinct( symbol,names, category) ,
    by = c( "symbol")
  ) %>% 
  mutate(symbol = as.factor(symbol)) 

#######################################################################################################

#*****************************************************************
#  process data parameters
#******************************************************************

my_start_date <- "2018-10-01" %>% as.Date()
my_end_date <- today() #"2018-06-30" %>% as.Date()

#### Prepare titles ################################################################


my_title <- str_glue("US {my_category} Performance Relative to {my_benchmark_name} Since: {min(df$dates,na.rm=TRUE)}" )
my_caption <- str_glue("Solid line is sector performance, dotted line is {my_benchmark_name} performance\nRed (blue) indicates the cumulative sector performance is higher (lower) than the benchmark")
my_subtitle <- ""

#### Make Plot ###################################################################################
#  process data 
# filter out equity sector 
us_eq_sec_ts_1 <- myf(df,my_benchmark_symbol,  my_start_date, my_end_date) %>% 
  my_ribbon_plotf( benchmark_name = my_benchmark_name)

us_eq_sec_ts_1






```



```{r Equity Style Historical Line Chart,echo=FALSE,  warning=FALSE, cache=TRUE,eval=TRUE}



#######################################################################################################


my_benchmark_symbol <- "IWV"
my_category <- "Equity Style"

my_benchmark_name <- etf_df %>% 
  filter( symbol %in% my_benchmark_symbol ) %>% distinct( names ) %>% pull

# extract data 
df <- etf_df %>% 
  filter( category %in% my_category | symbol %in% my_benchmark_symbol   ) %>% 
  distinct(symbol, date, .keep_all =  TRUE) %>% 
  group_by(symbol) %>%
  tq_transmute(select = adjusted,  mutate_fun = periodReturn, period = "daily") %>% 
  rename_(.dots=setNames(names(.), c('symbol','dates','values'))) %>% 
  ungroup() %>% 
  #  Key table to join human readable names to data frame
  left_join(
    etf_df %>% 
      filter( category %in% my_category | symbol %in% my_benchmark_symbol ) %>% 
      distinct( symbol,names, category) ,
    by = c( "symbol")
  ) %>% 
  mutate(symbol = as.factor(symbol)) 

#######################################################################################################

#*****************************************************************
#  process data parameters
#******************************************************************

my_start_date <- "2018-10-01" %>% as.Date()
my_end_date <- "2018-06-30" %>% as.Date()
my_end_date <-  today()
#### Prepare titles ################################################################


my_title <- str_glue("US {my_category} Performance Relative to {my_benchmark_name} Since: {min(df$dates,na.rm=TRUE)}" )
my_caption <- str_glue("Solid line is sector performance, dotted line is {my_benchmark_name} performance\nRed (blue) indicates the cumulative sector performance is higher (lower) than the benchmark")
my_subtitle <- ""

#### Make Plot ###################################################################################
#  process data 
# filter out equity sector 
us_eq_stye_ts_p <- myf(df,my_benchmark_symbol,  my_start_date, my_end_date) %>% 
    my_ribbon_plotf( benchmark_name = my_benchmark_name)

us_eq_stye_ts_p







```



## Market Analysis


```{r,Multi Asset Historical Line Chart,echo=FALSE,  warning=FALSE, cache=TRUE,eval=TRUE}


my_end_date <- today()

my_start_date <- my_end_date - weeks(52*1/4)

select_names <- c("S&P 500",  "MSCI EM",  "Commodity", "Treasury 20+ Yr ")


select_colors_scale <- nord_palettes$aurora[ 1:length(select_names ) ]


key_df <- bind_cols(names = select_names, colors = select_colors_scale )

df <- etf_df %>%
#  filter( category %in% my_category )  %>% 
   filter( names %in% select_names )  %>% 
   filter( between( date, my_start_date  , my_end_date ) ) %>%
  group_by(names) %>%
  tq_transmute(select     = adjusted, 
               mutate_fun = periodReturn, 
               period     = "daily", 
               col_rename = "daily_returns") %>% 
  na.omit() %>% 
  mutate( performance = cumprod( 1+ daily_returns)) %>% 
  ungroup() %>% 
  left_join(
    key_df, by = c("names")
  )


df <- df %>% mutate( names = fct_reorder(names, performance, .desc = TRUE) ,
                     colors = fct_reorder(colors, performance, .desc = TRUE) )

my_xlim <-  my_axis_fun( df , date ) %>% as.Date()
my_xlim[2] <- my_xlim[2] %m+% months(1)
my_xlim

text_df <- df %>% filter( date == last( date )) # %>% mutate( date = date %m+% months(1))


multi_asset_p <- df %>% 
  ggplot(aes(x = date, y = performance , color = names  )) +
  geom_line( size = 1.2 ) +
  scale_color_manual( values =  levels( df$colors  ) ) +
  scale_x_date(expand = c(0,0), limits = my_xlim ) + # , date_breaks = "2 year" , date_labels = "%Y"
  # coord_x_date(xlim = c(my_start_date, my_end_date)) +
  annotate(geom = "text",
         x = text_df$date , y = text_df$performance ,
         label = text_df$names , size = 5,
         fontface = 'bold', color = text_df$colors ,  hjust = -.5) +
  
  
  labs(title = "Asset Class Momentum Review", 
       subtitle = "Relative Performance Comparison", 
       y = "Cumulative Performance", x = "") + 

  theme_ipsum()  +
  theme( legend.position="none" ,
         legend.title = element_blank(),
         legend.direction = "horizontal")


multi_asset_p


ggsave('output_data/img/multi_asset_p.png', width = 16, height = 9) #, width = 16, height = 9, dpi =




```



```{r,Correlation Line Chart,echo=FALSE,  warning=FALSE, cache=TRUE,eval=TRUE}

# http://timelyportfolio.blogspot.com/search/label/bonds


#### Prepare sector information ##################################################


#*****************************************************************
#  process data parameters
#******************************************************************
select_colors_scale <-   c(
  nord_palettes$aurora[1] ,
  nord_palettes$frost[4]
  
)


my_end_date <- today() # "2018-03-31" %>% as.Date()

my_start_date <-my_end_date - weeks(52/1)


etf_df %>% distinct( names)

my_benchmark_symbol <-  c( "SPY" ,"TLT" )

my_benchmark_name <- etf_df %>% 
  filter( symbol %in% my_benchmark_symbol ) %>% distinct( names ) %>% pull

# extract data 
df <- etf_df %>% 
  filter(  symbol %in% my_benchmark_symbol   ) %>% 
  distinct(symbol, date, .keep_all =  TRUE) %>% 
  group_by(symbol) %>%
  tq_transmute(select = adjusted,  mutate_fun = periodReturn, period = "daily") %>% 
  rename_(.dots=setNames(names(.), c('symbol','dates','values'))) %>% 
  ungroup() %>% 
  #  Key table to join human readable names to data frame
  left_join(
    etf_df %>% 
      filter(  symbol %in% my_benchmark_symbol ) %>% 
      distinct( symbol,names, category) ,
    by = c( "symbol")
  ) %>% 
  mutate(symbol = as.factor(symbol)) %>% 
  mutate(dates = as.Date(dates)) 

perf_p <- df %>% 
  filter( between( dates, my_start_date, my_end_date) ) %>% 
  group_by(names) %>%
  na.omit() %>% 
  mutate( performance = cumprod( 1+ values)) %>% 
  ungroup() %>% 
  mutate( names = fct_reorder(names, performance, .desc = TRUE) ) %>% 
  ggplot(aes(x = dates, y = performance , color = names  )) +
  geom_line( size = 1.2 ) +
  coord_x_date(xlim = c(my_start_date, my_end_date)) +
  scale_color_manual( values =  select_colors_scale) +
  labs(title ="Asset Class Performance" ,
       subtitle = "", 
       y = "Cumulative Performance", x = "") + 
  theme_ipsum()  +
  theme(legend.position=c(0,1), legend.title = element_blank(),
        legend.justification=c(0, 0),
        legend.direction="horizontal")


df <- df %>% 
  select( symbol, dates, values) %>% 
  distinct( dates,symbol, .keep_all = TRUE) %>% 
  spread( symbol, values ) %>% 
  # set_names( c("dates" , "x" , "y")) %>% 
  na.omit() %>% 
  tq_transmute_xy(x          = SPY , 
                  y          =  TLT ,
                  mutate_fun = runCor,
                  n          = 21*1,
                  col_rename = "values") %>% 
  mutate( variables = "correlation") %>% 
  mutate( dates = as.Date(dates))


df <- df %>% 
  filter( between( dates, my_start_date, my_end_date)) %>% 
  print()
#######################################################################################################


#### Make Plot ###################################################################################
#  process data 
# filter out equity sector 


# set y-axis limits
my_ylim <- my_axis_fun( df , values )
my_ylim[1] <- my_ylim[1] - 0.005
my_ylim[2] <- my_ylim[2] + 0.005

my_ylim


# set x-axis limits
my_xlim <-  my_axis_fun( df , dates ) %>% as.Date()

my_xlim[2] <- my_xlim[2] + months(3)
my_xlim

############################################################
# Quarter-to-Quarter Growth in US Real GDP
############################################################

text_df <- filter(df, dates == last(dates))


#### Prepare titles ################################################################


my_title <- str_glue("Correlation between {my_benchmark_name[1]} and {my_benchmark_name[2]}" )
my_caption <- ""
my_subtitle <- str_glue("Current correlation is {scales::percent( text_df$values )}" )
# text_df %>% View()


corr_p  <-  ggplot() +
  geom_line(data = df, aes(x=dates, y= values ), color = nord_palettes$aurora[4], alpha= 2/3, size = 1.5 ) +
  scale_y_percent(limits= my_ylim ) +  #use scale_y_percent function from hrbrtheme
  coord_x_date(xlim = c(my_start_date, my_end_date)) +
  #scale_x_date(limits = my_xlim,date_breaks = "1 year" , date_labels = "%Y" ) +
  labs(x="",y="",
       title= my_title ,subtitle = my_subtitle, 
       caption= my_caption ) + 
  #  theme_ipsum_tw(plot_title_size = 24, subtitle_size = 12) +
  theme(plot.title = element_text(hjust = 0.5)) + # color = nord["nord14"],
  theme(plot.subtitle = element_text( hjust = 0.5)) + # color = nord["nord14"],
  theme(panel.grid = element_blank()) +
  scale_color_manual( values = select_colors_scale[1]) +
  # scale_colour_gradientn(colours= select_colors_scale ) +
  # scale_fill_gradientn(colours= select_colors_scale  ) +
  # theme(  legend.position = "none",
  #        plot.caption=element_text(hjust=0)) +
  theme_ipsum()

corr_p  <- corr_p   %>%
  # add reccesion shade
  my_area_func( recession_df ,  my_start_date )

pic_list$corr_p  <- corr_p 

ggsave('output_data/img/corr_p.png', width = 16, height = 9) #, width = 16, height = 9, dpi =

perf_p + corr_p + plot_layout(ncol = 1)


```




## US Equity Market Risk Pricing Analysis


```{r  US Equity Market Risk Chart, warning=FALSE, cache=TRUE}



my_start_date <- "2017-07-01" %>% as.Date()
my_end_date <- today() #"2018-06-30" %>% as.Date()

# select_colors_scale <- getPalette(2)

select_colors_scale <-   c(


  nord_palettes$aurora[1],
    nord_palettes$frost[4] 
)

############################################################
# First Data
############################################################

# Monetary_Symbols_Names
# select interested variables
select_symbols_names <- c( "SPX Index" ) # MSCI ACWI Net TR USD Index
# 'CSFB.Index'

select_names <- c('S&P 500')


df1 <- bloomberg_df %>%
  rename(variables = symbol) %>%
  filter(variables %in% select_symbols_names) %>%
  left_join(
    tibble(select_symbols_names ,select_names ) , by  = c("variables" = "select_symbols_names")
  ) %>%
  filter( between( dates ,my_start_date, my_end_date) )  %>%
  na.omit() %>% 
  select( dates, variables, values) 
#*****************************************************************
# Second Data
#******************************************************************


select_symbols_names <- c( "UX1 Index" , # MSCI ACWI Banks Index
                           'UX2 Index') # MSCI ACWI Net TR USD Index


select_names <- c( "UX1",
                   "UX2")


df2 <- bloomberg_df %>%
  rename(variables = symbol) %>%
  filter(variables %in% select_symbols_names) %>%
  left_join(
    tibble(select_symbols_names ,select_names ) , by  = c("variables" = "select_symbols_names")
  ) %>%
  filter( between( dates ,my_start_date, my_end_date) )  %>%
  na.omit() %>%
  select(dates,values, select_names) %>%
  spread(select_names,values ) %>%
  mutate( `Vix Term Premium` = .[["UX1"]]  - .[[ "UX2"]] ) %>%
  gather(variables, values, -dates) %>%
  filter(variables %in% "Vix Term Premium") %>% 
  na.omit()



my_xlim <-  my_axis_fun( df1 , dates ) %>% as.Date()
# my_xlim[2] <- my_xlim[2] %m+% months(12)
my_xlim

# Normalizer to bring 2nd data into 1st data range. This makes
# highest bar equal to highest point. You can use a different
# normalization if you want (e.g., this could be the constant 15
# like you had in your example, though that's fragile if the data
# changes).
normalizer <- max(df1$values) / max(df2$values)

text_df <-  tibble( dates = as.Date("2017-01-01"), values = 120 ,variables = "VVIX Index") %>%
  bind_rows(
    tibble( dates = as.Date("2017-01-01") , values = 2.6 ,variables =  "VIX Term Premium")
    
  )


my_title <- "US Equity Market Risk Pricing"
my_caption <- "Source: CBOE"
my_y_lab <- "Percent"

p <- df1 %>% 
  select( one_of( names( df2 ))) %>% 
  bind_rows( df2) %>%
  ggplot() +
  geom_line(aes(x=dates,y=values,color=variables),
            alpha=1, size=1) +
  scale_color_manual( values = select_colors_scale ) + 
  # scale_x_date(date_breaks = "1 year", date_labels = "%Y") +
  scale_y_continuous(  name = my_y_lab ) +
  facet_wrap( ~variables, ncol = 1 , scale = "free_y") +
  theme_minimal() + theme_ipsum() +
  theme( legend.position = "none" ) +
  labs( title= my_title ,
        caption= my_caption ) +
  # theme_Publication()
  NULL


#*****************************************************************
# Plot http://drawar.github.io/posts/add-borders-annotate-outside-ggplot/
#******************************************************************

pic_list$us_eq_risk_p <- p

p

ggsave('output_data/img/us_eq_risk_p.png') #, width = 16, height = 9, dpi =





```

## Fear Factor Index

The CS Fear Barometer measures investor sentiment for 3-month investment horizons by pricing a zero-cost collar. The collar is implemented by the selling of a 10% OTM SPX call option and using the proceeds to buy an OTM put. The CSFB level represents how far out-of-the-money that SPX put is

Translated, this means the higher the level of CSFB, the higher the fear, or rather that investors are more willing to sacrifice potential upside gains on their investments by putting money into hedges as a way of protection instead of participating directly in further Market gains.

```{r  US Equity Market Trader Chart, warning=FALSE, cache=TRUE}




my_start_date <- "2018-01-01" %>% as.Date()
my_end_date <- today() #"2018-06-30" %>% as.Date()

# select_colors_scale <- getPalette(2)

select_colors_scale <- c(
  
  nord_palettes$frost[4],
  nord_palettes$aurora[1] 
  
)

############################################################
# First Data
############################################################

# Monetary_Symbols_Names
# select interested variables
select_symbols_names <- c('CSFB Index' ) # MSCI ACWI Net TR USD Index

select_names <- c('CREDIT SUISSE FEAR BAROMETER')


df1 <- bloomberg_df %>%
  rename(variables = symbol) %>%
  filter(variables %in% select_symbols_names) %>%
  left_join(
    tibble(select_symbols_names ,select_names ) , by  = c("variables" = "select_symbols_names")
  ) %>%
  filter( between( dates ,my_start_date, my_end_date) )  %>%
  na.omit() %>% 
  select( dates, select_names, values) %>% 
  rename( variables = select_names)



my_xlim <-  my_axis_fun( df1 , dates ) %>% as.Date()
# my_xlim[2] <- my_xlim[2] %m+% months(12)
my_xlim



#*****************************************************************
# Plot http://drawar.github.io/posts/add-borders-annotate-outside-ggplot/
#******************************************************************

my_title <- "US Equity Market Fear Barometer"

my_sub_title <- "The higher the level of CSFB, the higher the fear, or rather that investors are more willing to sacrifice potential upside gains on their investments\nby putting money into hedges as a way of protection instead of participating directly in further Market gains."

my_caption <- "Source: Bloomberg"
my_y_lab <- "Percent"

p <-  ggplot()+
  #geom_rect(data=  filter(recession_df, start >=  min(df1$dates, na.rm =TRUE )) ,
   #         aes(xmin= start, xmax= end, ymin=-Inf, ymax=+Inf),
  #          fill="gray", alpha=0.35) +
  # geom_col(data = df1, aes(x=dates, y= values ,fill= values ,color= values ),alpha= 2/3 ) +
   geom_line(data = df1, aes(x= dates,y=values,color = variables),   alpha=1 ,size=1) +
   coord_x_date(xlim = c(my_end_date -days(365), my_end_date)) +
  scale_color_manual( values = select_colors_scale[1]) +
  #scale_colour_gradientn(colours= select_colors_scale ) +
  #scale_fill_gradientn(colours= select_colors_scale  ) +
  # scale_x_date(date_breaks = "1 year", date_labels = "%Y") +
  theme_minimal() + theme_ipsum() +
  theme(plot.caption=element_text(hjust=0), 
        legend.position = "none" ) +
  labs( title= my_title ,subtitle = my_sub_title,
        caption= my_caption) +
  # theme_Publication()
  NULL

pic_list$us_eq_fear_p <- p

p

ggsave('output_data/img/us_eq_fear_p.png') #, width = 16, height = 9, dpi =





```




## US Equity Market Trader Analysis

ne piece of evidence is the percentage of stocks on the New York Stock Exchange trading below their 200-day moving average, 
indicating their trending direction has turned downward.

Bloomberg has an index that tracks this, called Tradpaus.



```{r  US Equity Market Internal Chart, warning=FALSE, cache=TRUE}



# When Tradpaus moves below 50, it is saying fewer stocks are supporting the overall index and our analysis shows, 
# such deterioration historically results in the S&P 500 ultimately # falling below its 200-day ???? this happened 23 of 24 times, Lee wrote.



my_start_date <- "2015-01-01" %>% as.Date()
my_end_date <- today() #"2018-06-30" %>% as.Date()

# select_colors_scale <- getPalette(2)

select_colors_scale <-   c(

  nord_palettes$frost[4] ,
  nord_palettes$aurora[1]
)

############################################################
# First Data
############################################################

# Monetary_Symbols_Names
# select interested variables
select_symbols_names <- c('TRADPAUS Index' ) # MSCI ACWI Net TR USD Index

select_names <- c('Market Internal')


df1 <- bloomberg_df %>%
  rename(variables = symbol) %>%
  filter(variables %in% select_symbols_names) %>%
  left_join(
    tibble(select_symbols_names ,select_names ) , by  = c("variables" = "select_symbols_names")
  ) %>%
  filter( between( dates ,my_start_date, my_end_date) )  %>%
  na.omit() %>% 
  select( dates, select_names, values) %>% 
  rename( variables = select_names)



my_xlim <-  my_axis_fun( df1 , dates ) %>% as.Date()
# my_xlim[2] <- my_xlim[2] %m+% months(12)
my_xlim



#*****************************************************************
# Plot http://drawar.github.io/posts/add-borders-annotate-outside-ggplot/
#******************************************************************

my_title <- "US Equity Market Internal Analysis"

my_sub_title <- "When the index moves below 50, it is saying fewer stocks are supporting the overall index and our analysis shows, 
such deterioration historically results in the S&P 500 ultimately falling below its 200-day ???? this happened 23 of 24 times."

my_caption <- "Source: Bloomberg"
my_y_lab <- "Percent"

p <-  ggplot()+
  # geom_rect(data=  filter(recession_df, start >=  min(df1$dates, na.rm =TRUE )) ,
   #          aes(xmin= start, xmax= end, ymin=-Inf, ymax=+Inf),
  #           fill="gray", alpha=0.35) +
  geom_line(data = df1, aes(x= dates,y=values,color = variables),
            alpha=1 ,size=1) +
  geom_hline( yintercept = 50 , color = select_colors_scale[1], size = 1.5)+
  scale_color_manual( values = select_colors_scale[2]) +
  # scale_x_date(date_breaks = "1 year", date_labels = "%Y") +
  theme_minimal() + theme_ipsum() +
  theme(plot.caption=element_text(hjust=0), 
        legend.position = "none" ) +
  labs( title= my_title ,subtitle = my_sub_title,
        caption= my_caption) +
  # theme_Publication()
  NULL

pic_list$us_eq_internal_p <- p

p

ggsave('output_data/img/us_eq_internal_p.png') #, width = 16, height = 9, dpi =





```



```{r  US Equity Trader Sentiment Chart, warning=FALSE, cache=TRUE}



# When Tradpaus moves below 50, it is saying fewer stocks are supporting the overall index and our analysis shows, 
# such deterioration historically results in the S&P 500 ultimately # falling below its 200-day ???? this happened 23 of 24 times, Lee wrote.



my_start_date <- "2018-01-01" %>% as.Date()
my_end_date <- today() #"2018-06-30" %>% as.Date()

# select_colors_scale <- getPalette(2)

select_colors_scale <-   c(

  nord_palettes$frost[4] ,
  nord_palettes$aurora[1]
)

############################################################
# First Data
############################################################

# Monetary_Symbols_Names
# select interested variables
select_symbols_names <- c('.BULLBEAR Index' ) # MSCI ACWI Net TR USD Index

select_names <- c( "Bullish Sentiment")


df1 <- bloomberg_df %>%
  rename(variables = symbol) %>%
  filter(variables %in% select_symbols_names) %>%
  left_join(
    tibble(select_symbols_names ,select_names ) , by  = c("variables" = "select_symbols_names")
  ) %>%
  filter( between( dates ,my_start_date, my_end_date) )  %>%
  na.omit() %>% 
  select( dates, select_names, values) %>% 
  rename( variables = select_names)



my_xlim <-  my_axis_fun( df1 , dates ) %>% as.Date()
# my_xlim[2] <- my_xlim[2] %m+% months(12)
my_xlim



#*****************************************************************
# Plot http://drawar.github.io/posts/add-borders-annotate-outside-ggplot/
#******************************************************************

my_title <- "US Equity Market Sentiment Analysis"

my_sub_title <- ""

my_caption <- "Source: Bloomberg"
my_y_lab <- "Percent"

p <-  ggplot()+
   # geom_rect(data=  filter(recession_df, start >=  min(df1$dates, na.rm =TRUE )) ,
   #           aes(xmin= start, xmax= end, ymin=-Inf, ymax=+Inf),
    #          fill="gray", alpha=0.35) +
  geom_line( data = df1, aes(x= dates,y=values,color = variables, fill = variables), stat = "identity" ) +
 # geom_line(data = df1, aes(x= dates,y=values,color = variables),          alpha=1 ,size=1) +
  geom_hline( yintercept = 0 , color = select_colors_scale[1], size = 1.5)+
  scale_color_manual( values = select_colors_scale[2]) +
  # scale_x_date(date_breaks = "1 year", date_labels = "%Y") +
  theme_minimal() + theme_ipsum() +
  theme(plot.caption=element_text(hjust=0), 
        legend.position = "none" ) +
  labs( title= my_title ,subtitle = my_sub_title,
        caption= my_caption) +
  # theme_Publication()
  NULL

pic_list$us_eq_sent_p <- p

p

ggsave('output_data/img/us_eq_sent_p.png') #, width = 16, height = 9, dpi =





```



## Fixed Income Risk Factor Analysis


```{r Fixed Income Risk Factor Analysis, warning=FALSE, cache=TRUE, echo=FALSE}



select_symbols_names <- c( "DEF"   ,   "CREDIT" ,  "US_MBS",  "GBL_HY" ,  "EMBI"    )

#   "CASH"  ,   "AINF"  ,   "EINF"   ,  "US_MBS" ,   "CARRY",  "GBL_Rate"   
# select_symbols_names <- c(  "AINF"  ,   "EINF" )

select_colors_scale <- c( nord_palettes$aurora , nord_palettes$frost )[1:length(select_symbols_names)]


#   "CASH"  ,   "AINF"  ,   "EINF"   ,  "US_MBS" ,   "CARRY",  "GBL_Rate" , "LQD"  
  
my_title <- "Fixed Income Risk Factor"
my_subtitle <- "Credit Market"
my_caption <- "Source: Zephyr Associates Inc and Morningstar"
  
df <- riskfactors_df %>% 
  filter( symbol %in% select_symbols_names ) %>% 
  filter( between( dates, my_start_date, my_end_date))

# set x-axis limits
my_xlim <-  my_axis_fun( df , dates ) %>% as.Date()

my_xlim[2] <- my_xlim[2] + months(3)
my_xlim

text_df <- filter( df , dates == last(dates ))

p <- df %>% 
  ggplot(aes(x= dates,y= values,color= symbol ))+
  geom_line(alpha=1, size=1.2) +
  # annotate(geom = "text", x =text_df$dates,
  #          y = text_df$values ,
  #           label = text_df$variables, 
  #          size = 5,
  #           fontface = "bold", cex = 4.5,  hjust = -.4, vjust = -.5) +
  #  scale_x_date(limits = my_xlim ) +
  scale_color_manual(values = select_colors_scale) + # ,labels =  rev(select_names)
  facet_wrap( ~symbol,  scales = "free_y") +
  theme_ipsum() +
  theme(legend.title = element_blank(),
        legend.position= "none" ) +
  labs(x="",
       y= "Cumulative Performance",
       title= my_title, 
       subtitle = my_subtitle, 
       caption= my_caption)

p


```


```{r Fixed Income Analysis, warning=FALSE, cache=TRUE, echo=FALSE}



my_end_date <- today()

my_start_date <- my_end_date - weeks(52*1/2)

select_names <- c("Treasury 20+ Yr ","US High Yield")

etf_df %>%
  filter( names %in% select_names ) %>% 
  filter( between( date, my_start_date  , my_end_date ) ) %>%
  ggplot(aes(x = date, y = close, volume = volume, group = symbol)) +
  geom_candlestick(aes(open = open, high = high, low = low, close = close)) +
  geom_ma(ma_fun = SMA, n = 20, wilder = TRUE, linetype = 5) +
  geom_ma(ma_fun = SMA, n = 200, wilder = TRUE, color = "red") + 
  labs(title = "Fixed Income Class Review", 
       subtitle = "50 and 200-Day EMA", 
       y = "Closing Price", x = "") + 
  coord_x_date(xlim = c(my_start_date, my_end_date)) +
  facet_wrap(~ names, ncol = 1, scales = "free_y") + 
  theme_ipsum()




etf_df %>%
  filter( names %in% select_names ) %>% 
  filter( between( date, my_start_date  , my_end_date ) ) %>%
  group_by(symbol) %>%
  tq_transmute(select     = adjusted, 
               mutate_fun = periodReturn, 
               period     = "daily", 
               col_rename = "daily_returns") %>% 
  na.omit() %>% 
  mutate( performance = cumprod( 1+ daily_returns)) %>% 
  ungroup() %>% 
  ggplot(aes(x = date, y = performance , color = symbol)) +
  geom_line( size = 1.2 ) +
  scale_color_manual( values =  c( nord_palettes$aurora[1], nord_palettes$frost[4] )) +
  labs(title = "Asset Class Momentum Review", 
       subtitle = "Relative Performance Comparison", 
       y = "Cumulative Performance", x = "") + 
  coord_x_date(xlim = c(my_start_date, my_end_date)) +
  theme_ipsum()  +
  theme( legend.position=c(.7,.85) ,
         legend.title = element_blank(),
         legend.direction = "vertical")





```


## Real Yield


```{r}





my_start_date <- "2015-01-01" %>% as.Date()
my_end_date <- today() #"2018-06-30" %>% as.Date()

key_tbl  <- tribble(   ~symbol ,                     ~variables ,
                       "BCIT5Y Index"  ,                   "Bloomberg Barclays US Inflation Linked 7 to 10 Years Avg Real Yield Annual" )

df <- bloomberg_df %>% 
  filter( symbol %in% key_tbl$symbol ) %>% 
  left_join( key_tbl , by  = c("symbol")) %>%
  select( dates, variables, values ) %>% 
  filter( between( dates ,my_start_date, my_end_date) )  %>%
  mutate( values = (values)) 


#*****************************************************************
# Plot http://drawar.github.io/posts/add-borders-annotate-outside-ggplot/
#******************************************************************


# plot
my_title <- "Bloomberg Barclays US Inflation Linked 7 to 10 Years Avg Real Yield Annual"
my_subtitle <- ""
my_caption <- "Source: Bloomberg"
my_y_lab <- ""


my_xlim <-  my_axis_fun( df , dates ) %>% as.Date()
# my_xlim[2] <- my_xlim[2]  %m+% months(6)
# my_xlim


my_colors <- distinct(df, variables) %>% 
  nrow() %>% 
  my_pal("main")(.) 

my_colors <- my_colors %>%  
  set_names( distinct(df, variables) %>% pull )



p <-  ggplot( data = df )+
  geom_line(  aes(x=dates,y=values, color = variables), alpha=.8, size=1.2) +
  geom_hline( data = df %>% group_by(variables)  %>%  top_n(1, dates) %>% ungroup(),  aes( yintercept = values, color = variables) , linetype = 2, color = nord_palettes$polarnight[3], size = 1.1) +
  scale_x_date( limits = c(my_xlim[1] , my_xlim[2]) , expand =  c(0,0)) +
  #  scale_x_date(date_breaks = "1 year" , limits = c(my_xlim[1] , my_xlim[2]), date_labels = "%Y" ) +
  scale_y_continuous( name = my_y_lab ) +
  facet_wrap( ~ variables , ncol = 1, scale = "free_y") +
  scale_color_manual(  values = my_colors ) +
  theme_minimal() + theme_ipsum() + 
  theme( plot.caption=element_text(hjust=0),
         legend.position = "none" , 
         legend.title = element_blank(),
         plot.margin=unit(c(10,10,10,10),"mm")) +
  labs( title= my_title, subtitle = my_subtitle, caption = my_caption ) +
  NULL

p


```

## Inflation Expectation

```{r Inflation Expectation,  warning=FALSE, cache=TRUE, echo=FALSE, eval = FALSE}





my_end_date <- today() #"2018-06-30" %>% as.Date()

my_start_date <- "2018-04-01" %>% as.Date() #
# my_start_date <-  my_end_date - weeks(52/1)



############################################################
# First Data
############################################################


select_symbols <- c(    'USGG10YR Index', 'USGGBE10 Index' ,'USGG5Y5Y Index') 


select_symbols_names <- c( "Nominal 10 Year Treasury Rate",  
                           "10 Year Breakeven Inflation Rate",
                           "5/5 Year Forward Breakeven Inflation Rate") 

# "Australia")
select_colors_scale <-   c(
  
  nord_palettes$frost[4] ,
  nord_palettes$frost[2]  ,
  nord_palettes$aurora[1] 
)




df <- bloomberg_df %>%
  filter(symbol %in% select_symbols ) %>%
  filter( between( dates, my_start_date, my_end_date)) %>% 
  left_join(
    tibble(select_symbols_names ,select_symbols ) , by  = c("symbol" = "select_symbols")
  ) %>% 
  mutate(values = values/100) 



text_df <-  df %>% filter( dates == last(dates))



my_xlim <-  my_axis_fun( df , dates ) %>% as.Date()
my_xlim <-  my_xlim + months(3)

#*****************************************************************
# Plot http://drawar.github.io/posts/add-borders-annotate-outside-ggplot/
#******************************************************************

my_title <- "US Market-Based Inflation Expectation "
my_subtitle <- "" # 10 Year Breakeven Inflation Rate
my_y_lab <- "Percent"
my_x_lab <- "Date"

p <-  ggplot()+
  geom_line(data = df , aes(x=dates,y=values, color = select_symbols_names ),
            alpha=1,size=1) +
  
  scale_color_manual(  values = select_colors_scale ) +
  scale_x_date(name = my_x_lab  ) +
  scale_y_continuous( name = my_y_lab ,label=scales::percent) +
  facet_wrap( ~ select_symbols_names, ncol = 1, scale = "free_y") +
  theme_minimal() + theme_ipsum() +
  theme( plot.caption=element_text(hjust=0),
         legend.position = "none",
         axis.text.y.left = element_text(colour= select_colors_scale[1]),
         axis.title.y = element_text(color= select_colors_scale[1])) +
  labs( title= my_title,
        subtitle = my_subtitle) +
  # theme_Publication()
  NULL

p <- p %>%  # add reccesion shade
  my_area_func( recession_df ,  my_start_date )

pic_list$inf_exp_p <- p

p
ggsave('output_data/img/inf_exp_p.png') #, width = 16, height = 9, dpi =




```


In terms of sector performance, as interest rates spiked during the quarter, most of the fixed sectors generated negative returns.  With the hope of economic expansion, however, credit spread has tightened and sectors with credit components were able to return positive performance.
As shown in the Fixed Income Sector Performance chart, high yield securities performed relatively well, followed by ABS securities. The government securities performed worst with -3.72% for the quarter.





```{r Fixed Income Sector Performance Chart,echo=FALSE,  warning=FALSE, cache=TRUE,eval=FALSE}



#*****************************************************************
#  process data parameters
#******************************************************************

my_start_date <- "2017-12-31" %>% as.Date()
my_end_date <- today() # "2018-06-30"  %>% as.Date()  #today()  "2018-03-31" %>% as.Date()

# extract data
df <- etf_df %>%
  group_by( symbol ) %>% 
  as_tbl_time(index = date) %>% 
  as_period( period = "1 q" , side = "end") %>%   
  tq_transmute( select  = adjusted, mutate_fun = ROC, type =  "discrete" ,col_rename = "returns") %>%
  filter( between( date, my_start_date, my_end_date ) ) %>%
  ungroup()  

#### Prepare sector information ##################################################


df <- df %>% 
  
  left_join(
    
    etf_df %>% select( symbol, category, names),
    
    by = "symbol"
  ) %>% 
  filter( category %in% "Fixed Sector") %>% 
  distinct(symbol, date, .keep_all =  TRUE) 



#### Prepare Color information ##################################################


select_colors_scale <-  select_colors_scale <- c(
  
  nord_palettes$aurora[1] ,
  
  nord_palettes$aurora[4] 
  
)




# set y-axis limits
my_ylim <- my_axis_fun( df , returns )
my_ylim[1] <- my_ylim[1] - 0.01
my_ylim[2] <- my_ylim[2] + 0.01

my_ylim






#### Prepare titles ################################################################

my_title <- str_c("Fixed Income Sector Performance Since 2016-Q4")
my_subtitle <- "2018-Q2 Performance"
my_caption <- "Source: Zephyr Associates Inc and Morningstar"


#### Make Plot ###################################################################################


# fix(my_bar_plot_fnc)

fix_sec_p <- my_bar_plot_fnc( df ,  "names"  , "returns", select_colors_scale , 
                              my_title  = my_title, my_caption = my_caption )
#######################################################################################################

# create diverging barcharts


fix_sec_p

ggsave('output_data/img/fix_sec_p.png', width = 16, height = 9) #, width = 16, height = 9, dpi =




```


```{r Fixed Income Sector Historical Line Chart,echo=FALSE,  warning=FALSE, cache=TRUE,eval=TRUE}



#######################################################################################################



my_benchmark_symbol <- "AGG"
my_category <- "Fixed Sector"

my_benchmark_name <- etf_df %>% 
  filter( symbol %in% my_benchmark_symbol ) %>% distinct( names ) %>% pull

# extract data 
df <- etf_df %>% 
  filter( category %in% my_category | symbol %in% my_benchmark_symbol   ) %>% 
  distinct(symbol, date, .keep_all =  TRUE) %>% 
  group_by(symbol) %>%
  tq_transmute(select = adjusted,  mutate_fun = periodReturn, period = "daily") %>% 
  rename_(.dots=setNames(names(.), c('symbol','dates','values'))) %>% 
  ungroup() %>% 
  #  Key table to join human readable names to data frame
  left_join(
    etf_df %>% 
      filter( category %in% my_category | symbol %in% my_benchmark_symbol ) %>% 
      distinct( symbol,names, category) ,
    by = c( "symbol")
  ) %>% 
  mutate(symbol = as.factor(symbol)) 

#######################################################################################################

#*****************************************************************
#  process data parameters
#******************************************************************

my_start_date <- "2018-01-01" %>% as.Date()
my_end_date <- "2018-03-31" %>% as.Date()

#### Prepare titles ################################################################


my_title <- str_glue("US {my_category} Performance Relative to {my_benchmark_name} Since: {min(df$dates,na.rm=TRUE)}" )
my_caption <- str_glue("Solid line is sector performance, dotted line is {my_benchmark_name} performance\nRed (blue) indicates the cumulative sector performance is higher (lower) than the benchmark")
my_subtitle <- ""

#### Make Plot ###################################################################################
#  process data 
# filter out equity sector 
us_fixed_sector_ts_p <- myf(df,my_benchmark_symbol,  my_start_date, my_end_date) %>% 
    my_ribbon_plotf( benchmark_name = my_benchmark_name)

us_fixed_sector_ts_p




```


```{r eval=FALSE}
file.edit(
  tint:::template_resources(
    'tint', '..', 'skeleton', 'skeleton.Rmd'
  )
)
```

```{r bib, include=FALSE}
# create a bib file for the R packages used in this document
knitr::write_bib(c('base', 'rmarkdown'), file = 'skeleton.bib')
```

