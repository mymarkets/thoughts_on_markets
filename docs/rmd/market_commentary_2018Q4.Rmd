---
  title: "Market Commentary"
author: "Hyungjin Lim"
date: "2018³â 4¿ù 6ÀÏ"
output: word_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Global Yield Spread




```{r yield_spread, fig.width= 10 , fig.height=4, cache=TRUE, echo=FALSE}


# http://www.prerequisite.com.au/wp-content/uploads/2018/04/2018-04-25-Quarterly-Client-BRIEFING.pdf

# the relative 10yr Sovereign Bond yield spread between two currency blocs


my_start_date <- "2014-01-01" %>% as.Date()
my_end_date <- "2018-09-30" %>% as.Date() # today() #

# select_colors_scale <- getPalette(2)




############################################################
# First data parameters
############################################################

# http://socviz.co/refineplots.html#case-studies

my_start_date <- "2000-01-01" %>% as.Date()
my_end_date <- today() # "2018-06-30" %>% as.Date()

key_tbl <- tribble(
  ~symbol ,              ~variables,
  'USGG10YR Index',       "US 10Y", 
  # 'GECU10YR Index',  "Euro Area 10Y" ,
  'GDBR10 Index',      "Euro Area 10Y" ,
  'GUKG10 Index',       "UK 10Y",
  'GJGB10 Index' ,   "Japan 10Y" ,
  "GCAN10YR Index",   "Canada 10Y" ,
  "GACGB10 Index",    "Aus 10Y" ,
  "GCNY10YR Index",   "China 10Y" ,
  'DXY Curncy',         "US Dollar Index",
  "USTWBROA Index",     "Broad US Dollar Index" ,
  "RAY Index",          "US",
  "MXWDU Index" ,       "International"
  
)


# Turn the normal mean function into a rolling mean with a 5 row window
mean_roll <- rollify( function(x) mean(x ,na.rm = TRUE), window = 21)


############################################################
# Second Raw Data
############################################################

raw_df <- bloomberg_df %>% 
  filter( symbol %in% key_tbl$symbol ) %>% 
  left_join( key_tbl , by  = c("symbol")) %>%
  select( dates, variables, values ) %>% 
  filter( between( dates ,my_start_date, my_end_date) )  %>%
  group_by( variables ) %>% 
  #  mutate( values = mean_roll(values)) %>% 
  ungroup() %>% 
  spread( variables, values ) %>% 
  tidyr::fill( names(.), .direction = "down") %>% 
  gather( variables, values, - dates ) %>% 
  mutate( values = if_else( str_detect( variables, "10Y"), values/100, values))

raw_df <- raw_df %>%
  spread(variables,values) %>%
  mutate(
    `Average 10Y` = rowMeans(select(.,one_of(   "Euro Area 10Y",  "UK 10Y",  "Japan 10Y"  ,
                                                "Canada 10Y" , "Aus 10Y" , "China 10Y" 
    )) , na.rm = TRUE)
  ) %>%
  mutate( `Yield Spread` =   .[["US 10Y"]]  - .[["Average 10Y"]] ) %>% 
  gather( variables , values , - dates  ) 

# check data 


my_review_date <- "2014-01-01" %>% as.Date()


#*****************************************************************
# Plot http://drawar.github.io/posts/add-borders-annotate-outside-ggplot/
#******************************************************************

# plot
my_title <- "Global bond yields continue to diverge"
my_subtitle <- "10yr Bond Yield Spread (USA vs. Average: Australia, Canada, China, Euro Area, Japan, UK)"
my_caption <- "Source: Bloomberg"
my_y_lab <- "Percent"

df <- raw_df %>% 
  filter( between( dates , my_review_date , today())) %>% 
  filter( variables %in% c("Yield Spread", "US 10Y", "Average 10Y")) %>% 
  mutate( variables = factor( variables, levels =c("Yield Spread", "US 10Y", "Average 10Y") ))

my_xlim <-  my_axis_fun( df , dates ) %>% as.Date()
my_xlim[2] <- my_xlim[2]  %m+% months(6)
# my_xlim
# Create a vector of the last (furthest right) y-axis values for each group
txt_tbl <- df %>% 
  group_by( variables ) %>% 
  top_n(1, dates) %>% 
  ungroup() %>% 
  mutate( dates = dates %m+% months(3) ,
          variables = factor( variables, levels = variables)) %>%
  mutate( colors =   c("#5E81AC" , "#EBCB8B", "#BF616A" ))

txt_tbl <- txt_tbl %>% 
  mutate( labels = str_glue( "{variables} \n  {percent( values )}"),
          labels =  paste0(variables,"\n", percent(values)))



p <- ggplot()+
  geom_line( data = filter(df, !variables %in% "Yield Spread"), aes(x=dates,y=values, color = variables), alpha=.8, size=1.2) +
  geom_line( data = filter(df, variables %in% "Yield Spread"), aes(x=dates,y=values, color = variables), alpha=1, size=1.5) +
  scale_x_date(date_breaks = "1 year" , limits = c(my_xlim[1] , my_xlim[2]), date_labels = "%Y" ) +
  annotate("text",   x = txt_tbl$dates  , y = txt_tbl$values , 
           hjust = .5,
           
           label = txt_tbl$labels, 
           
           color = txt_tbl$colors, fontface = 'bold' ) +
  scale_y_continuous( name = my_y_lab ,label=scales::percent ) +
  scale_color_manual(  values = txt_tbl$colors %>% set_names( txt_tbl$variables) ) +
  # facet_wrap( ~variables, scale = "free_y" , ncol = 1) +
  theme_minimal() + theme_Publication() +
  theme( plot.caption=element_text(hjust=0),
         legend.position = "none" , 
         legend.title = element_blank()) +
  labs( title= my_title, subtitle = my_subtitle , caption = my_caption, y = "", x = "") +
  # theme_Publication()
  NULL


p <- p %>%  # add reccesion shade
  my_area_func( recession_df ,  my_start_date )

pic_list$gbl_spread_p <- p

p

ggsave('output_data/img/gbl_spread_p.png') #, width = 16, height = 9, dpi =







```






## US vs. International


```{r US-International Rotation, echo=FALSE, warning=FALSE, cache=TRUE }


my_start_date <- "2014-01-01" %>% as.Date()
my_end_date <- "2018-09-30" %>% as.Date() today() # 

# select_colors_scale <- getPalette(2)



############################################################
# First Data
############################################################
my_review_date <- "2016-01-01" %>% as.Date()

# Russell 3000 Index  #MSCI ACWI Excluding United States Index

my_vars  <- c("US" , "International", "Broad US Dollar Index")

df <- raw_df %>%
  filter( variables %in% my_vars ) %>% 
  filter( between( dates ,my_start_date, my_end_date) )  %>%
  group_by(variables) %>%
  tq_transmute( select = values ,
                mutate_fun = dailyReturn,
                type = "arithmetic",
                col_rename = "values") %>% 
  filter( !is.na(values)) %>% 
  spread( variables ,values ) %>%
  mutate( `US vs. International` = .[["US"]]  - .[["International"]] ) %>%
  # mutate_if( is.double, funs(scale)) %>% 
  
  gather(variables, values, -dates) %>%
  group_by(variables) %>%
  arrange(dates) %>%
  na.omit() %>% 
  mutate( values = 1*cumprod(1+values)) %>%
  ungroup() %>% 
  # spread( variables ,values ) %>% tail()
  filter( !variables %in% c("US","International") )


my_xlim <-  my_axis_fun( df , dates ) %>% as.Date()
my_xlim[2] <- my_xlim[2] %m+% months(6)
my_xlim

#*****************************************************************
# Plot http://drawar.github.io/posts/add-borders-annotate-outside-ggplot/
#******************************************************************

my_title <- "Global Capital Flow"
my_subtitle <- "Global capital flow reversed its direction in 2018"
my_caption <- "Source: Federal Reserve and Morningstar\nNote: The relative cumulative performances of \"US vs. International\" are represented by Russell 3000 and\nMSCI ACWI-ex US Indices using a base value of 100 at the start of 2014."
my_y_lab <- "Cumulative Performance"
my_2nd_y_lab <- ""

txt_tbl <- df %>% 
  group_by( variables ) %>% 
  top_n(1, dates) %>% 
  ungroup() %>% 
  mutate( dates = dates %m+% months(2) ,
          variables = factor( variables, levels = variables)) %>%
  mutate( colors = c("#5E81AC" , "#BF616A" ))

txt_tbl <- txt_tbl %>% 
  mutate( labels = str_glue( "{variables} \n  {percent( values )}"))

p <- ggplot()+
  geom_line( data = df, aes(x=dates,y=values, color = variables), alpha=1, size=1.2) +
  scale_x_date(date_breaks = "1 year" , limits = c(my_xlim[1] , my_xlim[2]), date_labels = "%Y" ) +
  annotate("text",   x = txt_tbl$dates , y = txt_tbl$values , hjust = .5, vjust = -.0,
           label = txt_tbl$labels,    color = txt_tbl$colors, fontface = 'bold' ) +
  scale_y_continuous( name = my_y_lab ,label=scales::percent ) +
  scale_color_manual(  values = txt_tbl$colors %>% set_names( txt_tbl$variables) ) +
  
  #  facet_wrap( ~variables, scale = "free_y" ) +
  theme_minimal() + theme_Publication() +
  theme( plot.caption=element_text(hjust=0),
         legend.position = "none" , 
         legend.title = element_blank() ) +
  labs( title= my_title, subtitle = my_subtitle, caption = my_caption, x= "") +
  # theme_Publication()
  NULL



p <- p %>%  # add reccesion shade
  my_area_func( recession_df ,  my_start_date )


pic_list$cap_flow_p <- p

p
ggsave('output_data/img/cap_flow_p.png') #, width = 16, height = 9, dpi =

# pic_list$gbl_spread_p + pic_list$cap_flow_p +  plot_layout(ncol = 1)



```




# Economy

## GDP

The U.S. Bureau of Economic Analysis (BEA) released the advance first estimate of GDP growth for the final quarter of 2016.  With the advance estimate, the annual growth rate for the full-year is estimated at 1.6 percent. It was the slowest growth in five years.  See the US Real GDP chart.


```{r Real GDP Data Plot,fig.margin=TRUE,cache=TRUE, warning=FALSE,echo=FALSE, message=FALSE}


############################################################
# Meta data preparation
############################################################

# select interested variables
select_symbols_names <- "Real Gross Domestic Product"

my_start_date <- "2013-01-01" %>% as.Date()
my_end_date <- "2018-12-31" %>% as.Date() # today() # 
my_review_date <- "2015-01-01" %>% as.Date()



select_symbols <- c( "Real Gross Domestic Product" )
select_names <- c("Real Gross Domestic Product") #



select_colors_scale <- c("#5E81AC","#000080")

select_colors_scale  <- c( nord_palettes$frost[3] ,
                           nord_palettes$frost[4])

key_tbl <- tibble(
  symbol =  select_symbols, #c("CPIAUCSL" ,"CPILFESL" ,"PCEPILFE") ,
  variables =  factor( select_names  ,levels = select_names)
) %>% 
  left_join(
    
    c( my_pal("main")(length(  select_names )) ) %>% 
      set_names( select_names) %>% 
      as.data.frame() %>%
      rownames_to_column() %>% 
      set_names( c("variables" , "colors")) ,
    by = "variables"
    
  ) %>% mutate( colors =  as.character(colors ))



# select_colors_scale %>% show_palette

df <- econ_df %>%
  filter( variables %in% key_tbl$variables , dates >= my_start_date ) %>%
  mutate( values = values/100 ) %>% 
  filter( between( dates ,my_start_date, my_end_date) ) %>% 
  select( dates , variables , values) %>% 
  print()
# tail(df, 2)

# set y-axis limits
my_ylim <- my_axis_fun( df , values )
my_ylim[1] <- my_ylim[1] - 0.005
my_ylim[2] <- my_ylim[2] + 0.005

my_ylim


# set x-axis limits
my_xlim <-  my_axis_fun( df , dates ) %>% as.Date()

my_xlim[2] <- my_xlim[2] + months(3)
my_xlim

############################################################
# Quarter-to-Quarter Growth in US Real GDP
############################################################

txt_tbl <- df %>% 
  group_by( variables ) %>% 
  top_n(1, dates) %>%
  ungroup() %>% 
  distinct(dates, variables, values ) %>% 
  mutate( dates = dates %m+% months(0) ,
          
          variables = forcats::as_factor( variables, levels = variables ) ) %>%
  left_join( key_tbl %>% select( variables, colors),
             by = "variables")

txt_tbl <- txt_tbl %>% 
  mutate( labels = str_glue( "{percent( values )}"))


# text_df %>% View()


my_title <- "Quarter-to-Quarter Growth in US Real GDP"
my_subtitle <- ""

my_caption <- "Source: U.S. Bureau of Economic Analysis\nNote: Real GDP growth is measured at seasonally adjusted annual rates."

my_y_lab  <- "Percent"


p <-  ggplot() +
  geom_col(data = df, aes(x=dates, y= values ,fill= values ,color= values ) , 
           alpha= 2/3 ) +
  annotate("text",   x = txt_tbl$dates , y = txt_tbl$values , vjust = -3.5, size = 8,
           label = txt_tbl$labels,    color = txt_tbl$colors, fontface = 'bold' ) + #  color = "black" ,  vjust = -3.5, size = 8 
  
  scale_y_percent(limits= my_ylim ) +  #use scale_y_percent function from hrbrtheme
  scale_x_date(limits = my_xlim,date_breaks = "1 year" , date_labels = "%Y" ) +
  labs(x="",y="", title=  my_title, subtitle = my_subtitle ,    caption= my_caption ) +
  #  theme_ipsum_tw(plot_title_size = 24, subtitle_size = 12) +
  theme(plot.title = element_text(hjust = 0.5)) + # color = nord["nord14"],
  theme(plot.subtitle = element_text( hjust = 0.5)) + # color = nord["nord14"],
  theme(panel.grid = element_blank()) +
  scale_color_mycol( palette = "mesirow", discrete = FALSE) +
  scale_fill_mycol( palette = "mesirow", discrete = FALSE) +
  #  scale_colour_gradientn(colours= select_colors_scale ) +
  # scale_fill_gradientn(colours= select_colors_scale  ) +
  theme_Publication() +
  theme(  legend.position = "none",
          plot.caption=element_text(hjust=0)) +
  theme(
    panel.grid.major = element_line(colour = "grey92"),
    panel.grid.minor = element_line(colour = "grey92",
                                    size = 0.25),
    axis.line = element_line(colour="black")
  )


p <- p  %>%
  # add reccesion shade
  my_area_func( recession_df ,  my_start_date )

pic_list$rgdp_yoy_p <- p

p
# render docx
ggsave('output_data/img/rgdp_yoy_p.png') # ,width = 6.69, height = 8.94,
#    units = c("in", "cm", "mm")[2])#, width = 16, height = 9, dpi = 100)



```



In the fourth quarter of 2016, growth slowed to an annual rate of 1.9 percent from the 3.5 percent growth seen in the third quarter, slightly above the lowest forecast of 1.7 percent, well below the consensus estimate of 2.2%.  Poor trade data dragged on the economy by subtracting 1.7%, the most since the second quarter of 2010.  Personal consumption expenditures slowed down again, contributing just 1.7%, the lowest in the year.


```{r Quarter to Quarter,fig.margin=TRUE,cache=TRUE, eval =  FALSE, warning=FALSE,echo=FALSE, message=FALSE}



df <- read_excel("raw_data/Real GDP Table - 2018-Q3.xlsx",sheet  = "gdp")

df <-  df %>%
  group_by(variables) %>%
  mutate(sign = (ifelse(values>= 0, "positive", "negative"))) %>%
  mutate(sign = if_else(variables %in% 'Real Gross Domestic Product',
                        'neutral',sign),sign =as.factor(sign)) %>%  # assign special
  # value for the top variable
  mutate(y_min = pmin(values,0),y_max = pmax(values,0),
         # for plot position purpose
         myjust = ifelse(values <0 ,1.1,-0.1)) %>%
  ungroup()

df$id  <- df %>%
  # convert variables to factor
  mutate(variables = factor(variables,levels = rev(unique(variables )))) %>%
  # process data for geom_rect  for x and y max & min
  group_by(variables) %>%
  group_indices()


select_colors_scale <-c( "#A06872","gray" ,"#000080")

select_colors_scale <- c(
  nord_palettes$aurora[1] ,
  nord_palettes$rocky_mountain[6] ,
  nord_palettes$frost[4]
  
)

p <- ggplot( data= df,aes(fill = sign,label= values)) +
  geom_rect(aes(x= reorder(variables,id),
                xmin = (id -.45), xmax =( id +.45), ymin = y_min,ymax = y_max ))  +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 20) ) +
  #theme_ipsum(grid= FALSE,axis = TRUE) + coord_flip() +
  theme_Publication()+ coord_flip() +
  facet_wrap(~Qdate)  +
  geom_text(data = df, aes(x= reorder(variables,id), y=values,hjust= myjust, size = 11)) +
  labs(title="Quarter-to-Quarter US Real GDP Contribution",x=NULL,y=NULL,
       subtitle="Seasonally adjusted at annual rates",
       caption="Source: U.S. Bureau of Economic Analysis\nNote: Graph shows contributions to Percent Change in Real Gross Domestic Product.") +
  # scale_fill_manual(name="",values= select_colors_scale ) +
  scale_fill_mycol( palette = "mesirow3") +
  scale_y_continuous(limits=c(-3.0,5.0)) +
  theme(axis.text.y = element_text(size=12),
        panel.grid.major = element_line(colour = "grey92"),
        panel.grid.minor = element_line(colour = "grey92",
                                        size = 0.25),
        axis.line = element_line(colour="black"),
        axis.ticks = element_line(),
        strip.background = element_blank(),
        legend.position="none")


pic_list$rgdp_cont_p <- p

ggsave('output_data/img/rgdp_cont_p.png') #, width = 16, height = 9, dpi = 100)

p



```


```{r Quarter to Quarter 2,fig.margin=TRUE,cache=TRUE, eval =  TRUE, warning=FALSE,echo=FALSE, message=FALSE}


# https://fred.stlouisfed.org/release?rid=386


my_start_date <- '2018-06-01' %>% as.Date()
my_end_date <-  today()


############################################################
# Extract Real GDP data
############################################################


df <-  econ_df %>%
  
  ###### Previous real GDP data process ######
filter(category %in% c( "GDP") , !variables %in% "Annual Real GDP Growth") %>% 
  filter( between( dates ,my_start_date , my_end_date ) ) %>% 
  # add 
  ###### Atlanta GDP Now data process ######
bind_rows(
  econ_df %>%
    filter(category %in% "GDP Now") %>% 
    filter( dates == last(dates))
  
) %>% 
  mutate(values = round( values, 2)) %>%  
  #  mutate(variables = str_replace_all(variables,"\\."," ")) %>%
  # construct seanoal period variables
  mutate(Qdate = factor(paste0(year(dates),"Q",
                               quarter(dates)) ), # per year-quarter
         year = year(dates), # per year
         quarter = quarter(dates),# per quarter
         month = month(dates), # per month
         week = week(dates)  # per week
  ) %>%
  group_by(variables) %>%
  mutate(sign = (ifelse(values>= 0, "positive", "negative"))) %>%
  mutate(sign = if_else(variables %in% 'Real Gross Domestic Product',
                        'neutral',sign),sign =as.factor(sign)) %>%  # assign special
  # value for the top variable
  mutate(y_min = pmin(values,0),y_max = pmax(values,0),
         # for plot position purpose
         myjust = ifelse(values <0 ,1.1,-0.1)) %>%
  ungroup()



df$id  <- df %>% 
  # convert variables to factor
  mutate(variables = factor(variables,levels = rev(unique(variables )))) %>%
  # process data for geom_rect  for x and y max & min
  group_by(variables) %>%
  group_indices()

###### Contributions to Percent Change in Real Gross Domestic Product @rgdp ######
my_title <- "Quarter-to-Quarter US Real GDP Contribution"
my_subtitle <- "Seasonally adjusted at annual rates"
my_caption <- "Source: U.S. Bureau of Economic Analysis and Federal Reserve Bank of Atlanta\nNote: Graph shows contributions to Percent Change in Real Gross Domestic Product\nand the current quarter contributions are estimates from GDPNow model."


text_df <- df %>% mutate( variables = reorder( variables, id))

p <-  ggplot( data= df,aes(fill = sign,label= values)) +
  geom_rect(aes(x= reorder(variables,id),
                xmin = (id -.45), xmax =( id +.45), ymin = y_min,ymax = y_max ))  +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 20) ) +
  #theme_ipsum(grid= FALSE,axis = TRUE) + coord_flip() +
  theme_Publication()+ coord_flip() +
  facet_wrap(~Qdate)  +
  geom_text(data = df, aes(x= reorder(variables,id), 
                           y=values,
                           hjust= myjust 
  ) ,size = 6) +
  labs(title= my_title , 
       subtitle= my_subtitle ,
       caption= my_caption ,
       x=NULL,y=NULL
  )  +
  scale_fill_mycol( palette = "main") +
  # scale_fill_manual(name="",values= select_colors_scale ) +
  scale_y_continuous(limits=c(-3.0,5.0))  +
  theme(axis.text.y = element_text(size=12),
        plot.subtitle = element_text(vjust= 3),
        panel.grid.major = element_line(colour = "grey92"),
        panel.grid.minor = element_line(colour = "grey92",
                                        size = 0.25),
        axis.line = element_line(colour="black"),
        axis.ticks = element_line(),
        strip.background = element_blank(),
        legend.position="none")



pic_list$rgdp_cont_p <- p
ggsave('output_data/img/rgdp_cont_p.png') #, width = 16, height = 9, dpi = 100)

p

```


## Economic Activity  - Industrial Production

Economic activity has continued to show strong momentum, as reflected in both manufacturing and service Institute for Supply Management (ISM) numbers (see the US Business Outlook chart). US manufacturing activity eased to 59.3 in March from 60.8, highest number in 14 years reached in February. While March figure was softer than expected, for the quarter, however, the index reached near 14 year high since 2004, underling the strength of the US manufacturing sector, which was boosted by a rise in solid domestic demand and production. The details show that the strength was broad-based, with 17 out of 18 sectors experiencing growth in business conditions in March. The index hovers near the highest level since 2004. The positive outlook for 2018 of many respondents also points to sustained near-term momentum in their respective sectors. The ISM surveys poll supply managers on their business prospects, and are closely watched because they have been one of the most reliable leading indicators. The index is well above the 50 point threshold that separates 

expansion from contraction in the US manufacturing economy. Prices-paid index rose for a fourth straight month to 78.1, the highest since April 2011, from 74.2;
The service sector, which makes up about 80 percent of US GDP, experienced a growth slowdown in March. The non-manufacturing ISM survey, the measure of economic movement in the service sector, fell to 58.8 in March from 59.5 in February, below the consensus estimate of 59.0. While the growth rate missed expectation, the overall trend still represents positive economic growth, in line with the manufacturing ISM survey. Survey participant comments continue to express a positive outlook for 2018.


```{r ISM Chart,eval=FALSE, fig.margin=TRUE,echo=FALSE,  warning=FALSE, cache=TRUE}


https://www.instituteforsupplymanagement.org/ISMReport/MfgROB.cfm?SSO=1
https://www.cnbc.com/2018/04/02/ism-manufacturing-index-construction-spending.html
https://www.cnbc.com/2018/04/04/march-ism-non-manufacturing-index.html
http://lenkiefer.com/2018/03/11/charting-jobs-friday-with-r/
  http://lenkiefer.com/2018/02/26/employment-growth-and-house-price-trends/
  http://www.freddiemac.com/research/indices/house-price-index.html
https://www.ft.com/content/5f36f1b6-3999-11e8-8eee-e06bde01c544
https://www.bls.gov/news.release/empsit.tn.htm
https://www.cnbc.com/2018/04/06/nonfarm-payrolls-march-2018.html
############################################################
# Extract Industrial Production  data
############################################################

# select interested variables


my_start_date <- "2014-01-01"%>% as.Date()
my_end_date <- today() # "

select_symbols <- c("ISM/MAN_PMI","ISM/NONMAN_NMI")
select_names <- c("Manufacturing","Non-Manufacturing")



key_tbl <- tibble(
  symbol =  select_symbols, #c("CPIAUCSL" ,"CPILFESL" ,"PCEPILFE") ,
  variables =  factor( select_names  ,levels = select_names)
) %>% 
  left_join(
    
    c("#5E81AC" , "#BF616A" ) %>% 
      set_names( select_names) %>% 
      as.data.frame() %>%
      rownames_to_column() %>% 
      set_names( c("variables" , "colors")) ,
    by = "variables"
    
  ) %>% mutate( colors =  as.character(colors ))


# show_palette(nord)



df <-  econ_df %>%
  filter( symbol %in% key_tbl$symbol  ) %>%
  select( dates, symbol, values) %>% 
  left_join( key_tbl , by  = c("symbol")) %>% 
  mutate(year = as.factor(year(dates)), month =
           as.factor(month(dates))) %>%  # add year variable
  group_by( year , month) %>%
  # compute year over year growth rate
  arrange(dates) %>%
  group_by(variables) %>%
  mutate(ann_g = (values-lag(values,1))/lag(values,1)) %>%
  ungroup() %>%
  select(dates,variables,values,ann_g) %>%
  filter( between( dates ,my_start_date, my_end_date) ) 

# set y-axis limits
my_ylim <- my_axis_fun( df , values )
my_ylim


# set x-axis limits
my_xlim <-  my_axis_fun( df , dates ) %>% as.Date()

my_xlim[2] <- my_xlim[2] + months(12)

my_xlim


# Create a vector of the last (furthest right) y-axis values for each group
txt_tbl <- df %>% 
  group_by( variables ) %>% 
  top_n(1, dates) %>% 
  ungroup() %>% 
  mutate( dates = dates + months(1) ) %>% 
  mutate( variables = factor( variables, levels = variables)) %>%
  mutate( colors =  my_pal("main",reverse = TRUE)(length(.$variables)))

txt_tbl <- txt_tbl %>% 
  mutate( labels = str_glue( "{variables} \n  ({values })"))

#*****************************************************************
# Graph
#******************************************************************

df %>% tail()

my_title <- "US Business Outlook"
my_subtitle <- "Represented by the Institute for Supply Management (ISM)'s Purchasing Managers Index (PMI)"
my_caption <- "Source: Institute For Supply Management"


p <-  ggplot()+
  geom_line(data = df , aes(x=dates,y=values, color= variables) , alpha=1,size=1.2) +
  annotate("text",   x = txt_tbl$dates , y = txt_tbl$values ,
           label = txt_tbl$labels,    color = txt_tbl$colors, fontface = 'bold' ,   size = 4,  cex = 4.5,
           hjust = .5 ,vjust = -.1) +
  
  scale_color_manual(  values = txt_tbl$colors %>% set_names( txt_tbl$variables) ) +
  # scale_color_manual(values = select_colors_scale , labels=c("Manufacturing ISM", "Service ISM")) +
  theme(plot.caption=element_text(hjust=0)) +
  labs(x="",y="",title= my_title, subtitle = my_subtitle,  caption= my_caption )+
  theme_Publication() +
  theme(legend.text = element_text(size=18),
        legend.position = "none" ) #,
# legend.key.height=unit(2,"line") ,
# legend.justification=c( .5,1),
# legend.position = c(.50, 1))


# p <-  my_area_func(p, recession_df, select_date)
pic_list$ism_p <- p
p
ggsave('output_data/img/ism_p.png') #, width = 16, height = 9, dpi =


```




```{r Industrial Production Chart 2, fig.margin=TRUE, echo=FALSE, eval = FALSE, warning=FALSE, cache=TRUE}



# http://drawar.github.io/posts/add-borders-annotate-outside-ggplot/
# https://raw.githubusercontent.com/drawar/drawar.github.io/master/_posts/lineplot_bordertext.R

############################################################
# Extract Industrial Production  data
############################################################


# select interested variables
select_symbols_names <- c("NAPMPMI Index","IP YOY Index") # Conference Board Consumer Confidence SA 1985=100)
select_names <- c("ISM", "Industrial Production")


key_tbl <- tibble(
  symbol =  select_symbols_names,             
  variables = select_names 
  
)

my_start_date <- "2010-01-01" %>% as.Date()
my_end_date <-  today()

df <-   bloomberg_df %>% 
  filter( symbol %in%  key_tbl$symbol) %>% 
  left_join( key_tbl , by  = c("symbol")) %>%
  filter( between( dates ,my_start_date, my_end_date) )  %>%
  group_by(variables) %>%
  filter( !is.na(values)) %>% 
  mutate( values = scale(values)) %>% 
  ungroup() 


df %>%  distinct( symbol )


my_title <- "Economic hope on the rise"
my_subtitle <- "Sentiment and real data continued to go up in fourth quarter of 2016"
my_caption <- "Source: ISM Manufacturing Index is provided by Institute For Supply Management,/nIndustrial Production provided by Federal Reserve Board."
# p_caption_2 <- expression(paste("D.Treisman, ", italic("American Economic Review")," (2016)."))

my_xlim <-  my_axis_fun( df , dates ) %>% as.Date()
my_xlim[2] <- my_xlim[2]  %m+% months(2)
# my_xlim
# Create a vector of the last (furthest right) y-axis values for each group
txt_tbl <- df %>% 
  group_by( variables ) %>% 
  top_n(1, dates) %>% 
  ungroup() %>% 
  mutate( variables = factor( variables, levels = variables)) %>%
  mutate( colors =  my_pal("main")(length(.$variables)))

txt_tbl <- txt_tbl %>% 
  mutate( labels = str_glue( "{variables} \n  {round( values,2 )}"))

p <- ggplot()+
  geom_line( data = df, aes(x=dates,y=values, color = variables), alpha=.8, size=2) +
  scale_x_date(date_breaks = "1 year" , limits = c(my_xlim[1] , my_xlim[2]), date_labels = "%Y" ) +
  annotate("text",   x = txt_tbl$dates , y = txt_tbl$values , hjust = -.1,
           label = txt_tbl$labels,    color = txt_tbl$colors, fontface = 'bold' ) +
  scale_y_continuous( name = "" ) +
  scale_color_manual(  values = txt_tbl$colors %>% set_names( txt_tbl$variables) ) +
  # facet_wrap( ~variables, scale = "free_y" , ncol = 1) +
  theme_minimal() + theme_ipsum() +
  theme( plot.caption=element_text(hjust=0),
         legend.position = "none" , 
         legend.title = element_blank() ,
         axis.text.y.left = element_text(colour= my_cols("red") ),
         axis.title.y = element_text(color= my_cols("red") )) +
  labs( title= my_title, subtitle = my_subtitle) +
  # theme_Publication()
  NULL


p <- p %>%  # add reccesion shade
  my_area_func( recession_df ,  my_start_date )


p


```


Despite weak hard economic numbers, sentiment data shows people are upbeat about the future as consumer confidence and ISM survey data point to high optimism. The challenge for the US economy is when and whether this strong optimism will work through hard economic data with the help of long-awaited fiscal stimulus program by the new administration. See the ISM Manufacturing Index chart.



## Labor Market


Through December, US jobs report showed tighter labor market condition.  Employer added 156,000 jobs in December, missing the expectations of 175,000.  However, the November figure was revised higher to 204,000 from 178,000, according to the Labor Department's employment report. Average hourly earnings increased by 2.9 percent in December, the strongest pace since the last recession ended in June 2009. See the US Labor Cost charts.

```{r US Labor Market Chart,  echo=FALSE,  warning=FALSE, cache=TRUE}


# https://www.forexfactory.com/calendar.php?day=apr6.2018#graph=86543
# https://www.ft.com/content/5f36f1b6-3999-11e8-8eee-e06bde01c544
# http://lenkiefer.com/2018/03/11/charting-jobs-friday-with-r/
# https://www.ft.com/content/333b5020-399e-11e8-8b98-2f31af407cc8

############################################################
# Extract CPI Data
############################################################


# Monetary_Symbols_Names
# select interested variables
select_symbols <- c( "Nonfarm Payroll Employment"  ) #

select_symbols_names <- select_symbols


my_start_date <- "1980-01-01"

# econ_tbl %>% filter(category %in% "INFLATION")
df <- econ_df %>% 
  filter(variables %in% select_symbols) %>%
  # compute  growth rate
  arrange(dates) %>%
  mutate( delta  =  values - lag( values ,1) ) %>% 
  ungroup()  %>%
  mutate( my_dates = as.yearqtr(dates , format = "%Y-%m-%d"))%>% 
  group_by(  my_dates ) %>% 
  mutate( values = sum( delta, na.rm = TRUE)) %>% 
  filter( dates == last(dates)) %>% 
  ungroup() %>% 
  filter(dates >= my_start_date) 

df %>% tail()

#####################################################################################
## Step 4: make some plots ###
#####################################################################################

# set x-axis limits
my_xlim <-  my_axis_fun( df , dates ) %>% as.Date()

my_xlim[2] <- my_xlim[2] + months(0)
# my_xlim


text_df <- filter(df, dates == last(dates))

############################################################
# Quarter-to-Quarter Growth in US Real GDP
############################################################

# 89 consecutive months of positive month-over-month job growth

p <- ggplot( )+
  geom_col(data = df, aes(x=dates, y= values ,fill= values ,color= values ),alpha= 2/3 ) +
  #  annotate(geom = "text", x = text_df$dates , y = text_df$values , label = scales::percent( text_df$values ) , fontface = 'bold', color = "black" ,  vjust = -.5, size = 10) +
  #  scale_y_percent(limits= my_ylim ) +  #use scale_y_percent function from hrbrtheme
  scale_y_continuous(labels=scales::comma) +
  scale_x_date(limits = my_xlim,date_breaks = "2 year" , date_labels = "%Y" ) +
  labs(x="",y="Quarterly Average in Thousand",
       title = "US Non-Farm Employment Growth",
       # subtitle="U.S. Nonfarm Employment Growth",
       caption="Source: U.S. Bureau of Labor Statistics"# \nNote: U.S. Nonfarm Employment is measured at seasonally adjusted."
  ) +
  #  theme_ipsum_tw(plot_title_size = 24, subtitle_size = 12) +
  
  theme(plot.title = element_text(hjust = 0.5)) + # color = nord["nord14"],
  theme(plot.subtitle = element_text( hjust = 0.5)) + # color = nord["nord14"],
  theme(panel.grid = element_blank()) +
  scale_colour_gradientn(colours= select_colors_scale ) +
  scale_fill_gradientn(colours= select_colors_scale  ) +
  theme_Publication() +
  theme(  legend.position = "none",
          plot.caption=element_text(hjust=0)) +
  theme(
    panel.grid.major = element_line(colour = "grey92"),
    panel.grid.minor = element_line(colour = "grey92",
                                    size = 0.25),
    axis.line = element_line(colour="black")
  )


p <- p  %>%
  # add reccesion shade
  my_area_func( recession_df ,  my_start_date )

pic_list$nfp_p <- p
p
ggsave('output_data/img/nanfarm_p.png', width = 16, height = 9) #, width = 16, height = 9, dpi =



```

## US Employment

US non-farm payroll employment growth rose by a mediocre 148,000 in December, below market expectations of a 190,000 increase after November¡¯s strong result. For the quarter, however, the report depicts strong labor market conditions; job gains have averaged 204,000 during the quarter, adding to evidence that the economy is near full employment. The jobless rate remained at 4.1% for the third straight month in December, a level last seen 17 years ago. Average hourly earnings, a measure of labor costs, rose in line with expectations by 2.5%, indicating soft wage dynamics despite an economy close to full employment.

```{r US Employment Chart, echo=FALSE,  warning=FALSE, cache=TRUE}

############################################################
# Extract CPI Data
############################################################


select_symbols <- c( "Civilian Unemployment Rate"  ,
                     "Total Civilian Unemployment Rate" ) #

select_symbols_names <- c("Unemployment Rate" , "Total Unemployment Rate") #

my_start_date <- "2000-01-01" %>% as.Date()

# econ_tbl %>% filter(category %in% "EMPLOYMENT")
df <- econ_df %>%
  filter(variables %in% select_symbols) %>%
  mutate(values = values /100 ) %>%  # add year variable
  filter(dates >= my_start_date)


# Create a vector of the last (furthest right) y-axis values for each group
txt_tbl <- df %>% 
  group_by( variables ) %>% 
  top_n(1, dates) %>% 
  ungroup() %>% 
  mutate( variables = factor( variables, levels = variables)) %>%
  mutate( colors =  my_pal("main")(length(.$variables)))

txt_tbl <- txt_tbl %>% 
  mutate( labels = str_glue( "{percent( values )}"))

#####################################################################################

# set x-axis limits
my_xlim <-  my_axis_fun( df , dates ) %>% as.Date()

my_xlim[2] <- my_xlim[2] + months(24)
# my_xlim


# https://www.ft.com/content/7d97f1b2-e492-11e6-8405-9e5580d6e5fb
p <- df %>%
  filter(dates >=my_start_date) %>%
  ggplot(aes(x=dates,y=values,color=variables))+geom_line(alpha=1,size=1.2)+
  annotate("text",   x = txt_tbl$dates , y = txt_tbl$values , hjust = -.1, vjust = -1,
           size = 6,         label = txt_tbl$labels,    color = txt_tbl$colors, fontface = 'bold' ) +
  scale_x_date(date_breaks = "2 year", date_labels = "%Y") +
  scale_color_manual(  values = txt_tbl$colors %>% set_names( txt_tbl$variables)  )+
  scale_y_continuous(label=scales::percent)+
  # scale_color_viridis(option="D",end=0.9,discrete = TRUE)+
  theme_minimal()+
  theme(plot.caption=element_text(hjust=0))+
  labs(x="",y="",title="US Employment Condition",
       caption="Source: U.S. Bureau of Labor Statistics\nNote: Total Unemployment Rate accounts for total unemployed, plus all marginally attached workers\nplus total employed part time for economic reasons.")+
  theme_Publication() +
  theme( legend.justification = c(0, 1), legend.position = c(0, 1),legend.title = element_blank() )
NULL
pic_list$employ_p <- p
p
#ggsave('output_data/img/employ_p.png', width = 16, height = 9) #, width = 16, height = 9, dpi =


```



## US Labor Cost

```{r US Labor Cost Chart,  echo=FALSE,  warning=FALSE, cache=TRUE}

############################################################
# Extract CPI Data
############################################################

# Monetary_Symbols_Names
# select interested variables

select_symbols_names <-  c("Average Hourly Earnings", "Employment Cost Index")
select_symbols <- c(   "AHE YOY% Index" , "ECI YOY Index")

my_start_date <- "2005-01-01" %>% as.Date()
my_end_date <-  "2018-12-31" %>% as.Date()


key_tbl <- tibble( variables = select_symbols_names,
                   symbol = select_symbols)

df <- bloomberg_df %>%
  filter( between( dates ,my_start_date, my_end_date) ) %>% 
  filter(symbol %in% key_tbl$symbol ) %>%
  left_join(
    key_tbl , by  = c("symbol" )
  ) %>%
  arrange(dates) %>%
  mutate(values = values/100) 


# Create a vector of the last (furthest right) y-axis values for each group
txt_tbl <- df %>% 
  group_by( variables ) %>% 
  top_n(1, dates) %>% 
  ungroup() %>% 
  mutate( variables = factor( variables, levels = variables)) %>%
  mutate( colors =  my_pal("main")(length(.$variables)))

txt_tbl <- txt_tbl %>% 
  mutate( labels = str_glue( "{percent( values )}"))



# View(df)

# set x-axis limits
my_xlim <-  my_axis_fun( df , dates ) %>% as.Date()

my_xlim[2] <- my_xlim[2] %m+% months(12)
my_xlim

# https://www.ft.com/content/7d97f1b2-e492-11e6-8405-9e5580d6e5fb

p <- ggplot()+
  geom_line(data = df, aes(x= dates,y= values,color= variables ) , alpha=1,size= 1.1 ) +
  annotate("text",   x = txt_tbl$dates , y = txt_tbl$values , hjust = -.1, vjust = 0,
           size = 9,  label = txt_tbl$labels,    color = txt_tbl$colors, fontface = 'bold', cex = 4.5) +
  
  scale_color_manual(  values = txt_tbl$colors %>% set_names( txt_tbl$variables)  )+
  scale_y_continuous(label=scales::percent ) + #, limits = c(0.01, 0.03)) +
  
  theme_minimal()+theme(plot.caption=element_text(hjust=0))+
  labs(x="",y="",title="US Labor Cost",
       caption="Source: U.S. Bureau of Economic Analysis")+
  theme_Publication() +
  theme( 
    legend.justification = c(2.6, 1), legend.position = c(0.8, .9),
    legend.text = element_text(size=18),
    legend.key.height=unit(2,"line") ,
    legend.title = element_blank())


pic_list$laborcost_p <- p
p
ggsave('output_data/img/laborcost_p.png') #, width = 16, height = 9, dpi =

```




## US Inflation Outlook

Headline CPI inflation accelerated to 2.1% year-over-year in December from 1.7% in November, close to the 2.2% year-over-year core inflation rate due to the rise in shelter cost and recovery in crude oil prices.
Tightening labor market condition has supported service inflation at a 3% annualized rate.  With energy moving higher and rents and medical costs continuing to firm up, price pressures are gaining traction, strengthening the case for the Fed to keep raising interest rates this year.
However, the Fed's preferred gauge of inflation, the core PCE index, which excludes the volatile food and energy components, came in at 1.7 per cent and hasn't met the goal of Fed's 2 percent goal yet, a case for Fed's more dovish stance. See the US Inflation Outlook chart.


```{r Inflation Outlook chart,  warning=FALSE, cache=TRUE, echo=FALSE}

# https://www.prnewswire.com/news-releases/pmi-at-593-march-manufacturing-ism-report-on-business-300622353.html

# https://www.reuters.com/article/us-usa-economy-inflation/u-s-consumer-prices-drop-but-core-inflation-firming-idUSKBN1HI1TT

# https://www.ft.com/content/ae6359da-3d7e-11e8-b7e0-52972418fec4

# https://www.bloomberg.com/news/articles/2018-04-11/u-s-core-inflation-accelerates-as-drag-from-phone-costs-fades

# https://www.reuters.com/article/us-usa-economy-inflation/u-s-consumer-prices-drop-but-core-inflation-firming-idUSKBN1HI1TT


# https://www.bloomberg.com/news/articles/2018-04-11/u-s-core-inflation-accelerates-as-drag-from-phone-costs-fades

# https://www.cnbc.com/2018/04/10/inflation-could-show-more-sizzle-than-expected.html

# https://www.newyorkfed.org/research/policy/underlying-inflation-gauge

# https://www.clevelandfed.org/our-research/indicators-and-data/inflation-nowcasting.aspx

# select_colors_scale <-  getPalette(10)[c(3,1,10)]  # select_colors getPalette(10)[c(3,1,10)]

select_colors_scale <- c(
  nord_palettes$aurora[1] ,
  nord_palettes$aurora[3] ,
  nord_palettes$frost[4]
  
) 
############################################################
# Extract CPI Data
############################################################


# Monetary_Symbols_Names
# select interested variables
select_symbols <- c("CPIAUCSL" ,"CPILFESL" ,"PCEPILFE") #
select_symbols <- c( 'CPI YOY Index','CPI XYOY Index',"PCE CYOY Index")

select_names <- c("Headline CPI","Core CPI", "Core PCE","Average Hourly Earnings") #

temp_key_tbl <- tibble(
  symbol =  c( 'CPI YOY Index','CPI XYOY Index',"PCE CYOY Index") , #c("CPIAUCSL" ,"CPILFESL" ,"PCEPILFE") ,
  variables =  factor(c("Headline CPI","Core CPI", "Core PCE"), levels = c("Headline CPI","Core CPI", "Core PCE")),
  colors = select_colors_scale
) 


df <- bloomberg_df %>% 
  # econ_df %>%
  filter( symbol %in% select_symbols ) %>%
  left_join(temp_key_tbl, by ="symbol") %>%
  filter(dates >= "2001-01-01" , dates <= today()) %>%
  mutate(variables = as.factor(variables),
         year = as.factor(year(dates)), month =as.factor(month(dates))) %>%  #
  group_by(variables,month) %>%
  arrange(dates) %>%
  # compute annual growth rate
  #mutate(ann_g = (values-lag(values,1))/lag(values,1)) %>%
  mutate(ann_g =  values /100) %>%
  ungroup() %>% 
  filter(dates >= "2010-01-01") 


# set x-axis limits
my_xlim <-  my_axis_fun( df , dates ) %>% as.Date()

my_xlim[2] <- my_xlim[2] + months(12)
my_xlim

text_df <-  df %>% 
  group_by( symbol ) %>% 
  filter(dates == last(dates)) %>% 
  ungroup() %>% 
  mutate( values = round(ann_g,3))


# https://www.ft.com/content/7d97f1b2-e492-11e6-8405-9e5580d6e5fb
p <- df %>%
  ggplot(aes(x=dates,y= ann_g,color= variables )) +
  geom_line(alpha=1,size=1.1) +
  geom_hline(yintercept = .02,linetype = "dashed") +
  scale_color_manual(values =select_colors_scale ) +
  annotate(geom = "text", x = text_df$dates,
           y = text_df$ann_g ,
           label = sprintf("%1.2f%%", 100*text_df$values)   , #%>% map_chr( wrapper,width = 14 ) , 
           size = 9,
           hjust = -0.1 ,vjust = -.0,
           color =  text_df$colors ,
           fontface = "bold", cex = 4.5) +
  
  scale_x_date(limits = my_xlim, date_breaks = "1 year" , date_labels = "%Y" ) +
  scale_y_continuous(label=scales::percent)+
  # scale_color_viridis(option="D",end=0.9,discrete = TRUE)+
  # theme_minimal()+
  labs(x="",y="",title="US Inflation Outlook",
       caption="Source: U.S. Bureau of Economic Analysis") +
  theme_Publication() +
  theme(plot.caption=element_text(hjust=0),
        legend.justification = c(1, 1), legend.position = c(1, 1))

p <- p + theme(plot.caption=element_text(hjust=0),
               legend.justification = c(1, 1), legend.position = c(0.6, .9),
               legend.text = element_text(size=18),
               legend.key.height=unit(2,"line"))

p <-  p + theme(
  panel.grid.major = element_line(colour = "grey92"),
  panel.grid.minor = element_line(colour = "grey92",
                                  size = 0.25),
  axis.line = element_line(colour="black")
)


pic_list$cpi_p <- p
p
ggsave('output_data/img/cpi_p.png') #, width = 16, height = 9, dpi =


```

```{r Inflation OIL Outlook chart,  warning=FALSE, cache=TRUE, echo=FALSE}


############################################################

# Extract CPI Data

############################################################



############################################################
# http://socviz.co/refineplots.html#case-studies

my_start_date <- "2000-01-01" %>% as.Date()
my_end_date <- today() # "2018-06-30" %>% as.Date()
my_review_date <- "2013-01-01" %>% as.Date()

select_symbols <- c( 'CPI YOY Index','CPI XYOY Index',"PCE CYOY Index",  "AHE YOY% Index")
select_names <- c("Headline CPI","Core CPI", "Core PCE", "Average Hourly Earnings") #

my_dep_var <- c("Average Hourly Earnings")
my_indep_var <- c("Headline CPI","Core CPI", "Core PCE" )


key_tbl <- tibble(
  symbol =  select_symbols, #c("CPIAUCSL" ,"CPILFESL" ,"PCEPILFE") ,
  variables =  factor( select_names  ,levels = select_names)
) %>% 
  left_join(
    
    c( "#BF616A" ,"#EBCB8B", "#5E81AC", "#7f7f7f" ) %>% 
      set_names( select_names) %>% 
      as.data.frame() %>%
      rownames_to_column() %>% 
      set_names( c("variables" , "colors")) ,
    by = "variables"
    
  ) %>% mutate( colors =  as.character(colors ))

key_tbl
# process oil data
# creat year over year data
df <- bloomberg_df %>% 
  filter( symbol %in% key_tbl$symbol  ) %>%
  left_join( key_tbl , by  = c("symbol")) %>%
  select( dates, variables, values ) %>% 
  mutate( values = round(values,2)/100 ) %>% 
  filter( between( dates ,my_start_date, my_end_date) ) %>%
  print()




df <- df %>%
  spread( variables, values ) %>% 
  tidyr::fill( names(.), .direction = "down") %>% 
  na.omit() %>% 
  gather( variables, values, - dates ) 

# df %>%  distinct(  variables )

df %>% group_by( variables ) %>% skimr::skim()


# Normalizer to bring 2nd data into 1st data range. This makes
# highest bar equal to highest point. You can use a different
# normalization if you want (e.g., this could be the constant 15
# like you had in your example, though that's fragile if the data
# changes).

df <- df %>% filter( dates >= my_review_date)


# set x-axis limits
my_xlim <-  my_axis_fun( df , dates ) %>% as.Date()

my_xlim[2] <- my_xlim[2] + months(8)
my_xlim


txt_tbl <- df %>% 
  group_by( variables ) %>% 
  top_n(1, dates) %>%
  ungroup() %>% 
  distinct(dates, variables, values ) %>% 
  mutate( dates = dates %m+% months(1) ,
          variables = forcats::as_factor( variables, levels = variables ) ) %>%
  left_join( key_tbl %>% select( variables, colors),
             by = "variables")


txt_tbl <- txt_tbl %>% 
  mutate( labels = str_glue( "{variables}\n{percent( values )}"))


my_title <- "US Inflation Outlook"
my_subtitle <-"Wage growth firms up but inflation measures remain soft."
my_y_lab  <- ""
my_2nd_y_lab <- ""
my_caption <- "Source: U.S. Bureau of Economic Analysis"

p <- ggplot() +
  geom_line( data =  df ,
             aes( x = dates, y = values, color = variables), size = 1.2 ) +
  scale_x_date(limits = my_xlim, date_breaks = "1 year", date_labels = "%Y") +
  scale_y_continuous(label= scales::percent , name = my_y_lab ) +
  scale_color_manual(  values = txt_tbl$colors %>% set_names( txt_tbl$variables) ) +
  
  annotate("text",   x = txt_tbl$dates , y = txt_tbl$values , hjust =0, vjust = -.0, size = 4,
           label = txt_tbl$labels,    color = txt_tbl$colors, fontface = 'bold' ) +
  
  theme_Publication() +
  # theme_ipsum() +
  theme(legend.position= "none" ) +
  labs( title= my_title , x="", y="",
        subtitle = my_subtitle,
        caption= my_caption ) +
  
  NULL


pic_list$cpi_p <- p
p
ggsave('output_data/img/cpi_p.png') #, width = 16, height = 9, dpi =



```


```{r Inflation OIL Outlook chart,  warning=FALSE, cache=TRUE, echo=FALSE}


############################################################

# Extract CPI Data

############################################################

############################################################
# http://socviz.co/refineplots.html#case-studies

my_start_date <- "2000-01-01" %>% as.Date()
my_end_date <- today() # "2018-06-30" %>% as.Date()
my_review_date <- "2013-01-01" %>% as.Date()

select_symbols <- c( 'CPI YOY Index','CPI XYOY Index',"PCE CYOY Index", "CL1 Comdty")
select_names <- c("Headline CPI","Core CPI", "Core PCE", "Oil") #

my_dep_var <- c("Oil")
my_indep_var <- c("Headline CPI","Core CPI", "Core PCE" )


key_tbl <- tibble(
  symbol =  select_symbols, #c("CPIAUCSL" ,"CPILFESL" ,"PCEPILFE") ,
  variables =  factor( select_names  ,levels = select_names)
) %>% 
  left_join(
    
    c( "#BF616A" ,"#EBCB8B", "#5E81AC", "#7f7f7f" ) %>% 
      set_names( select_names) %>% 
      as.data.frame() %>%
      rownames_to_column() %>% 
      set_names( c("variables" , "colors")) ,
    by = "variables"
    
  ) %>% mutate( colors =  as.character(colors ))

key_tbl
# process oil data
# creat year over year data
df <- bloomberg_df %>% 
  filter( symbol %in% c(key_tbl %>% filter( variables %in% !!my_indep_var ) %>% pull(symbol) )
  ) %>%
  left_join( key_tbl , by  = c("symbol")) %>%
  select( dates, variables, values ) %>% 
  mutate( values = values/100 ) %>% 
  filter( between( dates ,my_start_date, my_end_date) ) %>% 
  bind_rows(
    
    bloomberg_df %>%
      semi_join( key_tbl %>% filter( variables %in% !!my_dep_var ) ,
                 by = "symbol") %>%
      left_join( key_tbl %>% filter( variables %in% !!my_dep_var ) ,
                 by = "symbol") %>% 
      tibbletime::as_tbl_time( index = dates ) %>% 
      tibbletime::as_period( period = "monthly" , side = "end", include_endpoints = TRUE ) %>%
      mutate( monthf = month(dates)) %>% 
      group_by( variables, monthf ) %>% 
      drop_na( values ) %>% 
      arrange(dates) %>% 
      mutate( values =  (values - dplyr::lag(values,1))/dplyr::lag(values,1) ) %>% 
      ungroup() %>% 
      filter( between( dates ,my_start_date , my_end_date) )  %>%
      select( dates , variables , values) 
    
    
    
  ) %>% print()




df <- df %>%
  spread( variables, values ) %>% 
  tidyr::fill( names(.), .direction = "down") %>% 
  na.omit() %>% 
  gather( variables, values, - dates ) 

# df %>%  distinct(  variables )

df %>% group_by( variables ) %>% skimr::skim()


# Normalizer to bring 2nd data into 1st data range. This makes
# highest bar equal to highest point. You can use a different
# normalization if you want (e.g., this could be the constant 15
# like you had in your example, though that's fragile if the data
# changes).

df <- df %>% filter( dates >= my_review_date)


# set x-axis limits
my_xlim <-  my_axis_fun( df , dates ) %>% as.Date()

my_xlim[2] <- my_xlim[2] + months(6)
my_xlim

max_1 <- df %>% 
  filter( !variables %in% my_dep_var ) %>% 
  summarise( max = max( values, na.rm = TRUE)) %>% 
  pull()

max_2 <-df %>% 
  filter( variables %in% my_dep_var ) %>% 
  summarise( max = max( values, na.rm = TRUE)) %>% 
  pull()


normalizer <- max_1/max_2


txt_tbl <- df %>% 
  group_by( variables ) %>% 
  top_n(1, dates) %>%
  ungroup() %>% 
  distinct(dates, variables, values ) %>% 
  mutate( dates = dates %m+% months(1) ,
          variables = forcats::as_factor( variables, levels = variables ) ) %>%
  left_join( key_tbl %>% select( variables, colors),
             by = "variables")


txt_tbl <- txt_tbl %>% 
  mutate( labels = str_glue( "{variables}: {percent( values )}"))

txt_tbl <- txt_tbl %>% 
  mutate( values = if_else( variables %in% my_dep_var, values*normalizer, values ))

my_title <- "US Inflation Outlook"
my_subtitle <-"Relationship between oil prices and inflation measures remain high since 2016."
my_y_lab  <- "% year-over-year changes"
my_2nd_y_lab <- ""
my_caption <- "Source: U.S. Bureau of Economic Analysis & U.S. Energy Information Administration/nNote: Oil prices are represented by West Texas Intermediate (WTI)"

p <- ggplot() +
  geom_line( data =   filter(df,  !variables %in% my_dep_var ),
             aes( x = dates, y = values, color = variables), size = 1.2 ) +
  geom_line( data =   filter(df,  variables %in% my_dep_var ),
             aes(x=dates,y= values*normalizer,color=variables), size = 1.2, alpha = 1 ) +
  scale_x_date(limits = my_xlim, date_breaks = "1 year", date_labels = "%Y") +
  scale_y_continuous(label= scales::percent , name = my_y_lab ,
                     sec.axis = sec_axis(trans= ~./normalizer,labels = scales::percent,
                                         name = my_2nd_y_lab )) +
  scale_color_manual(  values = txt_tbl$colors %>% set_names( txt_tbl$variables) ) +
  
  annotate("text",   x = txt_tbl$dates , y = txt_tbl$values , hjust =0, vjust = -.0, size = 4,
           label = txt_tbl$labels,    color = txt_tbl$colors, fontface = 'bold' ) +
  
  theme_Publication() +
  # theme_ipsum() +
  theme(legend.position= "none" ) +
  labs( title= my_title , x="", y="",
        subtitle = my_subtitle,
        caption= my_caption ) +
  
  NULL


pic_list$cpi_p <- p
p
ggsave('output_data/img/cpi_p.png') #, width = 16, height = 9, dpi =



```


## Federal Reserve Policy


The Federal Open Market Committee (FOMC) raised the target range for the fed funds rate by 0.25% on March 21th, to 1.50% - 1.75%. Since the rate hike was already expected, market participants focused more on the Fed¡¯s communication on its future hiking cycle and the ¡°dot plot¡±, which it uses to signal its outlook for future target interest rates.


The minutes of the March FOMC meeting showed that while the FOMC members acknowledged the fact that inflation is continuing to undershoot their target level despite robust economic growth and labor market conditions, they forecasted that the reduced labor market slack will eventually boost inflation toward their desired pace over the medium term. Overall, the minutes did not show any meaningful shift on their economic outlook and rate hike plan from the previous quarter. FOMC policymakers also predicted only a modest impact on growth from the slashing of the US corporate tax rate and other tax changes passed by Congress in December.

According to the FOMC ¡°dot plot¡±, which it uses to signal its outlook for future target interest rates (see the FOMC participants¡¯ assessments chart on the following page), the distribution of participants¡¯ assessments in the December meeting (blue dots) has changed little relative to the September meeting (pink dots), with the median remaining the same for the years of 2018 and 2019. According to the dot plot, the members expect three quarter-point increases in 2018 and two in 2019.

```{r FED dot plot chart, echo=FALSE, warning=FALSE, cache=TRUE}

# https://www.ft.com/content/de255f20-2d24-11e8-9b4b-bc4b9f08f381
# https://www.ft.com/content/a21d2d92-2e81-11e8-9b4b-bc4b9f08f381
# https://www.ft.com/content/92e7f9c6-2d7b-11e8-9b4b-bc4b9f08f381
# https://ftalphaville.ft.com/2018/03/23/1521832181000/Cross-currency-basis-feels-the-BEAT/
# https://www.ft.com/content/438564e2-2d33-11e8-a34a-7e7563b0b0f4
# https://www.ft.com/content/48f5ccb0-3de5-11e8-b7e0-52972418fec4

#*****************************************************************
# Process Data
#*****************************************************************


feddotplot_fnc <- function(raw_df){
  # get a unique list of horizon values appearing in the FOMC projection table (2016,2017,2018,Longer Run)
  xlist <-unique(raw_df$x)
  # Set up an empty data frame
  df<-data.frame(rate=numeric(),x=numeric())
  #str(df)
  for (xx in 1:length(xlist)){  #loop through x values
    temp <- filter(raw_df,x %in% xlist[xx])
    for (i in 1:length(temp$rate) ){ #create a dot for each observation
      for (j in 1:temp$count[i])   #count along each row
      {if (temp$count[i]>0){   #do something if count is greater than 0
        myc<-j  #j corresponds to the number of dots in a row
        #set up a counter for total number of dots in a row
        #if number in row is odd, start at zero
        #if number in row is even, start at 1/2 0.4 = 0.2 around zero
        df1<-data.frame(rate=temp$rate[i],
                        x=ifelse(temp$count[i] %% 2 ==1,
                                 ifelse(myc %% 2 ==1,xx+(-1)^myc * (myc-1)*0.04,xx+(-1)^myc * (myc)*0.04),
                                 xx-.02+(-1)^myc * (myc)*0.04)   )
        df<-rbind(df,df1)
      }}}}
  return(df)
}


fomc_data <- fomc_data %>% 
  mutate( new_date =    map(dates ,~{  str_c( month(.x , label = TRUE), year(.x) , sep = "-") } ) ) %>% 
  mutate( df = map( value , ~{
    
    .x %>% pluck( 1 ) %>% 
      gather(variables,values,-Target) %>% 
      mutate(values = if_else(is.na(values),0,values)) %>%
      purrr::set_names( c("rate","x","count") ) %>% 
      filter( !x %in% "2017") %>%
      feddotplot_fnc() 
    
  }
  )) %>% 
  mutate( df = map2( df, new_date, ~mutate(.x, date = .y ) )) %>% 
  select( - new_date)

df <-   fomc_data %>% 
  pull(df) %>% 
  bind_rows %>% 
  mutate( date = fct_inorder( date )) %>% 
  filter( date %in% c( "Sep-2018", "Dec-2018") ) %>% 
  mutate( date = fct_drop( date))


# View(df)
df$date %>% unique()

#*****************************************************************
# Plot
#*****************************************************************

# check
# https://www.bloomberg.com/graphics/fomc-dot-plot/

caption <- "Source: Federal Reserve Board Note: Each shaded circle indicates the value (rounded to the nearest 1/8 percentage point) of an individual participant's judgment of the midpoint of the appropriate target range for the federal funds rate or the appropriate target level for the federal funds rate at the end of the specified calendar year or over the longer run.
"
#make a plot

select_colors_scale <- c(
  nord_palettes$aurora[1] ,
  nord_palettes$frost[4]
  
)

# 

p <- df %>%
  # filter( !date %in% "Dec-2017") %>% 
  ggplot(aes(x=x,y=rate,fill= as.factor(date),color=as.factor(date)))+
  geom_point(size= 4, alpha = .8) +
  scale_x_continuous(breaks=seq(1,5,1),labels=c("2018","2019","2020", "2021","Longer Run"))+
  scale_color_manual(values = select_colors_scale )  + 
  scale_y_continuous(limits=c(0,4.5)) +
  labs(y="Midpoint of target range or\ntarget level for the federal funds rate (%)",x="Horizon",
       subtitle="September 2018",
       title="FOMC participants' assessments of appropriate monetary policy:\nMidpoint of target range or target level for the federal funds rate",
       caption=label_wrap_gen(100)(caption))+ #wrap the label
  theme_Publication() +
  theme(  plot.subtitle=element_text(face="italic",size=16*1.4,
                                     hjust=0, margin=margin(2,2,10,2))) +
  
  #  theme(legend.justification = c(0, 1), legend.position = c(0, 1), legend.title = element_blank(),legend.text = element_text(size=14)) +
  theme(plot.caption=element_text(hjust=0,vjust=1,margin=margin(t=10)),
        legend.title = element_blank() ) +
  theme(axis.title.y=element_text(hjust=.5),
        axis.title.x=element_text(hjust=.5),
        legend.position = c(0.2, .9) ,
        legend.text = element_text(size=18),
        legend.key = element_rect(size = 15),
        legend.key.size = unit(1.8, 'lines'))

p <- p +
  theme(
    panel.grid.major = element_line(colour = "grey92"),
    panel.grid.minor = element_line(colour = "grey92",
                                    size = 0.25),
    axis.line = element_line(colour="black")
  )


pic_list$fed_dot_p <- p
p

ggsave('output_data/img/fed_dot_p.png', width = 16, height = 9) #, width = 16, height = 9, dpi =


```


```{r FED vs market plot chart, echo=FALSE, warning=FALSE, cache=TRUE}





df <- fomc_data %>%
  mutate( new_date =    map(dates 
                            ,~{  str_c( month(.x , label = TRUE), year(.x) , sep = "-") } ) ) %>% 
  mutate( compare_df = map( value , ~{
    
    .x %>% pluck( 2) %>% 
      gather(variables,values,- Curves ) %>% 
      rename(group = Curves) %>% 
      #  mutate(values = if_else(is.na(values),0,values)) %>%
      filter( !values %in% "2017")
    
  }
  )) %>%  mutate( compare_df = map2( compare_df, new_date, ~mutate(.x, date = .y ) )) %>% 
  select( - new_date)  %>% 
  pull( compare_df ) %>% 
  bind_rows() %>% 
  mutate(group  = fct_inorder(group))


df <- df %>%
  mutate(  group = str_remove( group,  pattern = ("-.*" )  ),
           group = str_trim( group ) ) %>% 
  filter( !str_detect( group  , "OIS") )


df <- df %>%
  mutate_if( is_character, as.factor ) %>% 
  #filter( date == "Mar-2018") %>% 
  filter(  !variables %in% "Longer Term")  #  group %in% "FOMC Dots Median" , 



df <- df %>%  
  filter( date %in% c("Sep-2018"  , "Dec-2018") ) %>% 
  mutate( values = values  )


caption <- "Source: Federal Reserve and CME Group"

select_symbols_names <- c("Fed Fund Futures" , "FOMC Median Projection")

p <- df %>% 
  ggplot(   aes(x = variables ,y = values ,  group = interaction(date, group) ,linetype = date , color = group ) ) + 
  # scale_x_discrete(labels=c("2018","2019")) +
  geom_line(  alpha=1, size=1.1  ) +
  scale_color_manual(values = select_colors_scale,labels = select_symbols_names   ) + #labels = select_symbols_names  
  guides(colour = guide_legend(reverse=T)) + #  c("#fa9fb5","#2b8cbe")
  scale_x_discrete(labels=c("2018","2019", "2020") ) + # , expand=c(0,0)
  scale_y_continuous( limits=c(1.5 ,3.5), breaks = seq(1.5,3.5, by =.5)) +
  labs(y="Federal Funds Rate(%)",x="Horizon",
       subtitle="June 2018",
       title="Federal Funds Rate:\nFederal Reserve Projections and Futures Market",
       caption=label_wrap_gen(100)(caption))+ #wrap the label
  theme_Publication() +
  theme(  plot.subtitle=element_text(face="italic",size=16*1.4,
                                     hjust=0, margin=margin(2,2,10,2)))+
  theme(plot.caption=element_text(hjust=0,vjust=1,margin=margin(t=10)),
        legend.title = element_blank() ) +
  
  theme(axis.title.y=element_text(hjust=.5),
        axis.title.x=element_text(hjust=.5)) +
  
  theme(  legend.position = c(0.5, .95) ,
          legend.spacing.x = unit(0.2, 'cm'),
          legend.direction = "horizontal" ,
          legend.key.width  = unit(2,"line"),
          legend.text = element_text(size=18)) +
  
  #  theme(axis.title.y=element_text(hjust=.5),
  #       axis.title.x=element_text(hjust=.5),
  #      legend.position = c(0.3, .9) ,
  #     legend.text = element_text(size=18),
  #    legend.key.height=unit(2,"line")) +
  NULL


pic_list$fed_vs_mkt_p <- p
p

ggsave('output_data/img/fed_vs_mkt_p.png', width = 16, height = 9) #, width = 16, height = 9, dpi =



```



## Housing

Existing home sales for December declined 2.83% from November's pace to a seasonally adjusted annual rate of 5.49 million in December, down from the 5.65 million units reached in November according to National Association of Realtors (NAR). Lack of inventory coupled with increased mortgage interest rates contributed to the downturn in existing home sales. Despite the fact that home sales slowed in December, for the full year, low mortgage rates helped home sales reach their highest level in a decade.  In the new home sales area, housing starts have trended higher and the National Association of Home Builders (NAHB) Market Index, a measure of homebuilders' view on the housing market condition reached the level of 69 by December, the highest level since the great financial crisis. Housing price reached a pre-crisis level thanks to low mortgage rates and tight housing supply during the year according to U.S. Federal Housing Finance Agency.

Because most homebuyers use a mortgage, movements in mortgage rates, in turn, US Treasury rates have a significant impact on housing demand. Following the Taper Tantrum, housing activity slowed down.  With the current higher interest rates, a pullback in the housing activity might be expected. On the positive note, tight housing supply and pent-up demand for housing can be a positive factor even with higher mortgage rates.



## Global Economy

The growth outlook of global economy is less promising than that of US.

While the diverging rate differentials between US and Europe benefited the monetary goal of ECB, helping European inflation rate to accelerate in the latter half of 2016, Europe still faces an existential issue from rising political risks with the recent rise of populist movements in the European nations. Upcoming elections in France and Germany in 2017 will be important indications of just how strong the political will is to uphold the EU project, an outcome critical to on-going ECB's QE program.  ECB's QE program helped EU to achieve a modest recovery, but trend growth is still below pre-crisis levels.  Business surveys have shown positive optimism as were the case in the US. It remains to be seen if the positive outlook translates into hard economic data.

While Chinese economy stabilized during 2016 thanks to the coordinated stimulus efforts to provide liquidity in money markets, government spending, and capital control, it still faces fundamental economic challenges such as highly indebted corporate sector suffering from overcapacity.
# http://www.telegraph.co.uk/business/2016/09/18/bis-flashes-red-alert-for-a-banking-crisis-in-china/

# Market Review

## Equities

The dominating theme of global markets in the final quarter of 2016 was reflation trade.  Donald Trump's presidential election win, coupled with the Republican Party sweeping both chambers, brought about the hope of a long-awaited fiscal stimulus program, a reflationary policy that will reinvigorate US economy and the financial markets.

The reflation hope helped global equity markets stage a strong rally during the final quarter of 2016.  The four most widely followed US stocks indices, the S&P 500, the Dow Jones Industrial Average, the Nasdaq Composite and the Russell 2000, hit all-time highs simultaneously. The last time all four indices hit the record high simultaneously was on New Year's Eve 1999.  After two-years of range-bound movements since the end of QE3 program, US stock markets appear to have gone through a regime change, as stocks sharply outperformed bonds.


```{r Value Growth Rotation, echo=FALSE,  warning=FALSE, cache=TRUE }

select_colors_scale <- rev( c(
  nord_palettes$aurora[1] ,
  nord_palettes$frost[4]
  
))

select_symbols_names <- c( "M1WD000V Index",
                           "M1WD000G Index")


select_names <- c( "World Value", # S&P 500 Utilities Sector Index GICS Level 1
                   "World Growth")

my_start_date <- "2009-01-01" %>% as.Date()
my_end_date <-  "2018-09-30" %>% as.Date()

df <- bloomberg_df %>%
  rename(variables = symbol) %>%
  filter(variables %in% select_symbols_names) %>%
  left_join(
    tibble(select_symbols_names ,select_names ) , by  = c("variables" = "select_symbols_names")
  ) %>%
  filter( between( dates ,my_start_date, my_end_date) ) %>%
  group_by(variables) %>%
  arrange(dates) %>%
  mutate(rets = (values - lag(values,1))/lag(values,1)) %>%
  ungroup() %>%
  na.omit() %>%
  select(dates,rets,select_names) %>%
  spread(select_names,rets) %>%
  mutate(delta = .[[select_names[1]]] - .[[select_names[2]]]) %>%
  gather(variables, values, -dates) %>%
  group_by(variables) %>%
  arrange(dates) %>%
  na.omit() %>%
  mutate(cum_rets = 100*cumprod(1+values)) %>%
  ungroup()


#*****************************************************************
# subset event dates
#******************************************************************

cbs_dates <-   c("2008-11-25",
                 "2010-11-02",
                 "2012-09-13" ,
                 "2016-11-08")

cbs_labels <- c(  "QE1 Begins",
                  "QE2 Begins",
                  "QE3 Begins",
                  "Trump Win-Reflation Hope")

cbs_df <- data.frame(date=as.Date(cbs_dates), event= cbs_labels)




# match cbs dates
cbs_df_sub <- match_cbs_df(cbs_df,df )

begin_date <- my_start_date
end_date <-  tail(df,1)$dates


#*****************************************************************
# Plot http://drawar.github.io/posts/add-borders-annotate-outside-ggplot/
#******************************************************************
# select_colors_scale <- c("#a06872","#000080")
# select_colors_scale <- rev(getPalette(2))

p <- df %>%
  filter(variables %in% "delta") %>%
  ggplot(aes(x=dates,y=cum_rets,color=variables))+
  geom_line(alpha=1, size=1) +
  scale_color_manual(values =select_colors_scale,labels =  rev(select_names))+
  geom_vline(  xintercept = as.numeric(filter(cbs_df_sub ,date >= my_start_date, date <= end_date)$dates),
               size = 1, color='grey',linetype="dashed")  +
  geom_text_repel(data = filter(cbs_df_sub ,date >= my_start_date, date <= end_date)[1,] ,aes(x=  as.Date(dates),
                                                                                              y= 105, label=event),
                  size = 5,
                  family = 'Arial',
                  fontface = 'bold', color ="#5E81AC",
                  # Add extra padding around each text label.
                  box.padding = unit(0.5, 'lines'),
                  # Add extra padding around each data point.
                  point.padding = unit(1.6, 'lines'),
                  # Color of the line segments.
                  segment.color = 'grey',
                  # Width of the line segments.
                  segment.size = 0.5,
                  # Draw an arrow from the label to the data point.
                  arrow = arrow(length = unit(0.01, 'npc')),
                  # Strength of the repulsion force.
                  force = 1,
                  # Maximum iterations of the naive repulsion algorithm O(n^2).
                  max.iter = 3e3,
                  nudge_x = -200,
                  nudge_y = 5
  ) +
  labs(x="",y="Cumulative Performance",title="Value VS. Growth", caption="Source: Zephyr Associates Inc and Morningstar.\nNote: The cumulative performances of The MSCI ACWI Value and Growth Net USD Indices using a base value of 100 at the start of 2016.")+
  theme_Publication() +
  theme(legend.position = "none",plot.caption=element_text(hjust=0,size= rel(1.2)))

pic_list$eq_vg1 <- p
p

# ggsave('output_data/img/eq_vg1.png', width = 16, height = 9, dpi = 100) #, width = 16, height = 9, dpi =

```



Much-anticipated great rotation has taken place where not only investors have poured money into equity from bond, values stocks finally began to outperform growth stocks. The movement was universal across the global markets. See Value vs. Growth chart.

Pro cyclical sectors are outperforming defensive stocks as well. Equities sensitive to interest rate movements that benefited from low-rate and low-growth environments dramatically underperformed relative to broad markets.  Industrial metals rose relative to precious metals as well. On the other hand, financial stocks and other pro cyclical stocks benefited from anticipated higher interest rates and economic growth during the fourth quarter. See Equity Sector Rotation chart.

While international stocks returned negatively in US Dollar terms during the quarter, they also staged a strong rally in local currency terms. The MSCI ACWI ex-USA Index, which measures performance of world markets outside the US, declined -1.3%, while its hedged index currency returned 1.51% during the quarter.

```{r Equity Sector Rotation, echo=FALSE, warning=FALSE, cache=TRUE }


select_colors_scale <- rev(c(
  nord_palettes$aurora[1] ,
  nord_palettes$frost[4]
  
))

select_symbols_names <- c( "S5UTIL Index", # S&P 500 Utilities Sector Index GICS Level 1
                           "S5FINL Index")

select_names <- c( "US Utilities", # S&P 500 Utilities Sector Index GICS Level 1
                   "US Financials")

my_start_date <- "2009-01-01" %>% as.Date()
my_end_date <-  "2018-09-30" %>% as.Date()

df <- bloomberg_df %>%
  rename(variables = symbol) %>%
  filter(variables %in% select_symbols_names) %>%
  left_join(
    tibble(select_symbols_names ,select_names ) , by  = c("variables" = "select_symbols_names")
  ) %>%
  filter( between( dates ,my_start_date, my_end_date) )  %>%
  group_by(variables) %>%
  arrange(dates) %>%
  mutate(rets = (values - lag(values,1))/lag(values,1)) %>%
  ungroup() %>%
  na.omit() %>%
  select(dates,rets,select_names) %>%
  spread(select_names,rets) %>%
  mutate(delta = .[[select_names[2]]] - .[[select_names[1]]] ) %>%
  gather(variables, values, -dates) %>%
  group_by(variables) %>%
  arrange(dates) %>%
  na.omit() %>%
  mutate(cum_rets = 100*cumprod(1+values)) %>%
  ungroup()


#*****************************************************************
# subset event dates
#******************************************************************

cbs_dates <-   c("2008-11-25",
                 "2010-11-02",
                 "2012-09-13" ,
                 "2016-11-08")

cbs_labels <- c(  "QE1 Begins",
                  "QE2 Begins",
                  "QE3 Begins",
                  "Trump Win-Reflation Hope")

cbs_df <- data.frame(date=as.Date(cbs_dates), event= cbs_labels)




# match cbs dates
cbs_df_sub <- match_cbs_df(cbs_df,df )

begin_date <- my_start_date
end_date <-  tail(df,1)$dates


#*****************************************************************
# Plot http://drawar.github.io/posts/add-borders-annotate-outside-ggplot/
#******************************************************************


# select_colors_scale <- rev(getPalette(2))

p <- df %>%
  filter(variables %in% "delta") %>%
  ggplot(aes(x=dates,y=cum_rets,color=variables))+
  geom_line(alpha=1, size=1) +
  geom_line(alpha=1, size=1) +
  scale_color_manual(values = select_colors_scale,labels =  rev(select_names))+
  geom_vline(  xintercept = as.numeric(filter(cbs_df_sub ,date >= my_start_date, date <= end_date)$dates),
               size = 1, color='grey',linetype="dashed")  +
  geom_text_repel(data = filter(cbs_df_sub ,date >= my_start_date, date <= end_date)[1,] ,aes(x=  as.Date(dates),
                                                                                              y= 120, label=event),
                  size = 5,
                  family = 'Arial',
                  fontface = 'bold', color ="#5E81AC",
                  # Add extra padding around each text label.
                  box.padding = unit(0.5, 'lines'),
                  # Add extra padding around each data point.
                  point.padding = unit(1.6, 'lines'),
                  # Color of the line segments.
                  segment.color = 'grey',
                  # Width of the line segments.
                  segment.size = 0.5,
                  # Draw an arrow from the label to the data point.
                  arrow = arrow(length = unit(0.01, 'npc')),
                  # Strength of the repulsion force.
                  force = 1,
                  # Maximum iterations of the naive repulsion algorithm O(n^2).
                  max.iter = 3e3,
                  nudge_x = -100,
                  nudge_y = 10
  ) +
  labs(x="",y="Cumulative Performance",title="Equity Sector Rotation", caption="Source: Zephyr Associates Inc and Morningstar.\nNote: The cumulative performances of US financials and utilities are represented by Utility and\nFinancial Select Sector Indices using a base value of 100 at the start of 2016.")+
  theme_Publication() +
  theme(legend.justification = c(0, 1),
        # legend.position = c(0, 1),
        legend.title = element_blank(),
        legend.position = "none") +
  theme(
    panel.grid.major = element_line(colour = "grey92"),
    panel.grid.minor = element_line(colour = "grey92",
                                    size = 0.25),
    axis.line = element_line(colour="black")
  )

pic_list$eq_p1 <- p
# ggsave('output_data/img/eq_p1.png', width = 16, height = 9, dpi = 100) #, width = 16, height = 9, dpi =

p




```



## US vs. International


```{r US-International Rotation, echo=FALSE, warning=FALSE, cache=TRUE }


select_colors_scale <- c(
  nord_palettes$aurora[1] ,
  nord_palettes$frost[4]
  
)

select_symbols_names <- c(  "RAY Index", # Russell 3000 Index
                            "MXWDU Index") #MSCI ACWI Excluding United States Index

select_names <- c( "US",
                   "International")

my_start_date <- "2001-01-01" %>% as.Date()
my_end_date <-  "2018-09-30" %>% as.Date()

df <- bloomberg_df %>%
  rename(variables = symbol) %>%
  filter(variables %in% select_symbols_names) %>%
  left_join(
    tibble(select_symbols_names ,select_names ) , by  = c("variables" = "select_symbols_names")
  ) %>%
  filter( between( dates ,my_start_date, my_end_date) )  %>%
  group_by(variables) %>%
  arrange(dates) %>%
  mutate(rets = (values - lag(values,1))/lag(values,1)) %>%
  ungroup() %>%
  na.omit() %>%
  select(dates,rets,select_names) %>%
  spread(select_names,rets) %>%
  mutate(delta = .[["US"]]  - .[["International"]] ) %>%
  gather(variables, values, -dates) %>%
  group_by(variables) %>%
  arrange(dates) %>%
  na.omit() %>%
  mutate(cum_rets = 100*cumprod(1+values)) %>%
  ungroup()


#*****************************************************************
# subset event dates
#******************************************************************

cbs_dates <-   c("2008-11-25",
                 "2010-11-02",
                 "2012-09-13" ,
                 "2016-11-08")

cbs_labels <- c(  "QE1 Begins",
                  "QE2 Begins",
                  "QE3 Begins",
                  "Trump Win-Reflation Hope")

cbs_df <- data.frame(date=as.Date(cbs_dates), event= cbs_labels)




# match cbs dates
cbs_df_sub <- match_cbs_df(cbs_df,df )

begin_date <- my_start_date
end_date <-  tail(df,1)$dates


#*****************************************************************
# Plot http://drawar.github.io/posts/add-borders-annotate-outside-ggplot/
#******************************************************************


# select_colors_scale <- (getPalette(2))

p <- df %>%
  filter(variables %in% "delta") %>%
  ggplot(aes(x=dates,y=cum_rets,color=variables))+
  geom_line(alpha=1, size=1) +
  scale_color_manual(values = select_colors_scale[2]) + # ,labels =  rev(select_names)
  geom_vline(  xintercept = as.numeric(filter(cbs_df_sub ,date >= my_start_date, date <= end_date)$dates),
               size = 1, color='grey',linetype="dashed")  +
  geom_text_repel(data = filter(cbs_df_sub ,date >= my_start_date, date <= end_date)[1,] ,aes(x=  as.Date(dates),
                                                                                              y= 108, label=event),
                  size = 5,
                  family = 'Arial',
                  fontface = 'bold', color ="#5E81AC",
                  # Add extra padding around each text label.
                  box.padding = unit(0.5, 'lines'),
                  # Add extra padding around each data point.
                  point.padding = unit(1.6, 'lines'),
                  # Color of the line segments.
                  segment.color = 'grey',
                  # Width of the line segments.
                  segment.size = 0.5,
                  # Draw an arrow from the label to the data point.
                  arrow = arrow(length = unit(0.01, 'npc')),
                  # Strength of the repulsion force.
                  force = 1,
                  # Maximum iterations of the naive repulsion algorithm O(n^2).
                  max.iter = 3e3,
                  nudge_x = -100,
                  nudge_y = 10
  ) +
  labs(x="",y="Cumulative Performance",title="US vs. International", caption="Source: Zephyr Associates Inc and Morningstar\nNote: The relative cumulative performances of \"US vs. International\" are represented by Russell 3000 and\nMSCI ACWI-ex US Indicies using a base value of 100 at the start of 2016.")+
  theme_Publication() +
  theme(legend.position = "none",plot.caption=element_text(hjust=0,size= rel(1.2))) +
  theme(
    panel.grid.major = element_line(colour = "grey92"),
    panel.grid.minor = element_line(colour = "grey92",
                                    size = 0.25),
    axis.line = element_line(colour="black")
  )



pic_list$eq_int_p <- p
ggsave('output_data/img/eq_int_p.png', width = 16, height = 9, dpi = 100) #, width = 16, height = 9, dpi =

p



```



## VIX


```{r VIX, echo=FALSE, warning=FALSE, cache=TRUE }


select_colors_scale <- c(
  nord_palettes$aurora[1] ,
  nord_palettes$frost[4]
  
)
select_symbols_names <- c( "VIX INDEX") #MSCI ACWI Excluding United States Index

select_names <- c( "CBOE VIX INDEX")

my_start_date <- "2008-01-01" %>% as.Date()
my_end_date <-  "2018-06-30" %>% as.Date()

df <- bloomberg_df %>%
  rename(variables = symbol) %>%
  filter(variables %in% select_symbols_names) %>%
  left_join(
    tibble(select_symbols_names ,select_names ) , by  = c("variables" = "select_symbols_names")
  ) %>%
  filter( between( dates ,my_start_date, my_end_date) ) 

# set x-axis limits
my_xlim <-  my_axis_fun( df , dates ) %>% as.Date()

my_xlim[2] <- my_xlim[2] + months(9)
my_xlim
#*****************************************************************
# subset event dates
#******************************************************************

cbs_dates <-   c("2008-11-25",
                 "2010-11-02",
                 "2012-09-13" ,
                 "2016-11-08")

cbs_labels <- c(  "QE1 Begins",
                  "QE2 Begins",
                  "QE3 Begins",
                  "Trump Win-Reflation Hope")

cbs_df <- data.frame(date=as.Date(cbs_dates), event= cbs_labels)




# match cbs dates
cbs_df_sub <- match_cbs_df(cbs_df,df )

begin_date <- my_start_date
end_date <-  tail(df,1)$dates


#*****************************************************************
# Plot http://drawar.github.io/posts/add-borders-annotate-outside-ggplot/
#******************************************************************


# select_colors_scale <- (getPalette(2))

text_df <- filter(df , values == min( values , na.rm = TRUE ) )

p <-
  ggplot()+
  geom_line(data = df , aes(x=dates,y= values,color=variables), alpha=1, size=1) +
  geom_rect(data=  filter(recession_df, start >= begin_date) ,
            aes(xmin= start, xmax= end, ymin=-Inf, ymax=+Inf),
            fill="gray", alpha=0.35) +
  scale_x_date( limits = my_xlim, date_breaks = "5 year" , date_labels = "%Y") +
  geom_hline( yintercept = text_df$values, linetype="dotted" ) +
  annotate(geom = "text", x =text_df$dates,
           y = text_df$values ,
           label = text_df$values, color = nord_palettes$red_mountain[1],
           size = 7,
           fontface = "bold", cex = 4.5,  hjust = -.4, vjust = -.5) +
  
  
  scale_color_manual(values = select_colors_scale[1]) + # ,labels =  rev(select_names)
  labs(x="",y="Level",subtitle="US implied equity market volatility fell to its lowest level since 1990s",
       title = "CBOE Volatility Index, VIX",
       caption="Source: Chicago Board Options Exchange and FRED, Federal Reserve Bank of St. Louis\nNote: Gray bars indicate recessions as determined by the National Bureau of\nEconomic Research.")+
  theme_Publication() +
  theme(legend.position = "none",plot.caption=element_text(hjust=0,size= rel(1.2))) +
  theme(
    panel.grid.major = element_line(colour = "grey92"),
    panel.grid.minor = element_line(colour = "grey92",
                                    size = 0.25),
    axis.line = element_line(colour="black")
  )





pic_list$vix_p <- p
ggsave('output_data/img/vix_p.png', width = 16, height = 9, dpi = 100) #, width = 16, height = 9, dpi =

p




```



## Yield Curve Snapshot

The U.S. Bureau of Economic Analysis (BEA) released the advance first estimate of GDP growth for the final quarter of 2016.  With the advance estimate, the annual growth rate for the full-year is estimated at 1.6 percent. It was the slowest growth in five years.  See the US Real GDP chart.

## Yield Curve Snapshot

```{r Yield Curve Snapshot Chart, fig.height=5,fig.width=9,echo=FALSE, warning=FALSE, cache=TRUE}



my_end_date <-  "2018-09-30" %>% as.Date()


qtr_dates <-   seq(3, 9, by = 3) %>% 
  map( ~{ my_end_date %m-% months(.) } ) %>% 
  flatten_dbl() %>% 
  as.Date() %>% 
  c(my_end_date) %>% 
  sort()

my_start_date <- qtr_dates[1]


Rate_Symbols <- c("DGS1MO","DTB3","DTB6", 'DGS1','DGS2','DGS3','DGS5','DGS7','DGS10','DGS20','DGS30')

Rate_Symbols_Names <-c("1-Month Tbill","3-Month Tbill",
                       "6-Month Tbill",
                       'US CMT 1-Year',
                       'US CMT 2-Year',
                       'US CMT 3-Year',
                       'US CMT 5-Year',
                       'US CMT 7-Year',
                       'US CMT 10-Year',
                       'US CMT 20-Year',
                       'US CMT 30-Year')

Term_Names <- c("1M","3M","6M","1 Year", "2 Year","3 Year",  "5 Year", "7 Year", "10 Year",   "20 Year",  "30 Year")

Maturity <- c(1/12,3/12, 6/12,1,2,3,5,7,10,20,30)


#  Key table to join human readable names to data frame
key_tbl <- cbind(symbol = Rate_Symbols ,
                 names = Rate_Symbols_Names,
                 term =Term_Names , 
                 maturity = Maturity  ) %>% 
  tbl_df()


# join with key table for readable names
df <- econ_df %>%
  semi_join(
    key_tbl , by = c("symbol" )
  ) %>%
  left_join(key_tbl, by = c("symbol" )) %>%
  mutate(maturity = as.numeric(maturity)) %>% 
  na.omit()

# rename column names to my preference
# rates_data <- rates_data %>% rename_(.dots = set_names(names(.),nm= c("variables","dates","values","names","term","maturity")))
# rates_data <- rates_data %>% select(-cmt,-apy)

# df %>% glimpse()

# https://www.quandl.com/raw_data/FED/SVENY-US-Treasury-Zero-Coupon-Yield-Curve

df <- df %>%
  mutate(cmt = values/100, apy = (1+cmt/2)^2-1,
         term = factor(term, levels = Term_Names ),datesf = factor(dates))


# https://gist.github.com/timelyportfolio/4da9d6b6c89cce26effabccca30124dd


# https://gist.github.com/timelyportfolio/4da9d6b6c89cce26effabccca30124dd


# select_colors_scale <- getPalette(10)[c(1,3,5,10)]


select_colors_scale <- c(
  
  nord_palettes$lumina[1] ,
  nord_palettes$lumina[2] ,
  nord_palettes$frost[3] ,
  nord_palettes$frost[4]
  
)


select_colors_scale <- c(
  nord_palettes$lumina[c(-1)]
)


df <- df %>%
  group_by(quarter=quarter(dates, T)) %>%
  filter(dates == max(dates)) %>%
  ungroup %>%
  select(-quarter)



# find available begin date in the dates vector
# begin_date <-rates_data$dates[which.min(abs(difftime(rates_data$dates,begin_date)))]

last_4_qtr_dates <- df  %>% 
  filter(dates <= my_end_date) %>% 
  distinct(dates) %>% 
  arrange(dates) %>%
  slice((n()-3):n())

df <- df %>%
  filter(dates %in% last_4_qtr_dates$dates ) %>%
  arrange(dates) %>%
  mutate( pos = values)

text_df <- df %>% 
  filter(term %in% "30 Year") %>%
  distinct(.keep_all = TRUE) %>% 
  mutate( label = ceiling_date(dates, "month") - days(1)) %>% 
  mutate( maturity =  maturity+1.9 )

text_df <- text_df %>% 
  mutate(  vjust = if_else( label == "2018-06-30", -1, .5) )#   hjust = .6 )

p <- df %>%
  ggplot(aes(x= maturity,y= cmt, color = datesf,group =datesf))+
  geom_line(alpha=1,size=1.2) +
  scale_x_continuous( expand = c(0.,0.), breaks=  Maturity[c(4,6:11)], labels= Term_Names[c(4,6:11)]) +
  #scale_x_discrete( expand = c(0.08333333,0.08333333))+
  scale_y_percent()+
  coord_cartesian(xlim = c(0., 35),ylim = c(0, .032)) +
  annotate("text",  x = text_df$maturity , y = text_df$cmt ,
           label = text_df$label, color =select_colors_scale ,
           size = 6,
           fontface = "bold" , vjust = text_df$vjust) + # , cex = 4.5,  hjust = text_df$hjust, vjust = text_df$vjust
  scale_color_manual(values = select_colors_scale) +
  labs(x="Time To Maturity",y="Yield to Maturity (%)",
       subtitle = "Treasury Yield Curve Quarter Over Quarter Comparison For The Third Quarter 2018",
       title="US Treasury Yield Curve",
       caption="Source: Daily Treasury Yield Curve Rates, US Department of the Treasury",
       color = "Yield Date") +
  theme_Publication() + 
  theme(axis.text  = element_text(size=12))+
  theme(legend.position = "none") +
  theme(
    panel.grid.major = element_line(colour = "grey92"),
    panel.grid.minor = element_line(colour = "grey92",
                                    size = 0.25),
    axis.line = element_line(colour="black")
  )



pic_list$yld_curv_p <- p

ggsave('output_data/img/yld_curv_p.png', width = 16, height = 9, dpi = 100) #, width

p


```




## Fixed Income


US Treasury yields climbed to their highest level of the year alone with record-high rally in stocks. The yield on the benchmark 10-year note rose to 2.6 per cent, its highest level of the year since the end of QE3. Market-based inflation expectations with the 10-year inflation breakeven rate, or the yield difference between 10-year Treasury Inflation Protected Securities and regular 10-year Treasury notes, climbed close to 2 per cent and points to the same conclusion. See US Fixed Income Market Reaction graph.


```{r Fixed Income Market Reaction, echo=FALSE, fig.width = 10, fig.height = 2, fig.fullwidth = TRUE, fig.cap = "A full width figure.", warning=FALSE, cache=TRUE}


select_colors_scale <- rev (c(
  nord_palettes$aurora[1] ,
  nord_palettes$frost[4]
  
))

select_symbols <- c(
  'T10YIE')

select_symbols_names <- c(
  '10-Year Breakeven Inflation Rate')

my_start_date <- "2013-01-01"  %>% as.Date()
my_end_date <- "2018-06-30" %>% as.Date()

df <- econ_df %>%
  filter(variables %in% select_symbols_names ) %>%
  filter( between( dates ,my_start_date, my_end_date), !is.na(values)  ) %>%
  mutate( values = values/100, pos =values) %>%
  mutate(variables = factor(variables,  levels = select_symbols_names ) )




# set x-axis limits
my_xlim <-  my_axis_fun( df , dates ) %>% as.Date()

my_xlim[2] <- my_xlim[2] + months(9)
my_xlim


#*****************************************************************
# Plot http://drawar.github.io/posts/add-borders-annotate-outside-ggplot/
#******************************************************************

# select_colors_scale <- rev(getPalette(2))


p <-  ggplot()+
  geom_line(data = df,
            aes(x=dates,y=values,color=variables),
            alpha=1, size=1.2) +
  scale_color_manual(values = select_colors_scale,labels =  (select_symbols_names))+
  scale_x_date(date_breaks = "1 year", date_labels = "%Y") +
  scale_y_continuous(label=scales::percent)+
  labs(x="",y="",title="US Inflation Market Expectation", # "Breakeven Rate (%)"
       subtitle = "10-Year Breakeven Inflation Rate" , caption="Source: Federal Reserve")+
  theme_Publication() +
  # theme(legend.position = c(0.35, .9),plot.caption=element_text(hjust=0,size= rel(1.2))) +
  theme(
    legend.position = "none"
    
  )

pic_list$tytb_p <- p
p
ggsave('output_data/img/tytb_p.png', width = 16, height = 9, dpi = 100) #, width = 16, height = 9, dpi =



```



The difference between short and longer dated Treasuries yield has risen to its highest level in 2017, as investors priced in higher US growth and inflation.  As shown in the US Treasury Yield Curve graph, US Treasury markets steeped dramatically after the announcement of each QE program as market participants bet on the success  of QE programs to rejuvenate markets and economy. The same reaction is displayed with the winning of Trump's presidential election. In essence, it appears that financial markets interpreted the Donald Trump's administration as a new reflationary policy program.


```{r  US Treasury Yield Curve Chart, warning=FALSE, cache=TRUE}

############################################################
# Extract Break Even Inflation , Rates Data
############################################################

# Monetary_Symbols_Names
# select interested variables
select_symbols_names <- c("2-Year CMT"  ,"10-Year CMT"  ) #

my_start_date <- "1990-01-01" %>% as.Date()
my_end_date <- "2018-06-30" %>% as.Date()

# select_colors_scale <- getPalette(2)

select_colors_scale <-   c(
  nord_palettes$aurora[1] ,
  nord_palettes$frost[4]
  
)




df <- econ_df %>%
  filter(variables %in% select_symbols_names ) %>%
  filter( between( dates ,my_start_date, my_end_date), !is.na(values)  ) %>%
  select(dates,values,variables) %>%
  spread(variables  , values) %>%
  mutate(`US Curve` = .[["10-Year CMT"]] - .[["2-Year CMT"]] ) %>% # caculate yield curve
  gather(variables, values, -dates) %>%
  mutate( values = values/100, pos =values) %>%
  group_by(variables) %>%
  mutate(pos = min(values,na.rm=TRUE)) %>%
  ungroup()

df <-  df %>%
  filter( variables %in% "US Curve" ) %>%
  filter(!is.na(values))

#*****************************************************************
# subset event dates
#******************************************************************

cbs_dates <-   c("2008-11-25",
                 "2010-11-02",
                 "2012-09-13" ,
                 "2016-11-08")

cbs_labels <- c(  "QE1 Begins",
                  "QE2 Begins",
                  "QE3 Begins",
                  "Trump Win-Reflation Hope")

cbs_df <- data.frame(date=as.Date(cbs_dates), event= cbs_labels)




# match cbs dates
cbs_df_sub <- match_cbs_df(cbs_df,df )
cbs_df_sub <- cbs_df_sub %>%  filter( variables %in% "US Curve" )
begin_date <- select_date
end_date <-  tail(df,1)$dates


#*****************************************************************
# Plot http://drawar.github.io/posts/add-borders-annotate-outside-ggplot/
#******************************************************************


p <-  ggplot()+
  geom_rect(data=  filter(recession_df, start >=  min(df$dates, na.rm =TRUE )) ,
            aes(xmin= start, xmax= end, ymin=-Inf, ymax=+Inf),
            fill="gray", alpha=0.35) +
  geom_line(data = df, aes(x=dates,y=values,color=variables),
            alpha=1,color =  select_colors_scale[2] ,size=1) +
  
  scale_x_date(date_breaks = "5 year", date_labels = "%Y") +
  
  scale_y_continuous(label=scales::percent)+
  xlab(" ")+ ylab("Yield Curve")+
  theme_minimal()+theme(plot.caption=element_text(hjust=0))+
  labs(x="",y="",title="Historical Movement of US Treasury Yield Curve",
       caption="Source : Federal Reserve\nNote: The lines show the difference between benchmark 10- and two-year government bond \nyields in percentage points. Gray bars indicate recessions as determined by the National       \nBureau of Economic Research.") +
  theme_Publication()

pic_list$yldcur_p1 <- p

p

ggsave('output_data/img/yldcur_p1.png') #, width = 16, height = 9, dpi =





```


```{r Equity Sector Performance Bar Chart,echo=FALSE,  warning=FALSE, cache=TRUE,eval=TRUE}



#*****************************************************************
#  process data parameters
#******************************************************************

my_start_date <- "2017-12-31" %>% as.Date()
my_end_date <- "2018-06-30" %>% as.Date()

# extract data
df <- etf_df %>%
  group_by( symbol ) %>% 
  as_tbl_time(index = date) %>% 
  as_period( period = "1 q" , side = "end") %>%   
  tq_transmute( select  = adjusted, mutate_fun = ROC, type =  "discrete" ,col_rename = "returns") %>%
  filter( between( date, my_start_date, my_end_date ) ) %>%
  ungroup()  

#### Prepare sector information ##################################################


df <- df %>% 
  
  left_join(
    
    etf_df %>% select( symbol, category, names),
    
    by = "symbol"
  ) %>% 
  filter( category %in% "Equity Sector") %>% 
  distinct(symbol, date, .keep_all =  TRUE) 



#### Prepare Color information ##################################################


select_colors_scale <-  select_colors_scale <- c(
  
  nord_palettes$aurora[1] ,
  
  nord_palettes$aurora[4] 
  
)




# set y-axis limits
my_ylim <- my_axis_fun( df , returns )
my_ylim[1] <- my_ylim[1] - 0.01
my_ylim[2] <- my_ylim[2] + 0.01

my_ylim






#### Prepare titles ################################################################

my_title <- str_c("Equity Sector Performance Since 2016-Q4")
my_subtitle <- "2017-Q4 Performance"
my_caption <- "Source: Zephyr Associates Inc and Morningstar"


#### Make Plot ###################################################################################

eq_sec_p <-my_bar_plot_fnc( df ,  "names"  , "returns", select_colors_scale , 
                            my_title  = my_title, my_caption = my_caption )
#######################################################################################################

# create diverging barcharts

eq_sec_p

ggsave('output_data/img/eq_sec_p.png', width = 16, height = 9) #, width = 16, height = 9, dpi =



```


```{r Equity Sector Historical Line Chart,echo=FALSE,  warning=FALSE, cache=TRUE,eval=TRUE}



#######################################################################################################

#######################################################################################################


my_benchmark_symbol <- "SPY"
my_benchmark_name <- etf_df %>% 
  filter( symbol %in% my_benchmark_symbol ) %>% distinct( names ) %>% pull
my_category <- "Equity Sector"

# extract data 
df <- etf_df %>% 
  filter( category %in% my_category | symbol %in% my_benchmark_symbol   ) %>% 
  distinct(symbol, date, .keep_all =  TRUE) %>% 
  group_by(symbol) %>%
  tq_transmute(select = adjusted,  mutate_fun = periodReturn, period = "daily") %>% 
  rename_(.dots=setNames(names(.), c('symbol','dates','values'))) %>% 
  ungroup() %>% 
  #  Key table to join human readable names to data frame
  left_join(
    etf_df %>% 
      filter( category %in% my_category | symbol %in% my_benchmark_symbol ) %>% 
      distinct( symbol,names, category) ,
    by = c( "symbol")
  ) %>% 
  mutate(symbol = as.factor(symbol)) 

#######################################################################################################

#*****************************************************************
#  process data parameters
#******************************************************************

my_start_date <- "2018-01-01" %>% as.Date()
my_end_date <- "2018-06-30" %>% as.Date()

#### Prepare titles ################################################################


my_title <- str_glue("US {my_category} Performance Relative to {my_benchmark_name} Since: {min(df$dates,na.rm=TRUE)}" )
my_caption <- str_glue("Solid line is sector performance, dotted line is {my_benchmark_name} performance\nRed (blue) indicates the cumulative sector performance is higher (lower) than the benchmark")
my_subtitle <- ""

#### Make Plot ###################################################################################
#  process data 
# filter out equity sector 

us_eq_sec_ts_1 <-  myf(df,my_benchmark_symbol,  my_start_date, my_end_date) %>% 
  my_ribbon_plotf( benchmark_name = my_benchmark_name)


us_eq_sec_ts_1







```



In terms of sector performance, as interest rates spiked during the quarter, most of the fixed sectors generated negative returns.  With the hope of economic expansion, however, credit spread has tightened and sectors with credit components were able to return positive performance.
As shown in the Fixed Income Sector Performance chart, high yield securities performed relatively well, followed by ABS securities. The government securities performed worst with -3.72% for the quarter.


```{r Fixed Income Sector Performance Chart,echo=FALSE,  warning=FALSE, cache=TRUE,eval=FALSE}



#*****************************************************************
#  process data parameters
#******************************************************************

my_start_date <- "2017-12-31" %>% as.Date()
my_end_date <- "2018-03-31" %>% as.Date()

# extract data
df <- etf_df %>%
  group_by( symbol ) %>% 
  as_tbl_time(index = date) %>% 
  as_period( period = "1 q" , side = "end") %>%   
  tq_transmute( select  = adjusted, mutate_fun = ROC, type =  "discrete" ,col_rename = "returns") %>%
  filter( between( date, my_start_date, my_end_date ) ) %>%
  ungroup()  

#### Prepare sector information ##################################################


df <- df %>% 
  
  left_join(
    
    etf_df %>% select( symbol, category, names),
    
    by = "symbol"
  ) %>% 
  filter( category %in% "Fixed Sector") %>% 
  distinct(symbol, date, .keep_all =  TRUE) 



#### Prepare Color information ##################################################


select_colors_scale <-  select_colors_scale <- c(
  
  nord_palettes$aurora[1] ,
  
  nord_palettes$aurora[4] 
  
)




# set y-axis limits
my_ylim <- my_axis_fun( df , returns )
my_ylim[1] <- my_ylim[1] - 0.01
my_ylim[2] <- my_ylim[2] + 0.01

my_ylim






#### Prepare titles ################################################################

my_title <- str_c("Fixed Income Sector Performance Since 2016-Q4")
my_subtitle <- "2018-Q1 Performance"
my_caption <- "Source: Zephyr Associates Inc and Morningstar"


#### Make Plot ###################################################################################

fix_sec_p <- my_bar_plot_fnc( df , names, returns, select_colors_scale , 
                              my_title  = my_title, my_caption = my_caption )
#######################################################################################################

# create diverging barcharts


fix_sec_p

ggsave('output_data/img/fix_sec_p.png', width = 16, height = 9) #, width = 16, height = 9, dpi =




```


```{r Fixed Income Sector Historical Line Chart,echo=FALSE,  warning=FALSE, cache=TRUE,eval=TRUE}



#######################################################################################################



my_benchmark_symbol <- "AGG"
my_category <- "Fixed Sector"

my_benchmark_name <- etf_df %>% 
  filter( symbol %in% my_benchmark_symbol ) %>% distinct( names ) %>% pull

# extract data 
df <- etf_df %>% 
  filter( category %in% my_category | symbol %in% my_benchmark_symbol   ) %>% 
  distinct(symbol, date, .keep_all =  TRUE) %>% 
  group_by(symbol) %>%
  tq_transmute(select = adjusted,  mutate_fun = periodReturn, period = "daily") %>% 
  rename_(.dots=setNames(names(.), c('symbol','dates','values'))) %>% 
  ungroup() %>% 
  #  Key table to join human readable names to data frame
  left_join(
    etf_df %>% 
      filter( category %in% my_category | symbol %in% my_benchmark_symbol ) %>% 
      distinct( symbol,names, category) ,
    by = c( "symbol")
  ) %>% 
  mutate(symbol = as.factor(symbol)) 

#######################################################################################################

#*****************************************************************
#  process data parameters
#******************************************************************

my_start_date <- "2018-01-01" %>% as.Date()
my_end_date <- "2018-03-31" %>% as.Date()

#### Prepare titles ################################################################


my_title <- str_glue("US {my_category} Performance Relative to {my_benchmark_name} Since: {min(df$dates,na.rm=TRUE)}" )
my_caption <- str_glue("Solid line is sector performance, dotted line is {my_benchmark_name} performance\nRed (blue) indicates the cumulative sector performance is higher (lower) than the benchmark")
my_subtitle <- ""

#### Make Plot ###################################################################################
#  process data 
# filter out equity sector 
us_fixed_sector_ts_p <- myf(df,my_benchmark_symbol,  my_start_date, my_end_date) %>% 
  my_ribbon_plotf()

us_fixed_sector_ts_p




```



```{r, Equity Regional Historical Line Chart,echo=FALSE,  warning=FALSE, cache=TRUE,eval=TRUE}


#### Prepare sector information ##################################################



my_benchmark_symbol <- "SPY"
my_category <- "Equity Region"

my_benchmark_name <- etf_df %>% 
  filter( symbol %in% my_benchmark_symbol ) %>% distinct( names ) %>% pull

# extract data 
df <- etf_df %>% 
  filter( category %in% my_category | symbol %in% my_benchmark_symbol   ) %>% 
  distinct(symbol, date, .keep_all =  TRUE) %>% 
  group_by(symbol) %>%
  tq_transmute(select = adjusted,  mutate_fun = periodReturn, period = "daily") %>% 
  rename_(.dots=setNames(names(.), c('symbol','dates','values'))) %>% 
  ungroup() %>% 
  #  Key table to join human readable names to data frame
  left_join(
    etf_df %>% 
      filter( category %in% my_category | symbol %in% my_benchmark_symbol ) %>% 
      distinct( symbol,names, category) ,
    by = c( "symbol")
  ) %>% 
  mutate(symbol = as.factor(symbol)) 

#######################################################################################################

#*****************************************************************
#  process data parameters
#******************************************************************

my_start_date <- "2018-01-01" %>% as.Date()
my_end_date <- "2018-06-30" %>% as.Date()

#### Prepare titles ################################################################


my_title <- str_glue("US {my_category} Performance Relative to {my_benchmark_name} Since: {min(df$dates,na.rm=TRUE)}" )
my_caption <- str_glue("Solid line is sector performance, dotted line is {my_benchmark_name} performance\nRed (blue) indicates the cumulative sector performance is higher (lower) than the benchmark")
my_subtitle <- ""

#### Make Plot ###################################################################################
#  process data 
# filter out equity sector 
multi_asset_p <-  myf(df,my_benchmark_symbol,  my_start_date, my_end_date) %>% 
  my_ribbon_plotf( benchmark_name = my_benchmark_name)



multi_asset_p


ggsave('output_data/img/multi_asset_p.png', width = 16, height = 9) #, width = 16, height = 9, dpi =




```



```{r,Multi Asset Historical Line Chart,echo=FALSE,  warning=FALSE, cache=TRUE,eval=TRUE}


#### Prepare sector information ##################################################



my_benchmark_symbol <- "SPY"
my_category <- "Multi Asset"

my_benchmark_name <- etf_df %>% 
  filter( symbol %in% my_benchmark_symbol ) %>% distinct( names ) %>% pull

# extract data 
df <- etf_df %>% 
  filter( category %in% my_category | symbol %in% my_benchmark_symbol   ) %>% 
  distinct(symbol, date, .keep_all =  TRUE) %>% 
  group_by(symbol) %>%
  tq_transmute(select = adjusted,  mutate_fun = periodReturn, period = "daily") %>% 
  rename_(.dots=setNames(names(.), c('symbol','dates','values'))) %>% 
  ungroup() %>% 
  #  Key table to join human readable names to data frame
  left_join(
    etf_df %>% 
      filter( category %in% my_category | symbol %in% my_benchmark_symbol ) %>% 
      distinct( symbol,names, category) ,
    by = c( "symbol")
  ) %>% 
  mutate(symbol = as.factor(symbol)) 

#######################################################################################################

#*****************************************************************
#  process data parameters
#******************************************************************

my_start_date <- "2018-01-01" %>% as.Date()
my_end_date <- "2018-06-30" %>% as.Date()

#### Prepare titles ################################################################


my_title <- str_glue("US {my_category} Performance Relative to {my_benchmark_name} Since: {min(df$dates,na.rm=TRUE)}" )
my_caption <- str_glue("Solid line is sector performance, dotted line is {my_benchmark_name} performance\nRed (blue) indicates the cumulative sector performance is higher (lower) than the benchmark")
my_subtitle <- ""

#### Make Plot ###################################################################################
#  process data 
# filter out equity sector 
multi_asset_p <- myf(df,my_benchmark_symbol,  my_start_date, my_end_date) %>% 
  my_ribbon_plotf( benchmark_name = my_benchmark_name)

multi_asset_p


ggsave('output_data/img/multi_asset_p.png', width = 16, height = 9) #, width = 16, height = 9, dpi =




```




# Outlook

Economic growth and inflation among developing economies started to rebound in the second half of 2016, from the low points reached in March 2016, when fears of global recession were mounting, partially thanks to coordinated efforts of global central banks.

Along with the positive economic data, regime shift in financial markets started to merge; equities begun to outperform bonds; cyclical outperformed defensive sectors in the equity markets; industrial metals rose relative to precious metals. In all cases, these rotations started in July, and their performance accelerated in November and December driven by Donald Trump's election victory.

Presumably, this regime shift in the financial markets and high hope hinged on the anticipated  economic growth from fiscal stimulus programs by the new administration. Whether, when, and how the new fiscal policies  are implemented  and the signs of pickup in hard economic data in 2017 will determine the longevity of this structural shift.


```{r bib, include=FALSE}
# create a bib file for the R packages used in this document
knitr::write_bib(c('base', 'rmarkdown'), file = 'skeleton.bib')
```




